<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proko24 TEI Generator 2.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c5aa0 0%, #8b5a3c 50%, #d4845a 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1a365d 0%, #2c5aa0 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 15px;
            font-weight: 300;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .version-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .header-icon {
            font-size: 2rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .toolbar {
            background: #f8fafc;
            padding: 15px 30px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .mode-toggle {
            display: flex;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e2e8f0;
        }

        .mode-btn {
            padding: 8px 16px;
            border: none;
            background: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: #2c5aa0;
            color: white;
        }

        .import-btn {
            background: #d4845a;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .import-btn:hover {
            background: #b86f47;
        }

        .auto-generate-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .auto-generate-btn:hover {
            background: #059669;
        }

        .import-transcription-btn {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .import-transcription-btn:hover {
            background: #7c3aed;
        }

        .prima-xml-btn {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s ease;
        }

        .prima-xml-btn:hover {
            background: #d97706;
        }

        .form-container {
            padding: 40px;
        }

        .progress-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: #e2e8f0;
            z-index: 1;
        }

        .progress-step {
            background: white;
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 3;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .progress-step:hover {
            border-color: #2c5aa0;
            transform: scale(1.1);
        }

        .progress-step.active {
            border-color: #2c5aa0;
            background: #2c5aa0;
            color: white;
        }

        .progress-step.completed {
            border-color: #d4845a;
            background: #d4845a;
            color: white;
        }

        .step-label {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 0.8rem;
            color: #64748b;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .step-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .step-content.active {
            display: block;
        }

        .step-content.compact {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        .form-row.triple {
            grid-template-columns: 1fr 1fr 1fr;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
            position: relative;
        }

        .required {
            color: #ef4444;
        }

        .auto-filled {
            color: #10b981;
            font-size: 0.75rem;
            margin-left: 5px;
        }

        input, select, textarea, .custom-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            position: relative;
        }

        input:focus, select:focus, textarea:focus, .custom-select:focus {
            outline: none;
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        .auto-filled-field {
            border-color: #10b981 !important;
            background: #f0fdf4;
        }

        .ai-filled-field {
            border-color: #8b5cf6 !important;
            background: #faf5ff;
        }

        .prima-filled-field {
            border-color: #f59e0b !important;
            background: #fef3c7;
        }

        .custom-select {
            position: relative;
            cursor: pointer;
            background: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .custom-select::after {
            content: '‚ñº';
            font-size: 0.8rem;
            color: #64748b;
        }

        .dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.2s ease;
        }

        .dropdown-item:hover {
            background: #f8fafc;
        }

        .dropdown-item.selected {
            background: #2c5aa0;
            color: white;
        }

        .spa-generator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .spa-generator input {
            flex: 1;
        }

        .spa-auto-btn {
            background: #8b7355;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 6px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.9rem;
        }

        .spa-auto-btn:hover {
            background: #6b5a43;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .letter-selector {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .letter-selector:hover {
            border-color: #2c5aa0;
            background: #f0f9ff;
        }

        .letter-selector.selected {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .letter-info {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            font-size: 0.9rem;
        }

        .letter-detail {
            display: flex;
            flex-direction: column;
        }

        .letter-label {
            font-weight: 600;
            color: #64748b;
            font-size: 0.8rem;
            margin-bottom: 2px;
        }

        .letter-value {
            color: #2d3748;
        }

        .import-section {
            background: #f8fafc;
            border: 2px dashed #d4845a;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
        }

        .import-section.drag-over {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .transcription-preview {
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            margin: 15px 0;
        }

        .ai-analysis-panel {
            background: #faf5ff;
            border: 2px solid #8b5cf6;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .ai-suggestion {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .ai-suggestion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .ai-suggestion-title {
            font-weight: 600;
            color: #8b5cf6;
        }

        .ai-confidence {
            background: #8b5cf6;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .person-entry, .place-entry {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8fafc;
        }

        .remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            float: right;
            transition: background 0.3s ease;
        }

        .remove-btn:hover {
            background: #dc2626;
        }

        .add-btn {
            background: #d4845a;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 20px;
            transition: background 0.3s ease;
        }

        .add-btn:hover {
            background: #b86f47;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
        }

        .nav-btn {
            background: #2c5aa0;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #1a365d;
            transform: translateY(-2px);
        }

        .nav-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .nav-btn.secondary {
            background: #8b7355;
        }

        .nav-btn.secondary:hover {
            background: #6b5a43;
        }

        .generate-btn {
            background: linear-gradient(135deg, #2c5aa0 0%, #d4845a 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 30px;
            transition: transform 0.3s ease;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(44, 90, 160, 0.3);
        }

        .output {
            margin-top: 30px;
            padding: 20px;
            background: #1a202c;
            border-radius: 12px;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            display: none;
        }

        .copy-btn {
            background: #8b7355;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 15px;
            transition: background 0.3s ease;
        }

        .copy-btn:hover {
            background: #6b5a43;
        }

        .help-text {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 5px;
        }

        .date-format {
            font-size: 0.8rem;
            color: #64748b;
            font-style: italic;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #2c5aa0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .compact-mode .progress-bar {
            display: none;
        }

        .compact-mode .step-content {
            display: block;
        }

        .compact-mode .navigation {
            display: none;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .status-none { background: #cbd5e0; }
        .status-catalogue { background: #d4845a; }
        .status-transcription { background: #8b5cf6; }
        .status-prima { background: #f59e0b; }
        .status-complete { background: #10b981; }

        /* Nouvelles classes pour Prima XML */
        .prima-panel {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .prima-structure {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .prima-node {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .prima-node:hover {
            background: #f1f5f9;
        }

        .prima-node.region {
            background: #ecfdf5;
            border-left: 4px solid #10b981;
        }

        .prima-node.line {
            background: #f0f9ff;
            border-left: 4px solid #0ea5e9;
            margin-left: 20px;
        }

        .prima-node.word {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            margin-left: 40px;
        }

        .prima-node.tag {
            background: #fce7f3;
            border-left: 4px solid #ec4899;
            margin-left: 60px;
        }

        .prima-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .prima-stat {
            text-align: center;
        }

        .prima-stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #f59e0b;
        }

        .prima-stat-label {
            font-size: 0.8rem;
            color: #64748b;
        }

        .prima-mapping {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
        }

        .prima-mapping input {
            flex: 1;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .prima-arrow {
            font-size: 1.2rem;
            color: #f59e0b;
            font-weight: bold;
        }

        .prima-entities {
            background: #f0fdf4;
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .prima-entity {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .prima-entity-text {
            font-weight: 600;
            color: #047857;
        }

        .prima-entity-type {
            background: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        /* Styles VIAF */
        .viaf-search-container {
            position: relative;
        }

        .viaf-search-btn {
            background: #7c3aed;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 8px;
            transition: background 0.3s ease;
        }

        .viaf-search-btn:hover {
            background: #6d28d9;
        }

        .viaf-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .viaf-result-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.2s ease;
        }

        .viaf-result-item:hover {
            background: #f8fafc;
        }

        .viaf-result-item.selected {
            background: #7c3aed;
            color: white;
        }

        .viaf-result-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .viaf-result-details {
            font-size: 0.8rem;
            color: #64748b;
        }

        .viaf-result-item.selected .viaf-result-details {
            color: #e2e8f0;
        }

        .viaf-result-id {
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 4px;
            display: inline-block;
        }

        .viaf-result-item.selected .viaf-result-id {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .viaf-loading {
            text-align: center;
            padding: 20px;
            color: #64748b;
        }

        .viaf-no-results {
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-style: italic;
        }

        .viaf-error {
            text-align: center;
            padding: 20px;
            color: #ef4444;
            background: #fef2f2;
        }

        .viaf-filled-field {
            border-color: #7c3aed !important;
            background: #f3e8ff;
        }

        .viaf-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #7c3aed;
            border-radius: 50%;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Styles pour les ≈ìuvres */
        .work-entry {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8fafc;
        }

        .work-type-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .work-type-btn {
            background: #f1f5f9;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .work-type-btn:hover {
            background: #e2e8f0;
        }

        .work-type-btn.selected {
            background: #d4845a;
            color: white;
            border-color: #d4845a;
        }

        /* Styles pour la recherche GPS */
        .gps-search-container {
            position: relative;
        }

        .gps-search-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 8px;
            transition: background 0.3s ease;
        }

        .gps-search-btn:hover {
            background: #059669;
        }

        .gps-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .gps-result-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.2s ease;
        }

        .gps-result-item:hover {
            background: #f8fafc;
        }

        .gps-result-item.selected {
            background: #10b981;
            color: white;
        }

        .gps-result-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .gps-result-details {
            font-size: 0.8rem;
            color: #64748b;
        }

        .gps-result-item.selected .gps-result-details {
            color: #e2e8f0;
        }

        .gps-result-coords {
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 4px;
            display: inline-block;
        }

        .gps-result-item.selected .gps-result-coords {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .gps-filled-field {
            border-color: #10b981 !important;
            background: #f0fdf4;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 20px;
        }

        .tab {
            background: none;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #64748b;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #f59e0b;
            border-bottom-color: #f59e0b;
        }

        .tab:hover {
            background: #f1f5f9;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="version-badge">v2.1</div>
            <h1>
                <span class="header-icon">üìÑ</span>
                Proko24 TEI Generator
            </h1>
            <p>G√©n√©rateur intelligent avec import catalogue, analyse IA et int√©gration Prima XML</p>
        </div>

        <div class="toolbar">
            <div class="mode-toggle">
                <button class="mode-btn active" onclick="setMode('full')">Mode par √©tape</button>
                <button class="mode-btn" onclick="setMode('compact')">Mode vertical</button>
            </div>
            
            <button class="import-btn" onclick="showCatalogueModal()">
                üìä Catalogue v2.0 <span class="status-indicator status-none" id="catalogueStatus"></span>
            </button>
            
            <button class="import-transcription-btn" onclick="showTranscriptionImport()">
                üìú Transkribus <span class="status-indicator status-none" id="transcriptionStatus"></span>
            </button>

            <button class="prima-xml-btn" onclick="showPrimaXMLImport()">
                üè∑Ô∏è Prima XML <span class="status-indicator status-none" id="primaStatus"></span>
            </button>
            
            <button class="auto-generate-btn" onclick="runAIAnalysis()" id="aiBtn" disabled>
                ü§ñ Analyse IA <span class="status-indicator status-none" id="aiStatus"></span>
            </button>

            <input type="file" id="catalogueFile" accept=".xlsx,.csv" style="display: none;" onchange="loadCatalogue(event)">
            <input type="file" id="transcriptionFile" accept=".xml,.txt" style="display: none;" onchange="loadTranscription(event)">
            <input type="file" id="primaFile" accept=".xml" style="display: none;" onchange="loadPrimaXML(event)">
        </div>

        <!-- Modal de s√©lection de lettre -->
        <div id="catalogueModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üìä S√©lection de lettre du Catalogue v2.0</h2>
                    <span class="close" onclick="closeCatalogueModal()">&times;</span>
                </div>
                
                <div class="import-section" onclick="document.getElementById('catalogueFile').click()">
                    <h3>üìÅ Charger le Catalogue v2.0</h3>
                    <p>S√©lectionnez le fichier "Catalogue v2.0.xlsx"</p>
                </div>
                
                <div id="catalogueLetters" style="display: none;">
                    <h3>üìã S√©lectionner une lettre (574 disponibles) :</h3>
                    <div class="form-group">
                        <label for="letterSelect">Titre de la lettre</label>
                        <select id="letterSelect" onchange="previewSelectedLetter()">
                            <option value="">-- Choisir une lettre --</option>
                        </select>
                        <div class="help-text">Tri√©es par SPA_ID croissant</div>
                    </div>
                    
                    <div id="letterPreview" style="display: none; background: #f8fafc; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h4>üìã Aper√ßu de la lettre :</h4>
                        <div id="previewContent"></div>
                    </div>
                    
                    <button class="nav-btn" onclick="importSelectedLetter()" id="importBtn" disabled>Importer cette lettre</button>
                </div>
            </div>
        </div>

        <!-- Modal d'import Transkribus -->
        <div id="transcriptionModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üìú Import transcription Transkribus</h2>
                    <span class="close" onclick="closeTranscriptionModal()">&times;</span>
                </div>
                
                <div class="import-section" onclick="document.getElementById('transcriptionFile').click()">
                    <h3>üìÅ Charger la transcription</h3>
                    <p>Fichier XML ou TXT depuis Transkribus</p>
                </div>
                
                <div id="transcriptionPreview" style="display: none;">
                    <h3>Aper√ßu de la transcription :</h3>
                    <div class="transcription-preview" id="transcriptionContent"></div>
                    <button class="nav-btn" onclick="processTranscription()">Traiter avec l'IA</button>
                </div>
            </div>
        </div>

        <!-- Modal Prima XML -->
        <div id="primaModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üè∑Ô∏è Import Prima XML avec annotations</h2>
                    <span class="close" onclick="closePrimaModal()">&times;</span>
                </div>
                
                <div class="import-section" onclick="document.getElementById('primaFile').click()">
                    <h3>üìÅ Charger le Prima XML</h3>
                    <p>Fichier XML export√© depuis Transkribus avec annotations</p>
                </div>

                <div id="primaContent" style="display: none;">
                    <div class="tabs">
                        <button class="tab active" onclick="switchPrimaTab('structure')">Structure</button>
                        <button class="tab" onclick="switchPrimaTab('entities')">Entit√©s</button>
                        <button class="tab" onclick="switchPrimaTab('mapping')">Mapping</button>
                    </div>

                    <div id="primaStructureTab" class="tab-content active">
                        <div id="primaStats" class="prima-stats">
                            <div class="prima-stat">
                                <div class="prima-stat-number" id="primaRegions">0</div>
                                <div class="prima-stat-label">R√©gions</div>
                            </div>
                            <div class="prima-stat">
                                <div class="prima-stat-number" id="primaLines">0</div>
                                <div class="prima-stat-label">Lignes</div>
                            </div>
                            <div class="prima-stat">
                                <div class="prima-stat-number" id="primaWords">0</div>
                                <div class="prima-stat-label">Mots</div>
                            </div>
                            <div class="prima-stat">
                                <div class="prima-stat-number" id="primaTags">0</div>
                                <div class="prima-stat-label">Tags</div>
                            </div>
                        </div>
                        <div id="primaStructure" class="prima-structure"></div>
                    </div>

                    <div id="primaEntitiesTab" class="tab-content">
                        <div id="primaEntitiesContainer" class="prima-entities"></div>
                    </div>

                    <div id="primaMappingTab" class="tab-content">
                        <h3>üîÑ Mapping Tags ‚Üí TEI</h3>
                        <div id="primaMappingRules">
                            <div class="prima-mapping">
                                <input type="text" placeholder="person" value="person">
                                <span class="prima-arrow">‚Üí</span>
                                <input type="text" placeholder="persName" value="persName">
                                <button class="add-btn" onclick="addPrimaMapping()">+</button>
                            </div>
                            <div class="prima-mapping">
                                <input type="text" placeholder="place" value="place">
                                <span class="prima-arrow">‚Üí</span>
                                <input type="text" placeholder="placeName" value="placeName">
                                <button class="add-btn" onclick="addPrimaMapping()">+</button>
                            </div>
                        </div>
                    </div>

                    <button class="nav-btn" onclick="processPrimaXML()" id="processPrimaBtn">Traiter Prima XML</button>
                </div>
            </div>
        </div>

        <div class="form-container">
            <div class="progress-bar" id="progressBar">
                <div class="progress-step active" data-step="1" onclick="showStep(1)">
                    <span>1</span>
                    <div class="step-label">titleStmt</div>
                </div>
                <div class="progress-step" data-step="2" onclick="showStep(2)">
                    <span>2</span>
                    <div class="step-label">msDesc</div>
                </div>
                <div class="progress-step" data-step="3" onclick="showStep(3)">
                    <span>3</span>
                    <div class="step-label">correspDesc</div>
                </div>
                <div class="progress-step" data-step="4" onclick="showStep(4)">
                    <span>4</span>
                    <div class="step-label">particDesc</div>
                </div>
                <div class="progress-step" data-step="5" onclick="showStep(5)">
                    <span>5</span>
                    <div class="step-label">settingDesc</div>
                </div>
                <div class="progress-step" data-step="6" onclick="showStep(6)">
                    <span>6</span>
                    <div class="step-label">≈íuvres</div>
                </div>
                <div class="progress-step" data-step="7" onclick="showStep(7)">
                    <span>7</span>
                    <div class="step-label">G√©n√©ration</div>
                </div>
            </div>

            <form id="teiForm">
                <!-- √âtape 1: titleStmt -->
                <div class="step-content active" data-step="1">
                    <h2>üìã titleStmt - Title Statement</h2>
                    <p class="help-text">Informations sur le titre, l'√©dition et la responsabilit√© √©ditoriale selon la TEI</p>
                    
                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label for="letterTitleFr">Titre de la lettre (FR) <span class="required">*</span></label>
                                <input type="text" id="letterTitleFr" placeholder="Paul Demasy √† Sergei Prokofiev, Paris, France, 14 janvier 1924" required>
                            </div>
                            <div>
                                <label for="letterTitleEn">Titre de la lettre (EN) <span class="required">*</span></label>
                                <input type="text" id="letterTitleEn" placeholder="Paul Demasy to Sergei Prokofiev, Paris, France, 14 January 1924" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label for="titleLangFr">Langue du titre FR</label>
                                <select id="titleLangFr">
                                    <option value="fr" selected>Fran√ßais</option>
                                    <option value="en">Anglais</option>
                                    <option value="de">Allemand</option>
                                    <option value="ru">Russe</option>
                                </select>
                            </div>
                            <div>
                                <label for="titleLangEn">Langue du titre EN</label>
                                <select id="titleLangEn">
                                    <option value="en" selected>Anglais</option>
                                    <option value="fr">Fran√ßais</option>
                                    <option value="de">Allemand</option>
                                    <option value="ru">Russe</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label for="transcriber">Transcripteur</label>
                                <input type="text" id="transcriber" value="Moron, Nicolas">
                            </div>
                            <div>
                                <label for="transcriberOrcid">ORCID du transcripteur</label>
                                <input type="text" id="transcriberOrcid" value="0000-0001-7861-3382">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label for="spaId">Identifiant SPA <span class="required">*</span></label>
                                <div class="spa-generator">
                                    <input type="text" id="spaId" placeholder="SPA_2490" required>
                                    <button type="button" class="spa-auto-btn" onclick="generateNextSpaId()">Auto</button>
                                </div>
                                <div class="help-text">Derni√®re s√©rie: 2469-2508 (Jan 2024)</div>
                            </div>
                            <div>
                                <label for="editionDate">Date d'√©dition</label>
                                <input type="date" id="editionDate">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row full">
                            <div>
                                <label for="summaryFr">R√©sum√© (FR) <span class="required">*</span></label>
                                <textarea id="summaryFr" placeholder="R√©sum√© de la lettre en fran√ßais" required></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row full">
                            <div>
                                <label for="summaryEn">R√©sum√© (EN) <span class="required">*</span></label>
                                <textarea id="summaryEn" placeholder="Summary of the letter in English" required></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row full">
                            <div>
                                <label for="incipit">Incipit <span class="required">*</span></label>
                                <input type="text" id="incipit" placeholder="J'ai vu cet apr√®s-midi une personne..." required>
                                <div class="help-text">Premiers mots de la lettre</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label for="letterLang">Langue principale de la lettre</label>
                                <select id="letterLang">
                                    <option value="fre" selected>Fran√ßais</option>
                                    <option value="eng">Anglais</option>
                                    <option value="ger">Allemand</option>
                                    <option value="rus">Russe</option>
                                </select>
                            </div>
                            <div></div>
                        </div>
                    </div>
                </div>

                <!-- √âtape 2: msDesc -->
                <div class="step-content" data-step="2">
                    <h2>üìú msDesc - Manuscript Description</h2>
                    <p class="help-text">Description physique du manuscrit (sourceDesc/msDesc dans la TEI)</p>
                    
                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label for="country">Pays du d√©p√¥t</label>
                                <input type="text" id="country" value="USA" readonly>
                            </div>
                            <div>
                                <label for="settlement">Ville du d√©p√¥t</label>
                                <input type="text" id="settlement" value="New York" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row full">
                            <div>
                                <label for="repository">D√©p√¥t d'archives</label>
                                <input type="text" id="repository" value="Rare Book & Manuscript Library, Columbia University" readonly>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label for="boxId">Cote/Bo√Æte <span class="required">*</span></label>
                                <input type="text" id="boxId" placeholder="Box II.2" value="Box II.2" required>
                            </div>
                            <div>
                                <label for="pages">Nombre de pages <span class="required">*</span></label>
                                <input type="number" id="pages" value="2" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label for="supportType">Support</label>
                                <select id="supportType">
                                    <option value="Papier" selected>Papier</option>
                                    <option value="Parchemin">Parchemin</option>
                                    <option value="Autre">Autre</option>
                                </select>
                            </div>
                            <div>
                                <label for="formType">Type de document</label>
                                <select id="formType" onchange="adaptToDocumentType()">
                                    <option value="letter" selected>Lettre</option>
                                    <option value="postcard">Carte postale</option>
                                    <option value="telegram">T√©l√©gramme</option>
                                    <option value="document">Document</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row full">
                            <div>
                                <label for="provenance">Provenance</label>
                                <textarea id="provenance" placeholder="Transf√©r√© du d√©p√¥t Ch√¢lon-Prokofiev, depuis la Biblioth√®que Nationale de France, Paris"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label for="facsimile1">URL Facsimil√© 1</label>
                                <input type="url" id="facsimile1" placeholder="10.34847/nkl.ca86te47/...">
                            </div>
                            <div>
                                <label for="facsimile2">URL Facsimil√© 2</label>
                                <input type="url" id="facsimile2" placeholder="10.34847/nkl.ca86te47/...">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label for="holdingGeo">Coordonn√©es du d√©p√¥t</label>
                                <input type="text" id="holdingGeo" value="40.8075 -73.9626" readonly>
                            </div>
                            <div></div>
                        </div>
                    </div>
                </div>

                <!-- √âtape 3: correspDesc -->
                <div class="step-content" data-step="3">
                    <h2>‚úâÔ∏è correspDesc - Correspondence Description</h2>
                    <p class="help-text">M√©tadonn√©es de correspondance (profileDesc/correspDesc dans la TEI)</p>
                    
                    <h3>Exp√©diteur</h3>
                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label for="senderName">Nom complet <span class="required">*</span></label>
                                <input type="text" id="senderName" placeholder="Demasy, Paul" required>
                            </div>
                            <div>
                                <label for="senderRef">R√©f√©rence ID <span class="required">*</span></label>
                                <input type="text" id="senderRef" placeholder="Demasy_Paul" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label for="senderViaf">VIAF ID de l'exp√©diteur</label>
                                <div class="viaf-search-container">
                                    <input type="text" id="senderViaf" placeholder="39088295">
                                    <button type="button" class="viaf-search-btn" onclick="searchViaf('senderViaf', document.getElementById('senderName').value)">üîç VIAF</button>
                                    <div id="senderViafResults" class="viaf-results"></div>
                                </div>
                            </div>
                            <div>
                                <label for="senderAddress">Adresse compl√®te <span class="required">*</span></label>
                                <input type="text" id="senderAddress" placeholder="28, rue du Printemps, Paris" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label for="senderStreet">Rue</label>
                                <input type="text" id="senderStreet" placeholder="28, rue du Printemps">
                            </div>
                            <div>
                                <label for="senderCity">Ville</label>
                                <input type="text" id="senderCity" placeholder="Paris">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label for="senderCountry">Pays</label>
                                <input type="text" id="senderCountry" placeholder="France" value="France">
                            </div>
                            <div>
                                <label for="senderGeo">Coordonn√©es GPS</label>
                                <div class="gps-search-container">
                                    <input type="text" id="senderGeo" placeholder="48.87985, 2.30983">
                                    <button type="button" class="gps-search-btn" onclick="searchGPS('senderGeo', getSenderFullAddress())">üåç GPS</button>
                                    <div id="senderGeoResults" class="gps-results"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label for="sentDate">Date d'envoi <span class="required">*</span></label>
                                <input type="date" id="sentDate" required onchange="suggestDateFormat()">
                                <div class="date-format">Sera format√© automatiquement en fran√ßais</div>
                            </div>
                            <div>
                                <label for="sentDateDisplay">Date d'envoi (affichage)</label>
                                <input type="text" id="sentDateDisplay" placeholder="Paris, 14 janvier 1924" readonly>
                            </div>
                        </div>
                    </div>

                    <h3>Destinataire</h3>
                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label for="recipientName">Nom complet <span class="required">*</span></label>
                                <input type="text" id="recipientName" value="Prokofiev, Sergei" required>
                            </div>
                            <div>
                                <label for="recipientRef">R√©f√©rence ID <span class="required">*</span></label>
                                <input type="text" id="recipientRef" value="SSP" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="form-row">
                            <div>
                                <label for="recipientViaf">VIAF ID du destinataire</label>
                                <div class="viaf-search-container">
                                    <input type="text" id="recipientViaf" value="71579098">
                                    <button type="button" class="viaf-search-btn" onclick="searchViaf('recipientViaf', document.getElementById('recipientName').value)">üîç VIAF</button>
                                    <div id="recipientViafResults" class="viaf-results"></div>
                                </div>
                            </div>
                            <div>
                                <label for="receivedDate">Date de r√©ception</label>
                                <input type="date" id="receivedDate">
                                <div class="date-format">Format: YYYY-MM-DD</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- √âtape 4: particDesc -->
                <div class="step-content" data-step="4">
                    <h2>üë• particDesc - Participant Description</h2>
                    <p class="help-text">Liste des personnes mentionn√©es (profileDesc/particDesc dans la TEI)</p>
                    
                    <div id="aiSuggestedPeople" style="display: none;">
                        <h3>ü§ñ Personnes d√©tect√©es par l'IA :</h3>
                        <div id="aiPeopleList"></div>
                    </div>

                    <div id="primaSuggestedPeople" style="display: none;">
                        <h3>üè∑Ô∏è Personnes d√©tect√©es dans Prima XML :</h3>
                        <div id="primaPeopleList"></div>
                    </div>
                    
                    <button type="button" class="add-btn" onclick="addPerson()">+ Ajouter une personne</button>
                    <div id="peopleContainer">
                        <!-- Les personnes seront ajout√©es ici dynamiquement -->
                    </div>
                </div>

                <!-- √âtape 5: settingDesc -->
                <div class="step-content" data-step="5">
                    <h2>üìç settingDesc - Setting Description</h2>
                    <p class="help-text">Description des lieux mentionn√©s (profileDesc/settingDesc dans la TEI)</p>
                    
                    <div id="primaSuggestedPlaces" style="display: none;">
                        <h3>üè∑Ô∏è Lieux d√©tect√©s dans Prima XML :</h3>
                        <div id="primaPlacesList"></div>
                    </div>

                    <button type="button" class="add-btn" onclick="addPlace()">+ Ajouter un lieu</button>
                    <div id="placesContainer">
                        <!-- Les lieux seront ajout√©s ici dynamiquement -->
                    </div>
                </div>

                <!-- √âtape 6: ≈íuvres -->
                <div class="step-content" data-step="6">
                    <h2>üéµ ≈íuvres mentionn√©es</h2>
                    <p class="help-text">Liste des ≈ìuvres musicales, litt√©raires ou artistiques √©voqu√©es dans la lettre</p>
                    
                    <div id="primaSuggestedWorks" style="display: none;">
                        <h3>üè∑Ô∏è ≈íuvres d√©tect√©es dans Prima XML :</h3>
                        <div id="primaWorksList"></div>
                    </div>

                    <button type="button" class="add-btn" onclick="addWork()">+ Ajouter une ≈ìuvre</button>
                    <div id="worksContainer">
                        <!-- Les ≈ìuvres seront ajout√©es ici dynamiquement -->
                    </div>
                </div>

                <!-- √âtape 7: G√©n√©ration -->
                <!-- √âtape 7: G√©n√©ration -->
                <div class="step-content" data-step="7">
                    <h2>üìÑ G√©n√©ration du XML TEI</h2>
                    <p class="help-text">V√©rifiez vos informations et g√©n√©rez le fichier XML TEI complet avec toutes les m√©tadonn√©es enrichies</p>
                    
                    <div id="aiAnalysisPanel" class="ai-analysis-panel" style="display: none;">
                        <h3>ü§ñ Analyse IA de la transcription</h3>
                        <div id="aiSuggestions"></div>
                    </div>

                    <div id="primaAnalysisPanel" class="prima-panel" style="display: none;">
                        <h3>üè∑Ô∏è Analyse Prima XML</h3>
                        <div id="primaSuggestions"></div>
                    </div>
                    
                    <button class="generate-btn" onclick="generateTEI()">üìÑ G√©n√©rer le XML TEI enrichi</button>

                    <div id="output" class="output"></div>
                    <button class="copy-btn" id="copyBtn" onclick="copyToClipboard()" style="display: none;">üìã Copier le XML</button>
                </div>
            </form>

            <div class="navigation">
                <button type="button" class="nav-btn secondary" id="prevBtn" onclick="previousStep()" disabled>‚Üê Pr√©c√©dent</button>
                <button type="button" class="nav-btn" id="nextBtn" onclick="nextStep()">Suivant ‚Üí</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales existantes
        let currentStep = 1;
        let totalSteps = 7;
        let personCount = 0;
        let placeCount = 0;
        let workCount = 0;
        let currentMode = 'full';
        let lastSpaId = 2508;
        let catalogueData = null;
        let selectedLetter = null;
        let transcriptionText = null;
        let aiAnalysisResults = null;

        // Nouvelles variables pour Prima XML
        let primaXMLData = null;
        let primaEntities = {
            persons: [],
            places: [],
            dates: [],
            works: []
        };
        let primaMappingRules = {
            'person': 'persName',
            'place': 'placeName',
            'date': 'date',
            'work': 'title',
            'organization': 'orgName'
        };

        // Variables pour la recherche VIAF
        let viafCache = new Map();
        let activeViafSearch = null;

        // Base de donn√©es des correspondants avec VIAF (conserv√©e)
        const correspondentsDB = {
            'Demasy, Paul': { ref: 'Demasy_Paul', viaf: '39088295' },
            'Prokofiev, Sergei': { ref: 'SSP', viaf: '71579098' },
            'Sergei Sergeevich Prokofiev': { ref: 'SSP', viaf: '71579098' },
            'Prokofiev, Sergey Sergeevich': { ref: 'SSP', viaf: '71579098' },
            'Shereshevsky, Moiseii Davidovich': { ref: 'Shereshevsky_MD', viaf: '123456789' },
            'Moiseii Davidovich Shereshevsky': { ref: 'Shereshevsky_MD', viaf: '123456789' },
            'Fitelberg, Grzegorz': { ref: 'Fitelberg_G', viaf: '987654321' },
            'Grzegorz Fitelberg': { ref: 'Fitelberg_G', viaf: '987654321' },
            'Holbrooke, Joseph': { ref: 'Holbrooke_J', viaf: '456789123' },
            'Joseph Holbrooke': { ref: 'Holbrooke_J', viaf: '456789123' },
            'Koshetz, Nina Pavlovna': { ref: 'Koshetz_NP', viaf: '789123456' },
            'Nina Pavlovna Koshetz': { ref: 'Koshetz_NP', viaf: '789123456' },
            'Chevaillier, Lucien': { ref: 'Chevaillier_L', viaf: '111222333' },
            'Lucien Chevaillier': { ref: 'Chevaillier_L', viaf: '111222333' },
            'Bashkirov, Vladimir Nikolaevich': { ref: 'Bashkirov_VN', viaf: '444555666' },
            'Vladimir Nikolaevich Bashkirov': { ref: 'Bashkirov_VN', viaf: '444555666' }
        };

        // Fonctions existantes conserv√©es int√©gralement
        function setMode(mode) {
            currentMode = mode;
            const container = document.querySelector('.form-container');
            const modeButtons = document.querySelectorAll('.mode-btn');
            
            modeButtons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (mode === 'compact') {
                container.classList.add('compact-mode');
                document.querySelectorAll('.step-content').forEach(content => {
                    content.classList.add('compact');
                });
            } else {
                container.classList.remove('compact-mode');
                document.querySelectorAll('.step-content').forEach(content => {
                    content.classList.remove('compact');
                });
            }
        }

        function showCatalogueModal() {
            document.getElementById('catalogueModal').style.display = 'block';
        }

        function closeCatalogueModal() {
            document.getElementById('catalogueModal').style.display = 'none';
        }

        function showTranscriptionImport() {
            document.getElementById('transcriptionModal').style.display = 'block';
        }

        function closeTranscriptionModal() {
            document.getElementById('transcriptionModal').style.display = 'none';
        }

        // Nouvelles fonctions pour Prima XML
        function showPrimaXMLImport() {
            document.getElementById('primaModal').style.display = 'block';
        }

        function closePrimaModal() {
            document.getElementById('primaModal').style.display = 'none';
        }

        function switchPrimaTab(tabName) {
            document.querySelectorAll('#primaModal .tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('#primaModal .tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchPrimaTab('${tabName}')"]`).classList.add('active');
            document.getElementById('prima' + tabName.charAt(0).toUpperCase() + tabName.slice(1) + 'Tab').classList.add('active');
        }

        async function loadPrimaXML(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(text, 'text/xml');
                
                // V√©rifier si c'est un fichier Prima XML valide
                if (!xmlDoc.querySelector('PcGts') && !xmlDoc.querySelector('Page')) {
                    alert('‚ùå Ce fichier ne semble pas √™tre un Prima XML valide');
                    return;
                }
                
                primaXMLData = xmlDoc;
                analyzePrimaXML(xmlDoc);
                
                document.getElementById('primaContent').style.display = 'block';
                document.getElementById('primaStatus').className = 'status-indicator status-prima';
                
                alert('‚úÖ Fichier Prima XML charg√© avec succ√®s!');
                
            } catch (error) {
                alert('‚ùå Erreur lors du chargement du fichier: ' + error.message);
            }
        }

        function analyzePrimaXML(xmlDoc) {
            const regions = xmlDoc.querySelectorAll('TextRegion');
            const lines = xmlDoc.querySelectorAll('TextLine');
            const words = xmlDoc.querySelectorAll('Word');
            const tags = xmlDoc.querySelectorAll('Word[custom]');
            
            // Mettre √† jour les statistiques
            document.getElementById('primaRegions').textContent = regions.length;
            document.getElementById('primaLines').textContent = lines.length;
            document.getElementById('primaWords').textContent = words.length;
            document.getElementById('primaTags').textContent = tags.length;
            
            // Construire l'arbre de structure
            buildPrimaStructureTree(xmlDoc);
            
            // Analyser les entit√©s
            analyzePrimaEntities(xmlDoc);
        }

        function buildPrimaStructureTree(xmlDoc) {
            const container = document.getElementById('primaStructure');
            container.innerHTML = '';
            
            const regions = xmlDoc.querySelectorAll('TextRegion');
            
            regions.forEach((region, regionIndex) => {
                const regionNode = document.createElement('div');
                regionNode.className = 'prima-node region';
                regionNode.innerHTML = `üìÑ R√©gion ${regionIndex + 1}`;
                container.appendChild(regionNode);
                
                const lines = region.querySelectorAll('TextLine');
                lines.forEach((line, lineIndex) => {
                    const lineNode = document.createElement('div');
                    lineNode.className = 'prima-node line';
                    const textEquiv = line.querySelector('TextEquiv Unicode');
                    const lineText = textEquiv ? textEquiv.textContent.substring(0, 50) + '...' : `Ligne ${lineIndex + 1}`;
                    lineNode.innerHTML = `üìù ${lineText}`;
                    container.appendChild(lineNode);
                    
                    const words = line.querySelectorAll('Word');
                    words.forEach((word, wordIndex) => {
                        const customAttr = word.getAttribute('custom');
                        if (customAttr) {
                            const wordNode = document.createElement('div');
                            wordNode.className = 'prima-node word';
                            const wordText = word.querySelector('TextEquiv Unicode');
                            wordNode.innerHTML = `üè∑Ô∏è ${wordText ? wordText.textContent : 'Mot ' + (wordIndex + 1)}`;
                            container.appendChild(wordNode);
                            
                            const tags = parsePrimaCustomTags(customAttr);
                            tags.forEach(tag => {
                                const tagNode = document.createElement('div');
                                tagNode.className = 'prima-node tag';
                                tagNode.innerHTML = `üè∑Ô∏è ${tag.type}: ${tag.value}`;
                                container.appendChild(tagNode);
                            });
                        }
                    });
                });
            });
        }

        function parsePrimaCustomTags(customString) {
            const tags = [];
            if (!customString) return tags;
            
            // Parser les tags personnalis√©s Transkribus
            const matches = customString.match(/\{([^}]+)\}/g);
            if (matches) {
                matches.forEach(match => {
                    const content = match.slice(1, -1);
                    const pairs = content.split(';');
                    const tag = {};
                    
                    pairs.forEach(pair => {
                        const [key, value] = pair.split(':');
                        if (key && value) {
                            tag[key.trim()] = value.trim();
                        }
                    });
                    
                    if (tag.type) {
                        tags.push({
                            type: tag.type,
                            value: tag.value || '',
                            continued: tag.continued || false
                        });
                    }
                });
            }
            
            return tags;
        }

        function analyzePrimaEntities(xmlDoc) {
            const wordsWithTags = xmlDoc.querySelectorAll('Word[custom]');
            
            // R√©initialiser les entit√©s
            primaEntities = {
                persons: [],
                places: [],
                dates: [],
                works: []
            };
            
            wordsWithTags.forEach(word => {
                const customAttr = word.getAttribute('custom');
                const wordText = word.querySelector('TextEquiv Unicode');
                const text = wordText ? wordText.textContent : '';
                
                const tags = parsePrimaCustomTags(customAttr);
                tags.forEach(tag => {
                    const entity = { text, tag, element: word };
                    
                    switch(tag.type) {
                        case 'person':
                            primaEntities.persons.push(entity);
                            break;
                        case 'place':
                            primaEntities.places.push(entity);
                            break;
                        case 'date':
                            primaEntities.dates.push(entity);
                            break;
                        case 'work':
                            primaEntities.works.push(entity);
                            break;
                    }
                });
            });
            
            // Afficher les entit√©s
            displayPrimaEntities();
        }

        function displayPrimaEntities() {
            const container = document.getElementById('primaEntitiesContainer');
            container.innerHTML = '';
            
            // Afficher les personnes
            if (primaEntities.persons.length > 0) {
                const personsDiv = document.createElement('div');
                personsDiv.innerHTML = '<h4>üë§ Personnes (' + primaEntities.persons.length + ')</h4>';
                primaEntities.persons.forEach(person => {
                    const entityDiv = document.createElement('div');
                    entityDiv.className = 'prima-entity';
                    entityDiv.innerHTML = `
                        <span class="prima-entity-text">${person.text}</span>
                        <span class="prima-entity-type">person</span>
                    `;
                    personsDiv.appendChild(entityDiv);
                });
                container.appendChild(personsDiv);
            }
            
            // Afficher les lieux
            if (primaEntities.places.length > 0) {
                const placesDiv = document.createElement('div');
                placesDiv.innerHTML = '<h4>üìç Lieux (' + primaEntities.places.length + ')</h4>';
                primaEntities.places.forEach(place => {
                    const entityDiv = document.createElement('div');
                    entityDiv.className = 'prima-entity';
                    entityDiv.innerHTML = `
                        <span class="prima-entity-text">${place.text}</span>
                        <span class="prima-entity-type">place</span>
                    `;
                    placesDiv.appendChild(entityDiv);
                });
                container.appendChild(placesDiv);
            }
            
            // Afficher les dates
            if (primaEntities.dates.length > 0) {
                const datesDiv = document.createElement('div');
                datesDiv.innerHTML = '<h4>üìÖ Dates (' + primaEntities.dates.length + ')</h4>';
                primaEntities.dates.forEach(date => {
                    const entityDiv = document.createElement('div');
                    entityDiv.className = 'prima-entity';
                    entityDiv.innerHTML = `
                        <span class="prima-entity-text">${date.text}</span>
                        <span class="prima-entity-type">date</span>
                    `;
                    datesDiv.appendChild(entityDiv);
                });
                container.appendChild(datesDiv);
            }
            
            // Afficher les ≈ìuvres
            if (primaEntities.works.length > 0) {
                const worksDiv = document.createElement('div');
                worksDiv.innerHTML = '<h4>üéµ ≈íuvres (' + primaEntities.works.length + ')</h4>';
                primaEntities.works.forEach(work => {
                    const entityDiv = document.createElement('div');
                    entityDiv.className = 'prima-entity';
                    entityDiv.innerHTML = `
                        <span class="prima-entity-text">${work.text}</span>
                        <span class="prima-entity-type">work</span>
                    `;
                    worksDiv.appendChild(entityDiv);
                });
                container.appendChild(worksDiv);
            }
        }

        function addPrimaMapping() {
            const container = document.getElementById('primaMappingRules');
            const mapping = document.createElement('div');
            mapping.className = 'prima-mapping';
            mapping.innerHTML = `
                <input type="text" placeholder="Type Transkribus">
                <span class="prima-arrow">‚Üí</span>
                <input type="text" placeholder="√âl√©ment TEI">
                <button class="remove-btn" onclick="removePrimaMapping(this)">-</button>
            `;
            container.appendChild(mapping);
        }

        function removePrimaMapping(button) {
            button.parentElement.remove();
        }

        function processPrimaXML() {
            if (!primaXMLData) {
                alert('‚ùå Veuillez d\'abord charger un fichier Prima XML');
                return;
            }
            
            // Collecter les r√®gles de mapping
            const mappingRules = {};
            document.querySelectorAll('#primaMappingRules .prima-mapping').forEach(rule => {
                const inputs = rule.querySelectorAll('input');
                if (inputs.length === 2 && inputs[0].value && inputs[1].value) {
                    mappingRules[inputs[0].value] = inputs[1].value;
                }
            });
            
            // Int√©grer les entit√©s Prima dans le formulaire
            integratePrimaEntities(mappingRules);
            
            // Afficher les suggestions dans les √©tapes 4 et 5
            showPrimaSuggestions();
            
            // Mettre √† jour le statut
            document.getElementById('primaStatus').className = 'status-indicator status-complete';
            
            // Fermer la modal
            closePrimaModal();
            
            alert('‚úÖ Prima XML trait√© avec succ√®s! Les entit√©s ont √©t√© int√©gr√©es dans le formulaire.');
        }

        function integratePrimaEntities(mappingRules) {
            // Remplir automatiquement l'incipit si possible
            const firstLine = primaXMLData.querySelector('TextLine TextEquiv Unicode');
            if (firstLine && firstLine.textContent) {
                const incipit = firstLine.textContent.trim().split(' ').slice(0, 10).join(' ') + '...';
                document.getElementById('incipit').value = incipit;
                document.getElementById('incipit').classList.add('prima-filled-field');
                setTimeout(() => document.getElementById('incipit').classList.remove('prima-filled-field'), 3000);
            }
        }

        function showPrimaSuggestions() {
            // Afficher les suggestions de personnes
            if (primaEntities.persons.length > 0) {
                const container = document.getElementById('primaSuggestedPeople');
                const listContainer = document.getElementById('primaPeopleList');
                
                listContainer.innerHTML = '';
                primaEntities.persons.forEach((person, index) => {
                    const suggestion = document.createElement('div');
                    suggestion.className = 'ai-suggestion';
                    suggestion.innerHTML = `
                        <div class="ai-suggestion-header">
                            <div class="ai-suggestion-title">${person.text}</div>
                            <button class="add-btn" onclick="addPrimaPerson('${person.text}')">+ Ajouter</button>
                        </div>
                        <p>D√©tect√© comme: <strong>person</strong></p>
                    `;
                    listContainer.appendChild(suggestion);
                });
                
                container.style.display = 'block';
            }
            
            // Afficher les suggestions de lieux
            if (primaEntities.places.length > 0) {
                const container = document.getElementById('primaSuggestedPlaces');
                const listContainer = document.getElementById('primaPlacesList');
                
                listContainer.innerHTML = '';
                primaEntities.places.forEach((place, index) => {
                    const suggestion = document.createElement('div');
                    suggestion.className = 'ai-suggestion';
                    suggestion.innerHTML = `
                        <div class="ai-suggestion-header">
                            <div class="ai-suggestion-title">${place.text}</div>
                            <button class="add-btn" onclick="addPrimaPlace('${place.text}')">+ Ajouter</button>
                        </div>
                        <p>D√©tect√© comme: <strong>place</strong></p>
                    `;
                    listContainer.appendChild(suggestion);
                });
                
                container.style.display = 'block';
            }

            // Afficher les suggestions d'≈ìuvres
            if (primaEntities.works.length > 0) {
                const container = document.getElementById('primaSuggestedWorks');
                const listContainer = document.getElementById('primaWorksList');
                
                listContainer.innerHTML = '';
                primaEntities.works.forEach((work, index) => {
                    const suggestion = document.createElement('div');
                    suggestion.className = 'ai-suggestion';
                    suggestion.innerHTML = `
                        <div class="ai-suggestion-header">
                            <div class="ai-suggestion-title">${work.text}</div>
                            <button class="add-btn" onclick="addPrimaWork('${work.text}')">+ Ajouter</button>
                        </div>
                        <p>D√©tect√© comme: <strong>≈ìuvre</strong></p>
                    `;
                    listContainer.appendChild(suggestion);
                });
                
                container.style.display = 'block';
            }
            
            // Afficher le panneau d'analyse Prima
            const panel = document.getElementById('primaAnalysisPanel');
            const suggestions = document.getElementById('primaSuggestions');
            
            suggestions.innerHTML = `
                <div class="ai-suggestion">
                    <div class="ai-suggestion-header">
                        <div class="ai-suggestion-title">üè∑Ô∏è Entit√©s Prima XML int√©gr√©es</div>
                        <div class="ai-confidence">100%</div>
                    </div>
                    <p><strong>Personnes:</strong> ${primaEntities.persons.length}</p>
                    <p><strong>Lieux:</strong> ${primaEntities.places.length}</p>
                    <p><strong>Dates:</strong> ${primaEntities.dates.length}</p>
                    <p><strong>≈íuvres:</strong> ${primaEntities.works.length}</p>
                </div>
            `;
            
            panel.style.display = 'block';
        }

        function addPrimaPerson(name) {
            addPerson();
            const entries = document.querySelectorAll('.person-entry');
            const lastEntry = entries[entries.length - 1];
            
            lastEntry.querySelector('input[name="personName[]"]').value = name;
            lastEntry.querySelector('input[name="personRef[]"]').value = generateReference(name);
            
            // Marquer comme ajout√© par Prima
            lastEntry.style.borderColor = '#f59e0b';
            setTimeout(() => lastEntry.style.borderColor = '#e2e8f0', 3000);
        }

        function addPrimaPlace(name) {
            addPlace();
            const entries = document.querySelectorAll('.place-entry');
            const lastEntry = entries[entries.length - 1];
            
            lastEntry.querySelector('input[name="placeName[]"]').value = name;
            lastEntry.querySelector('input[name="placeRef[]"]').value = generateReference(name);
            
            // Marquer comme ajout√© par Prima
            lastEntry.style.borderColor = '#f59e0b';
            setTimeout(() => lastEntry.style.borderColor = '#e2e8f0', 3000);
        }

        function addPrimaWork(title) {
            addWork();
            const entries = document.querySelectorAll('.work-entry');
            const lastEntry = entries[entries.length - 1];
            
            lastEntry.querySelector('input[name="workTitle[]"]').value = title;
            lastEntry.querySelector('input[name="workRef[]"]').value = generateReference(title);
            
            // Marquer comme ajout√© par Prima
            lastEntry.style.borderColor = '#f59e0b';
            setTimeout(() => lastEntry.style.borderColor = '#e2e8f0', 3000);
        }

        // Toutes les autres fonctions existantes sont conserv√©es...
        // [Le reste du code JavaScript original sera conserv√© ici]
        
        // Fonction g√©n√©rique pour le loading des catalogues (conserv√©e)
        async function loadCatalogue(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, {
                    cellStyles: true,
                    cellFormulas: true,
                    cellDates: true,
                    cellNF: true,
                    sheetStubs: true
                });

                if (!workbook.Sheets['1924']) {
                    alert('‚ùå Onglet "1924" non trouv√© dans le fichier. V√©rifiez le Catalogue v2.0.');
                    return;
                }
                
                const sheet1924 = workbook.Sheets['1924'];
                const data1924 = XLSX.utils.sheet_to_json(sheet1924);
                
                const validLetters = data1924.filter(row => 
                    row['SPA_ID'] && 
                    row['Letter_Title'] && 
                    row['SPA_ID'].toString().trim() !== ''
                );
                
                catalogueData = { '1924': validLetters };
                populateLetterDropdown(validLetters);
                
                document.getElementById('catalogueLetters').style.display = 'block';
                document.getElementById('catalogueStatus').className = 'status-indicator status-catalogue';
                
            } catch (error) {
                console.error('Erreur lors du chargement:', error);
                alert('Erreur lors du chargement du catalogue: ' + error.message);
            }
        }

        function populateLetterDropdown(letters) {
            const select = document.getElementById('letterSelect');
            select.innerHTML = '<option value="">-- Choisir une lettre --</option>';
            
            letters.sort((a, b) => {
                const spaA = a['SPA_ID'].toString().replace('SPA_', '');
                const spaB = b['SPA_ID'].toString().replace('SPA_', '');
                return parseInt(spaA) - parseInt(spaB);
            });
            
            letters.forEach((letter, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${letter['SPA_ID']} - ${letter['Letter_Title']}`;
                select.appendChild(option);
            });
            
            window.allLetters = letters;
        }

        function previewSelectedLetter() {
            const select = document.getElementById('letterSelect');
            const selectedIndex = select.value;
            
            if (!selectedIndex || !window.allLetters) {
                document.getElementById('letterPreview').style.display = 'none';
                document.getElementById('importBtn').disabled = true;
                return;
            }
            
            const letter = window.allLetters[selectedIndex];
            selectedLetter = { data: letter };
            
            const previewContent = document.getElementById('previewContent');
            previewContent.innerHTML = `
                <div class="letter-info">
                    <div class="letter-detail">
                        <div class="letter-label">üè∑Ô∏è SPA ID</div>
                        <div class="letter-value">${letter['SPA_ID']}</div>
                    </div>
                    <div class="letter-detail">
                        <div class="letter-label">üìù Titre</div>
                        <div class="letter-value">${letter['Letter_Title']}</div>
                    </div>
                    <div class="letter-detail">
                        <div class="letter-label">üë§ Exp√©diteur</div>
                        <div class="letter-value">${letter["Sender's Name"] || 'N/A'}</div>
                    </div>
                    <div class="letter-detail">
                        <div class="letter-label">üë§ Destinataire</div>
                        <div class="letter-value">${letter["Recipient's Name"] || 'N/A'}</div>
                    </div>
                    <div class="letter-detail">
                        <div class="letter-label">üìÖ Date</div>
                        <div class="letter-value">${letter['Date'] || 'N/A'}</div>
                    </div>
                    <div class="letter-detail">
                        <div class="letter-label">üåç Langue</div>
                        <div class="letter-value">${letter['Language'] || 'N/A'}</div>
                    </div>
                    <div class="letter-detail">
                        <div class="letter-label">üìã Type</div>
                        <div class="letter-value">${letter['Document type']} - ${letter['Format']}</div>
                    </div>
                    <div class="letter-detail">
                        <div class="letter-label">üì¶ Bo√Æte</div>
                        <div class="letter-value">Box ${letter['Box']} - ${letter['Folder']}</div>
                    </div>
                    <div class="letter-detail">
                        <div class="letter-label">üìç Adresse exp√©diteur</div>
                        <div class="letter-value">${letter['Sender_Address'] || letter['Sender address'] || 'N/A'}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('letterPreview').style.display = 'block';
            document.getElementById('importBtn').disabled = false;
        }

        function importSelectedLetter() {
            if (!selectedLetter) return;
            
            const letter = selectedLetter.data;
            fillFromCatalogueV2(letter);
            
            closeCatalogueModal();
            document.getElementById('catalogueStatus').className = 'status-indicator status-complete';
            
            alert(`‚úÖ Lettre import√©e avec succ√®s!\n${letter['SPA_ID']} - ${letter['Letter_Title']}`);
        }

        function fillFromCatalogueV2(letter) {
            const senderName = normalizeName(letter["Sender's Name"] || '');
            const recipientName = normalizeName(letter["Recipient's Name"] || '');
            
            if (senderName) {
                document.getElementById('senderName').value = senderName;
                document.getElementById('senderRef').value = generateReference(senderName);
                
                if (correspondentsDB[senderName]) {
                    document.getElementById('senderViaf').value = correspondentsDB[senderName].viaf;
                }
            }
            
            if (recipientName) {
                document.getElementById('recipientName').value = recipientName;
                document.getElementById('recipientRef').value = generateReference(recipientName);
                
                if (correspondentsDB[recipientName]) {
                    document.getElementById('recipientViaf').value = correspondentsDB[recipientName].viaf;
                }
            }
            
            if (letter['SPA_ID']) {
                document.getElementById('spaId').value = letter['SPA_ID'];
            }
            
            if (letter['Date']) {
                let dateValue = letter['Date'];
                if (typeof dateValue === 'string' && dateValue.includes('T')) {
                    dateValue = dateValue.split('T')[0];
                } else if (dateValue instanceof Date) {
                    dateValue = dateValue.toISOString().split('T')[0];
                }
                document.getElementById('sentDate').value = dateValue;
                suggestDateFormat();
            }
            
            const senderAddress = letter['Sender_Address'] || letter['Sender address'] || '';
            const senderStreet = letter['Sender_Street_Normalized'] || '';
            const senderCity = letter['Sender_City_Normalized'] || '';
            const senderCountry = letter['Sender_Country_Normalized'] || '';
            const senderGeo = letter['Sender_Geocode'] || '';
            
            if (senderAddress) {
                document.getElementById('senderAddress').value = senderAddress;
            }
            if (senderStreet) {
                document.getElementById('senderStreet').value = senderStreet;
            }
            if (senderCity) {
                document.getElementById('senderCity').value = senderCity.trim();
            }
            if (senderCountry) {
                document.getElementById('senderCountry').value = senderCountry.trim();
            }
            if (senderGeo) {
                document.getElementById('senderGeo').value = senderGeo;
            }
            
            if (letter['Box']) {
                document.getElementById('boxId').value = `Box ${letter['Box']}`;
            }
            
            const language = letter['Language'];
            if (language) {
                const langMap = {
                    'French': 'fre',
                    'Russian': 'rus',
                    'English': 'eng',
                    'German': 'ger'
                };
                const langCode = langMap[language] || 'fre';
                document.getElementById('letterLang').value = langCode;
            }
            
            const docType = letter['Document type'];
            if (docType && docType.toLowerCase().includes('postcard')) {
                document.getElementById('formType').value = 'postcard';
            } else if (docType && docType.toLowerCase().includes('telegram')) {
                document.getElementById('formType').value = 'telegram';
            } else {
                document.getElementById('formType').value = 'letter';
            }
            
            const extent = letter['Extent'];
            if (extent) {
                const pageMatch = extent.match(/(\d+)\s*page/);
                if (pageMatch) {
                    document.getElementById('pages').value = pageMatch[1];
                }
            }
            
            adaptToDocumentType();
            
            if (letter['Previous holding library']) {
                document.getElementById('provenance').value = `Transf√©r√© du d√©p√¥t ${letter['Previous holding library']}`;
            }
            
            updateLetterTitles();
            
            const autoFilledFields = ['senderName', 'recipientName', 'senderRef', 'recipientRef', 'sentDate', 'spaId', 'boxId', 'senderAddress', 'senderStreet', 'senderCity', 'senderCountry', 'senderGeo'];
            autoFilledFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.value) {
                    field.classList.add('auto-filled-field');
                    setTimeout(() => field.classList.remove('auto-filled-field'), 5000);
                }
            });
        }

        function normalizeName(name) {
            if (!name) return '';
            
            const normalizations = {
                'Sergei Sergeevich Prokofiev': 'Prokofiev, Sergei',
                'Sergey Sergeevich Prokofiev': 'Prokofiev, Sergei',
                'Moiseii Davidovich Shereshevsky': 'Shereshevsky, Moiseii Davidovich',
                'Grzegorz Fitelberg': 'Fitelberg, Grzegorz',
                'Joseph Holbrooke': 'Holbrooke, Joseph',
                'Nina Pavlovna Koshetz': 'Koshetz, Nina Pavlovna',
                'Lucien Chevaillier': 'Chevaillier, Lucien',
                'Vladimir Nikolaevich Bashkirov': 'Bashkirov, Vladimir Nikolaevich'
            };
            
            const cleanName = name.trim().replace(/\s+/g, ' ');
            return normalizations[cleanName] || cleanName;
        }

        function generateReference(fullName) {
            if (!fullName) return '';
            if (fullName === 'Prokofiev, Sergei') return 'SSP';
            
            const parts = fullName.split(',').map(p => p.trim());
            if (parts.length >= 2) {
                const lastName = parts[0].replace(/\s+/g, '');
                const firstName = parts[1].split(' ')[0];
                return `${lastName}_${firstName}`;
            }
            
            const words = fullName.split(' ').filter(w => w.length > 0);
            if (words.length >= 2) {
                const firstName = words[0];
                const lastName = words[words.length - 1];
                return `${lastName}_${firstName}`;
            }
            
            return fullName.replace(/[^a-zA-Z]/g, '_');
        }

        // Fonctions pour l'import transcription (conserv√©es)
        async function loadTranscription(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                
                if (file.name.toLowerCase().endsWith('.xml')) {
                    transcriptionText = parseXMLTranscription(text);
                } else {
                    transcriptionText = text;
                }
                
                document.getElementById('transcriptionContent').textContent = transcriptionText.substring(0, 1000) + '...';
                document.getElementById('transcriptionPreview').style.display = 'block';
                document.getElementById('transcriptionStatus').className = 'status-indicator status-transcription';
                
                document.getElementById('aiBtn').disabled = false;
                
            } catch (error) {
                alert('Erreur lors du chargement de la transcription: ' + error.message);
            }
        }

        function parseXMLTranscription(xmlText) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            
            let textElements = xmlDoc.querySelectorAll('p, line, textLine, seg');
            if (textElements.length === 0) {
                textElements = xmlDoc.querySelectorAll('*');
            }
            
            let extractedText = '';
            textElements.forEach(element => {
                if (element.textContent && element.textContent.trim()) {
                    extractedText += element.textContent.trim() + ' ';
                }
            });
            
            return extractedText.trim() || xmlText;
        }

        function processTranscription() {
            if (transcriptionText) {
                runAIAnalysis();
                closeTranscriptionModal();
            }
        }

        async function runAIAnalysis() {
            if (!transcriptionText) {
                alert('Veuillez d\'abord charger une transcription Transkribus');
                return;
            }
            
            document.getElementById('aiBtn').innerHTML = 'ü§ñ Analyse en cours... <span class="loading"></span>';
            
            try {
                const apiKey = localStorage.getItem('claude_api_key');
                if (!apiKey) {
                    showAPIKeyDialog();
                    return;
                }
                
                const analysisResults = await analyzeWithClaude(transcriptionText, apiKey);
                displayAIAnalysisWithValidation(analysisResults);
                
                document.getElementById('aiStatus').className = 'status-indicator status-complete';
                document.getElementById('aiBtn').innerHTML = 'ü§ñ Analyse IA';
                
            } catch (error) {
                console.error('Erreur analyse IA:', error);
                alert('Erreur lors de l\'analyse IA: ' + error.message + '\nV√©rifiez votre cl√© API Claude.');
                document.getElementById('aiBtn').innerHTML = 'ü§ñ Analyse IA';
            }
        }

        function showAPIKeyDialog() {
            const apiKey = prompt(`üîë Configuration API Claude

Pour utiliser l'analyse IA, vous devez configurer votre cl√© API Claude :

1. Cr√©ez un compte sur console.anthropic.com
2. G√©n√©rez une cl√© API
3. Entrez-la ci-dessous (elle sera stock√©e localement)

Cl√© API Claude :`);
            
            if (apiKey && apiKey.trim()) {
                localStorage.setItem('claude_api_key', apiKey.trim());
                runAIAnalysis();
            }
        }

        async function analyzeWithClaude(text, apiKey) {
            const prompt = buildAnalysisPrompt(text);
            
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: 'claude-3-sonnet-20240229',
                    max_tokens: 2000,
                    messages: [{
                        role: 'user',
                        content: prompt
                    }]
                })
            });

            if (!response.ok) {
                throw new Error(`Erreur API Claude: ${response.status}`);
            }

            const data = await response.json();
            return parseClaudeResponse(data.content[0].text);
        }

        function buildAnalysisPrompt(transcriptionText) {
            const senderName = document.getElementById('senderName').value || '[Exp√©diteur]';
            const recipientName = document.getElementById('recipientName').value || '[Destinataire]';
            const date = document.getElementById('sentDate').value || '[Date]';
            
            return `Tu es un expert en √©dition de correspondances historiques et en TEI (Text Encoding Initiative). Analyse cette lettre de ${senderName} √† ${recipientName} dat√©e de ${date} et fournis une analyse structur√©e.

CONTEXTE : Correspondance de Sergei Prokofiev en 1924, p√©riode o√π il vit en exil en Occident et d√©veloppe sa carri√®re internationale.

TRANSCRIPTION √Ä ANALYSER :
${transcriptionText}

T√ÇCHES D'ANALYSE :

1. R√âSUM√â FRAN√áAIS (2-3 phrases, style acad√©mique) :
- R√©sume le contenu principal et l'objet de la lettre
- Mentionne les √©l√©ments factuels importants
- Style : "[Exp√©diteur] [verbe] [contenu principal] √† [destinataire]"

2. R√âSUM√â ANGLAIS (traduction du r√©sum√© fran√ßais) :
- Traduction fid√®le du r√©sum√© fran√ßais
- Vocabulaire acad√©mique anglais

3. INCIPIT (premiers mots significatifs) :
- Extrait les 6-10 premiers mots r√©ellement significatifs
- Ignore les formules d'adresse standard
- Supprime guillemets et ponctuation superflue

4. PERSONNES MENTIONN√âES :
- Liste des noms propres de personnes (hors exp√©diteur/destinataire)
- Format : "Nom, Pr√©nom" si possible
- Maximum 5 personnes les plus importantes

5. LIEUX MENTIONN√âS :
- Lieux g√©ographiques sp√©cifiques mentionn√©s
- Exclure l'adresse de l'exp√©diteur d√©j√† connue
- Maximum 3 lieux les plus significatifs

6. MOTS-CL√âS TH√âMATIQUES :
- 3-5 mots-cl√©s d√©crivant les th√®mes principaux
- Vocabulaire : musique, th√©√¢tre, √©dition, famille, finances, voyages, etc.

R√âPONSE ATTENDUE (format JSON strict) :
{
  "resume_fr": "...",
  "resume_en": "...", 
  "incipit": "...",
  "personnes": ["Nom1, Pr√©nom1", "Nom2, Pr√©nom2"],
  "lieux": ["Lieu1", "Lieu2"],
  "mots_cles": ["mot1", "mot2", "mot3"],
  "confiance": 0.95
}

IMPORTANT : R√©ponds UNIQUEMENT avec le JSON, aucun autre texte.`;
        }

        function parseClaudeResponse(responseText) {
            try {
                const jsonMatch = responseText.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error('Format de r√©ponse invalide');
                }
                
                return JSON.parse(jsonMatch[0]);
            } catch (error) {
                console.error('Erreur parsing Claude:', error);
                throw new Error('Impossible de parser la r√©ponse de Claude');
            }
        }

        function displayAIAnalysisWithValidation(results) {
            const panel = document.getElementById('aiAnalysisPanel');
            const suggestionsDiv = document.getElementById('aiSuggestions');
            
            suggestionsDiv.innerHTML = `
                <div class="ai-suggestion">
                    <div class="ai-suggestion-header">
                        <div class="ai-suggestion-title">üìù R√©sum√© g√©n√©r√© par Claude</div>
                        <div class="ai-confidence">${Math.round(results.confiance * 100)}%</div>
                    </div>
                    <div style="margin: 10px 0;">
                        <label><strong>Fran√ßais:</strong></label>
                        <textarea id="aiSummaryFr" style="width: 100%; height: 60px; margin: 5px 0;">${results.resume_fr}</textarea>
                        <button onclick="applySummaryFr()" class="add-btn" style="padding: 5px 10px; font-size: 0.8rem;">‚úì Appliquer</button>
                    </div>
                    <div style="margin: 10px 0;">
                        <label><strong>Anglais:</strong></label>
                        <textarea id="aiSummaryEn" style="width: 100%; height: 60px; margin: 5px 0;">${results.resume_en}</textarea>
                        <button onclick="applySummaryEn()" class="add-btn" style="padding: 5px 10px; font-size: 0.8rem;">‚úì Appliquer</button>
                    </div>
                </div>
                
                <div class="ai-suggestion">
                    <div class="ai-suggestion-header">
                        <div class="ai-suggestion-title">üéØ Incipit d√©tect√©</div>
                        <div class="ai-confidence">${Math.round(results.confiance * 100)}%</div>
                    </div>
                    <div style="margin: 10px 0;">
                        <input id="aiIncipit" type="text" style="width: 80%; margin-right: 10px;" value="${results.incipit}">
                        <button onclick="applyIncipit()" class="add-btn" style="padding: 5px 10px; font-size: 0.8rem;">‚úì Appliquer</button>
                    </div>
                </div>
                
                ${results.personnes && results.personnes.length > 0 ? `
                <div class="ai-suggestion">
                    <div class="ai-suggestion-header">
                        <div class="ai-suggestion-title">üë• Personnes d√©tect√©es</div>
                        <div class="ai-confidence">${Math.round(results.confiance * 100)}%</div>
                    </div>
                    <div style="margin: 10px 0;">
                        ${results.personnes.map((person, index) => `
                            <div style="display: flex; align-items: center; margin: 5px 0;">
                                <input type="text" value="${person}" style="flex: 1; margin-right: 10px;" id="aiPerson${index}">
                                <button onclick="addValidatedPerson(${index})" class="add-btn" style="padding: 5px 10px; font-size: 0.8rem;">+ Ajouter</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${results.lieux && results.lieux.length > 0 ? `
                <div class="ai-suggestion">
                    <div class="ai-suggestion-header">
                        <div class="ai-suggestion-title">üìç Lieux d√©tect√©s</div>
                        <div class="ai-confidence">${Math.round(results.confiance * 100)}%</div>
                    </div>
                    <div style="margin: 10px 0;">
                        ${results.lieux.map((lieu, index) => `
                            <div style="display: flex; align-items: center; margin: 5px 0;">
                                <input type="text" value="${lieu}" style="flex: 1; margin-right: 10px;" id="aiLieu${index}">
                                <button onclick="addValidatedPlace(${index})" class="add-btn" style="padding: 5px 10px; font-size: 0.8rem;">+ Ajouter</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${results.mots_cles && results.mots_cles.length > 0 ? `
                <div class="ai-suggestion">
                    <div class="ai-suggestion-header">
                        <div class="ai-suggestion-title">üè∑Ô∏è Mots-cl√©s th√©matiques</div>
                        <div class="ai-confidence">${Math.round(results.confiance * 100)}%</div>
                    </div>
                    <p style="margin: 10px 0; font-style: italic;">${results.mots_cles.join(' ‚Ä¢ ')}</p>
                </div>
                ` : ''}
            `;
            
            panel.style.display = 'block';
            window.aiAnalysisResults = results;
        }

        // Fonctions de validation humaine
        function applySummaryFr() {
            const summary = document.getElementById('aiSummaryFr').value;
            document.getElementById('summaryFr').value = summary;
            document.getElementById('summaryFr').classList.add('ai-filled-field');
            setTimeout(() => document.getElementById('summaryFr').classList.remove('ai-filled-field'), 3000);
        }

        function applySummaryEn() {
            const summary = document.getElementById('aiSummaryEn').value;
            document.getElementById('summaryEn').value = summary;
            document.getElementById('summaryEn').classList.add('ai-filled-field');
            setTimeout(() => document.getElementById('summaryEn').classList.remove('ai-filled-field'), 3000);
        }

        function applyIncipit() {
            const incipit = document.getElementById('aiIncipit').value;
            document.getElementById('incipit').value = incipit;
            document.getElementById('incipit').classList.add('ai-filled-field');
            setTimeout(() => document.getElementById('incipit').classList.remove('ai-filled-field'), 3000);
        }

        function addValidatedPerson(index) {
            const personName = document.getElementById(`aiPerson${index}`).value;
            if (!personName.trim()) return;
            
            addPerson();
            const entries = document.querySelectorAll('.person-entry');
            const lastEntry = entries[entries.length - 1];
            
            lastEntry.querySelector('input[name="personName[]"]').value = personName;
            lastEntry.querySelector('input[name="personRef[]"]').value = generateReference(personName);
            
            lastEntry.style.borderColor = '#8b5cf6';
            setTimeout(() => lastEntry.style.borderColor = '#e2e8f0', 3000);
        }

        function addValidatedPlace(index) {
            const placeName = document.getElementById(`aiLieu${index}`).value;
            if (!placeName.trim()) return;
            
            addPlace();
            const entries = document.querySelectorAll('.place-entry');
            const lastEntry = entries[entries.length - 1];
            
            lastEntry.querySelector('input[name="placeName[]"]').value = placeName;
            lastEntry.querySelector('input[name="placeRef[]"]').value = generateReference(placeName);
            
            lastEntry.style.borderColor = '#8b5cf6';
            setTimeout(() => lastEntry.style.borderColor = '#e2e8f0', 3000);
        }

        function generateNextSpaId() {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;
            
            if (currentYear === 2024 && currentMonth === 1) {
                lastSpaId = Math.max(lastSpaId + 1, 2509);
            } else {
                lastSpaId += 1;
            }
            
            document.getElementById('spaId').value = 'SPA_' + lastSpaId;
            document.getElementById('spaId').classList.add('auto-filled-field');
            setTimeout(() => document.getElementById('spaId').classList.remove('auto-filled-field'), 2000);
        }

        function updateLetterTitles() {
            const sender = document.getElementById('senderName').value;
            const recipient = document.getElementById('recipientName').value;
            const date = document.getElementById('sentDate').value;
            const city = document.getElementById('senderCity').value || 'Paris';
            
            if (sender && recipient && date) {
                const frenchDate = new Date(date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
                const englishDate = new Date(date).toLocaleDateString('en-US', { day: 'numeric', month: 'long', year: 'numeric' });
                
                const titleFr = `${sender} √† ${recipient}, ${city}, France, ${frenchDate}`;
                const titleEn = `${sender} to ${recipient}, ${city}, France, ${englishDate}`;
                
                document.getElementById('letterTitleFr').value = titleFr;
                document.getElementById('letterTitleEn').value = titleEn;
            }
        }

        function suggestDateFormat() {
            const date = document.getElementById('sentDate').value;
            const city = document.getElementById('senderCity').value || 'Paris';
            
            if (date) {
                const frenchDate = new Date(date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
                document.getElementById('sentDateDisplay').value = `${city}, ${frenchDate}`;
                updateLetterTitles();
            }
        }

        function adaptToDocumentType() {
            const type = document.getElementById('formType').value;
            const pagesField = document.getElementById('pages');
            
            switch(type) {
                case 'postcard':
                    pagesField.value = 1;
                    break;
                case 'telegram':
                    pagesField.value = 1;
                    break;
                case 'letter':
                default:
                    pagesField.value = 2;
                    break;
            }
        }

        function updateProgressBar() {
            const progressBar = document.getElementById('progressBar');
            const steps = progressBar.querySelectorAll('.progress-step');
            
            steps.forEach((step, index) => {
                const stepNumber = index + 1;
                step.classList.remove('active', 'completed');
                
                if (stepNumber < currentStep) {
                    step.classList.add('completed');
                } else if (stepNumber === currentStep) {
                    step.classList.add('active');
                }
            });
            
            const progressPercentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
            const progressBarElement = document.getElementById('progressBar');
            
            let progressLine = progressBarElement.querySelector('.progress-line');
            if (!progressLine) {
                progressLine = document.createElement('div');
                progressLine.className = 'progress-line';
                progressLine.style.cssText = `
                    position: absolute;
                    top: 50%;
                    left: 0;
                    height: 2px;
                    background: #2c5aa0;
                    z-index: 2;
                    transition: width 0.3s ease;
                `;
                progressBarElement.appendChild(progressLine);
            }
            progressLine.style.width = progressPercentage + '%';
            
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (prevBtn) prevBtn.disabled = currentStep === 1;
            if (nextBtn) nextBtn.textContent = currentStep === totalSteps ? 'Terminer' : 'Suivant ‚Üí';
        }

        function showStep(step) {
            if (currentMode === 'compact') return;
            
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            
            const targetStep = document.querySelector(`.step-content[data-step="${step}"]`);
            if (targetStep) {
                targetStep.classList.add('active');
            }
            
            currentStep = step;
            updateProgressBar();
        }

        function nextStep() {
            if (currentStep < totalSteps) {
                showStep(currentStep + 1);
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                showStep(currentStep - 1);
            }
        }

        function addPerson() {
            personCount++;
            const container = document.getElementById('peopleContainer');
            const personDiv = document.createElement('div');
            personDiv.className = 'person-entry';
            const viafId = 'personViaf_' + personCount;
            const nameId = 'personName_' + personCount;
            personDiv.innerHTML = `
                <button type="button" class="remove-btn" onclick="removePerson(this)">Supprimer</button>
                <div class="form-row">
                    <div>
                        <label>Nom complet</label>
                        <input type="text" name="personName[]" id="${nameId}" placeholder="Rubinstein, Ida">
                    </div>
                    <div>
                        <label>Identifiant de r√©f√©rence</label>
                        <input type="text" name="personRef[]" placeholder="Rubinstein_Ida">
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label>VIAF ID</label>
                        <div class="viaf-search-container">
                            <input type="text" name="personViaf[]" id="${viafId}" placeholder="29614722">
                            <button type="button" class="viaf-search-btn" onclick="searchViafForPerson('${viafId}', '${nameId}')">üîç VIAF</button>
                            <div id="${viafId}Results" class="viaf-results"></div>
                        </div>
                    </div>
                    <div></div>
                </div>
            `;
            container.appendChild(personDiv);
        }

        function removePerson(button) {
            button.parentNode.remove();
        }

        function addPlace() {
            placeCount++;
            const container = document.getElementById('placesContainer');
            const placeDiv = document.createElement('div');
            placeDiv.className = 'place-entry';
            const gpsId = 'placeGeo_' + placeCount;
            const nameId = 'placeName_' + placeCount;
            placeDiv.innerHTML = `
                <button type="button" class="remove-btn" onclick="removePlace(this)">Supprimer</button>
                <div class="form-row">
                    <div>
                        <label>Nom du lieu</label>
                        <input type="text" name="placeName[]" id="${nameId}" placeholder="Th√©√¢tre des Champs-√âlys√©es">
                    </div>
                    <div>
                        <label>Identifiant de r√©f√©rence</label>
                        <input type="text" name="placeRef[]" placeholder="Theatre_ChampsElysees">
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label>Coordonn√©es GPS</label>
                        <div class="gps-search-container">
                            <input type="text" name="placeGeo[]" id="${gpsId}" placeholder="48.8656 2.3081">
                            <button type="button" class="gps-search-btn" onclick="searchGPSForPlace('${gpsId}', '${nameId}')">üåç GPS</button>
                            <div id="${gpsId}Results" class="gps-results"></div>
                        </div>
                    </div>
                    <div></div>
                </div>
            `;
            container.appendChild(placeDiv);
        }

        function removePlace(button) {
            button.parentNode.remove();
        }

        function addWork() {
            workCount++;
            const container = document.getElementById('worksContainer');
            const workDiv = document.createElement('div');
            workDiv.className = 'work-entry';
            const viafId = 'workViaf_' + workCount;
            const titleId = 'workTitle_' + workCount;
            workDiv.innerHTML = `
                <button type="button" class="remove-btn" onclick="removeWork(this)">Supprimer</button>
                
                <div class="work-type-selector">
                    <div class="work-type-btn selected" onclick="selectWorkType(this, 'musical')">üéµ ≈íuvre musicale</div>
                    <div class="work-type-btn" onclick="selectWorkType(this, 'literary')">üìö ≈íuvre litt√©raire</div>
                    <div class="work-type-btn" onclick="selectWorkType(this, 'theatrical')">üé≠ ≈íuvre th√©√¢trale</div>
                    <div class="work-type-btn" onclick="selectWorkType(this, 'other')">üé® Autre</div>
                </div>
                <input type="hidden" name="workType[]" value="musical">
                
                <div class="form-row">
                    <div>
                        <label>Titre de l'≈ìuvre</label>
                        <input type="text" name="workTitle[]" id="${titleId}" placeholder="Rom√©o et Juliette">
                    </div>
                    <div>
                        <label>Identifiant de r√©f√©rence</label>
                        <input type="text" name="workRef[]" placeholder="Romeo_Juliette_Prokofiev">
                    </div>
                </div>
                
                <div class="form-row">
                    <div>
                        <label>Compositeur/Auteur</label>
                        <input type="text" name="workComposer[]" placeholder="Prokofiev, Sergei">
                    </div>
                    <div>
                        <label>Date de composition</label>
                        <input type="text" name="workDate[]" placeholder="1935-1936">
                    </div>
                </div>
                
                <div class="form-row">
                    <div>
                        <label>VIAF ID de l'≈ìuvre</label>
                        <div class="viaf-search-container">
                            <input type="text" name="workViaf[]" id="${viafId}" placeholder="185796205">
                            <button type="button" class="viaf-search-btn" onclick="searchViafForWork('${viafId}', '${titleId}')">üîç VIAF</button>
                            <div id="${viafId}Results" class="viaf-results"></div>
                        </div>
                    </div>
                    <div>
                        <label>Tonalit√©/Opus (si applicable)</label>
                        <input type="text" name="workOpus[]" placeholder="Op. 64">
                    </div>
                </div>
                
                <div class="form-row full">
                    <div>
                        <label>Description/Contexte</label>
                        <textarea name="workDescription[]" placeholder="Ballet en trois actes, cr√©√© au Th√©√¢tre Kirov en 1940"></textarea>
                    </div>
                </div>
            `;
            container.appendChild(workDiv);
        }

        function removeWork(button) {
            button.parentNode.remove();
        }

        function selectWorkType(button, type) {
            // D√©s√©lectionner tous les boutons de ce groupe
            const container = button.closest('.work-entry');
            container.querySelectorAll('.work-type-btn').forEach(btn => btn.classList.remove('selected'));
            
            // S√©lectionner le bouton cliqu√©
            button.classList.add('selected');
            
            // Mettre √† jour le champ cach√©
            container.querySelector('input[name="workType[]"]').value = type;
        }

        function searchViafForWork(viafInputId, titleInputId) {
            const titleInput = document.getElementById(titleInputId);
            if (titleInput && titleInput.value) {
                searchViaf(viafInputId, titleInput.value);
            } else {
                showViafError(viafInputId + 'Results', 'Veuillez d\'abord saisir un titre d\'≈ìuvre');
            }
        }

        // Fonctions de recherche GPS
        async function searchGPS(inputId, searchTerm) {
            if (!searchTerm || searchTerm.trim().length < 3) {
                showGPSError(inputId + 'Results', 'Veuillez saisir au moins 3 caract√®res');
                return;
            }

            const resultsContainer = document.getElementById(inputId + 'Results');
            const searchBtn = document.querySelector(`[onclick*="${inputId}"]`);
            
            // Afficher le loading
            showGPSLoading(resultsContainer);
            searchBtn.innerHTML = '‚è≥ Recherche...';

            try {
                // Utiliser l'API Nominatim d'OpenStreetMap (gratuite)
                const encodedQuery = encodeURIComponent(searchTerm);
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodedQuery}&limit=10&addressdetails=1`;
                
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'Proko24-TEI-Generator/2.1'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erreur g√©ocodage: ${response.status}`);
                }

                const data = await response.json();
                
                // Parser les r√©sultats
                const results = parseGPSResults(data);
                
                // Afficher les r√©sultats
                displayGPSResults(inputId, results);
                
            } catch (error) {
                console.error('Erreur recherche GPS:', error);
                showGPSError(inputId + 'Results', 'Erreur lors de la recherche de coordonn√©es');
            } finally {
                searchBtn.innerHTML = 'üåç GPS';
            }
        }

        function parseGPSResults(data) {
            const results = [];
            
            if (data && Array.isArray(data)) {
                data.forEach(item => {
                    if (item.lat && item.lon && item.display_name) {
                        results.push({
                            name: item.display_name,
                            lat: parseFloat(item.lat),
                            lon: parseFloat(item.lon),
                            type: item.type || 'location',
                            country: item.address?.country || ''
                        });
                    }
                });
            }
            
            return results.slice(0, 8); // Limiter √† 8 r√©sultats
        }

        function showGPSLoading(container) {
            container.innerHTML = '<div class="viaf-loading">üåç Recherche en cours...</div>';
            container.style.display = 'block';
        }

        function showGPSError(containerId, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="viaf-error">‚ùå ${message}</div>`;
            container.style.display = 'block';
            
            setTimeout(() => {
                container.style.display = 'none';
            }, 3000);
        }

        function displayGPSResults(inputId, results) {
            const container = document.getElementById(inputId + 'Results');
            
            if (!results || results.length === 0) {
                container.innerHTML = '<div class="viaf-no-results">Aucun r√©sultat trouv√©</div>';
                container.style.display = 'block';
                setTimeout(() => {
                    container.style.display = 'none';
                }, 3000);
                return;
            }

            let html = '';
            results.forEach((result, index) => {
                const coords = `${result.lat.toFixed(6)}, ${result.lon.toFixed(6)}`;
                html += `
                    <div class="gps-result-item" onclick="selectGPSResult('${inputId}', '${coords}', '${result.name.replace(/'/g, "\\'")}')">
                        <div class="gps-result-name">${result.name}</div>
                        <div class="gps-result-details">${result.type} - ${result.country}</div>
                        <div class="gps-result-coords">${coords}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
            container.style.display = 'block';

            // Fermer au clic √† l'ext√©rieur
            document.addEventListener('click', function closeGPSResults(e) {
                if (!container.contains(e.target) && !e.target.closest('.gps-search-btn')) {
                    container.style.display = 'none';
                    document.removeEventListener('click', closeGPSResults);
                }
            });
        }

        function selectGPSResult(inputId, coords, name) {
            const input = document.getElementById(inputId);
            const container = document.getElementById(inputId + 'Results');
            
            // Remplir le champ coordonn√©es
            input.value = coords;
            input.classList.add('gps-filled-field');
            
            // Fermer les r√©sultats
            container.style.display = 'none';
            
            // Ajouter un indicateur visuel
            setTimeout(() => {
                input.classList.remove('gps-filled-field');
            }, 3000);
            
            // Notification
            showGPSSuccess(`Coordonn√©es trouv√©es: ${coords} pour "${name}"`);
        }

        function searchGPSForPlace(gpsInputId, nameInputId) {
            const nameInput = document.getElementById(nameInputId);
            if (nameInput && nameInput.value) {
                searchGPS(gpsInputId, nameInput.value);
            } else {
                showGPSError(gpsInputId + 'Results', 'Veuillez d\'abord saisir un nom de lieu');
            }
        }

        function getSenderFullAddress() {
            const street = document.getElementById('senderStreet').value || '';
            const city = document.getElementById('senderCity').value || '';
            const country = document.getElementById('senderCountry').value || '';
            return [street, city, country].filter(s => s.trim()).join(', ');
        }

        function showGPSSuccess(message) {
            // Cr√©er une notification temporaire
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 1000;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = '‚úÖ ' + message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function addPlace() {
            placeCount++;
            const container = document.getElementById('placesContainer');
            const placeDiv = document.createElement('div');
            placeDiv.className = 'place-entry';
            const gpsId = 'placeGeo_' + placeCount;
            const nameId = 'placeName_' + placeCount;
            placeDiv.innerHTML = `
                <button type="button" class="remove-btn" onclick="removePlace(this)">Supprimer</button>
                <div class="form-row">
                    <div>
                        <label>Nom du lieu</label>
                        <input type="text" name="placeName[]" id="${nameId}" placeholder="Th√©√¢tre des Champs-√âlys√©es">
                    </div>
                    <div>
                        <label>Identifiant de r√©f√©rence</label>
                        <input type="text" name="placeRef[]" placeholder="Theatre_ChampsElysees">
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label>Coordonn√©es GPS</label>
                        <div class="gps-search-container">
                            <input type="text" name="placeGeo[]" id="${gpsId}" placeholder="48.8656 2.3081">
                            <button type="button" class="gps-search-btn" onclick="searchGPSForPlace('${gpsId}', '${nameId}')">üåç GPS</button>
                            <div id="${gpsId}Results" class="gps-results"></div>
                        </div>
                    </div>
                    <div></div>
                </div>
            `;
            container.appendChild(placeDiv);
        }

        function removePlace(button) {
            button.parentNode.remove();
        }

        function generateTEI() {
            const formData = collectFormData();
            const teiXml = buildTEIHeader(formData);
            document.getElementById('output').textContent = teiXml;
            document.getElementById('output').style.display = 'block';
            document.getElementById('copyBtn').style.display = 'inline-block';
        }

        function collectFormData() {
            const data = {
                letterTitleFr: document.getElementById('letterTitleFr').value,
                letterTitleEn: document.getElementById('letterTitleEn').value,
                titleLangFr: document.getElementById('titleLangFr').value,
                titleLangEn: document.getElementById('titleLangEn').value,
                transcriber: document.getElementById('transcriber').value,
                transcriberOrcid: document.getElementById('transcriberOrcid').value,
                spaId: document.getElementById('spaId').value,
                editionDate: document.getElementById('editionDate').value,
                summaryFr: document.getElementById('summaryFr').value,
                summaryEn: document.getElementById('summaryEn').value,
                incipit: document.getElementById('incipit').value,
                letterLang: document.getElementById('letterLang').value,
                senderName: document.getElementById('senderName').value,
                senderRef: document.getElementById('senderRef').value,
                senderViaf: document.getElementById('senderViaf').value,
                senderAddress: document.getElementById('senderAddress').value,
                senderStreet: document.getElementById('senderStreet').value,
                senderCity: document.getElementById('senderCity').value,
                senderCountry: document.getElementById('senderCountry').value,
                senderGeo: document.getElementById('senderGeo').value,
                sentDate: document.getElementById('sentDate').value,
                sentDateDisplay: document.getElementById('sentDateDisplay').value,
                recipientName: document.getElementById('recipientName').value,
                recipientRef: document.getElementById('recipientRef').value,
                recipientViaf: document.getElementById('recipientViaf').value,
                receivedDate: document.getElementById('receivedDate').value,
                country: document.getElementById('country').value,
                settlement: document.getElementById('settlement').value,
                repository: document.getElementById('repository').value,
                boxId: document.getElementById('boxId').value,
                pages: document.getElementById('pages').value,
                supportType: document.getElementById('supportType').value,
                formType: document.getElementById('formType').value,
                provenance: document.getElementById('provenance').value,
                facsimile1: document.getElementById('facsimile1').value,
                facsimile2: document.getElementById('facsimile2').value,
                holdingGeo: document.getElementById('holdingGeo').value
            };

            // R√©cup√©rer les personnes
            const personNames = document.querySelectorAll('input[name="personName[]"]');
            const personRefs = document.querySelectorAll('input[name="personRef[]"]');
            const personViafs = document.querySelectorAll('input[name="personViaf[]"]');
            
            data.people = [];
            for (let i = 0; i < personNames.length; i++) {
                if (personNames[i].value) {
                    data.people.push({
                        name: personNames[i].value,
                        ref: personRefs[i].value,
                        viaf: personViafs[i].value
                    });
                }
            }

            // R√©cup√©rer les lieux
            const placeNames = document.querySelectorAll('input[name="placeName[]"]');
            const placeRefs = document.querySelectorAll('input[name="placeRef[]"]');
            const placeGeos = document.querySelectorAll('input[name="placeGeo[]"]');
            
            data.places = [];
            for (let i = 0; i < placeNames.length; i++) {
                if (placeNames[i].value) {
                    data.places.push({
                        name: placeNames[i].value,
                        ref: placeRefs[i].value,
                        geo: placeGeos[i].value
                    });
                }
            }

            // R√©cup√©rer les ≈ìuvres
            const workTitles = document.querySelectorAll('input[name="workTitle[]"]');
            const workRefs = document.querySelectorAll('input[name="workRef[]"]');
            const workComposers = document.querySelectorAll('input[name="workComposer[]"]');
            const workDates = document.querySelectorAll('input[name="workDate[]"]');
            const workViafs = document.querySelectorAll('input[name="workViaf[]"]');
            const workOpuses = document.querySelectorAll('input[name="workOpus[]"]');
            const workDescriptions = document.querySelectorAll('textarea[name="workDescription[]"]');
            const workTypes = document.querySelectorAll('input[name="workType[]"]');
            
            data.works = [];
            for (let i = 0; i < workTitles.length; i++) {
                if (workTitles[i].value) {
                    data.works.push({
                        title: workTitles[i].value,
                        ref: workRefs[i].value,
                        composer: workComposers[i].value,
                        date: workDates[i].value,
                        viaf: workViafs[i].value,
                        opus: workOpuses[i].value,
                        description: workDescriptions[i].value,
                        type: workTypes[i].value
                    });
                }
            }

            // Ajouter les donn√©es Prima XML si disponibles
            if (primaXMLData) {
                data.primaXML = primaXMLData;
                data.primaEntities = primaEntities;
            }

            return data;
        }

        function buildTEIHeader(data) {
            const currentDate = new Date().toISOString().split('T')[0];
            const editionDate = data.editionDate || currentDate;
            const editionDateFr = new Date(editionDate).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
            const sentDateFr = data.sentDate ? new Date(data.sentDate).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' }) : '';
            const receivedDateFr = data.receivedDate ? new Date(data.receivedDate).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' }) : '';
            
            // G√©n√©rer le body TEI avec Prima XML si disponible
            const teiBody = data.primaXML ? generateTEIBodyFromPrima(data.primaXML) : generateDefaultTEIBody();
            
            return `<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="http://www.tei-c.org/release/xml/tei/custom/schema/relaxng/tei_all.rng" type="application/xml" schematypens="http://relaxng.org/ns/structure/1.0"?>
<?xml-model href="http://www.tei-c.org/release/xml/tei/custom/schema/relaxng/tei_all.rng" type="application/xml"
    schematypens="http://purl.oclc.org/dsdl/schematron"?>
<TEI xmlns="http://www.tei-c.org/ns/1.0">
   <teiHeader>
      <fileDesc>
         <titleStmt>
            <title level="s" xml:lang="en" type="main">Proko24, Digital Edition</title>
            <title level="s" xml:lang="fr" type="trl">Proko24, √âdition Num√©rique</title>
            <title level="a" xml:lang="${data.titleLangFr}" type="sub">${data.letterTitleFr}</title>
            <title level="a" xml:lang="${data.titleLangEn}" type="sub">${data.letterTitleEn}</title>
            <author ref="#NclsMrn" role="aut">${data.transcriber}</author>
            <editor role="transcriber" ref="#NclsMrn">${data.transcriber}</editor>
         </titleStmt>
         <editionStmt>
            <edition n="1">Premi√®re transcription et √©dition - Version du ${editionDateFr}</edition>
         </editionStmt>
         <publicationStmt>
            <publisher>
               <n>Prokorresp</n>
            </publisher>
            <date when="${new Date().getFullYear()}">${new Date().getFullYear()}</date>
            <idno type="SPArchive_ID">${data.spaId}</idno>
            <availability status="restricted">
               <licence target="https://creativecommons.org/licenses/by-nc-sa/4.0/"
                  rend="translation">Translation Rights</licence>
               <licence target="https://creativecommons.org/licenses/by-nc-sa/4.0/"
                  rend="reproduction">Reproduction Rights</licence>
               <licence target="https://creativecommons.org/licenses/by-nc-sa/4.0/" rend="access"
                  >Accessibility Rights</licence>
               <p>The digitized letter is available for educational and research purposes,
                  accessible upon request to qualified individuals or institutions.</p>
            </availability>
         </publicationStmt>
         <notesStmt>
            <note type="summary" xml:lang="fr">${data.summaryFr}</note>
            <note type="incipit">${data.incipit}</note>
            <note type="summary" xml:lang="en">${data.summaryEn}</note>
         </notesStmt>
         <sourceDesc>
            <msDesc>
               <msIdentifier>
                  <country>${data.country}</country>
                  <settlement>${data.settlement}</settlement>
                  <repository>${data.repository}</repository>
                  <idno type="Box">${data.boxId}</idno>
                  <idno type="SPA_ID">${data.spaId}</idno>
               </msIdentifier>
               <msContents>
                  <msItem>
                     <title xml:lang="fr">Lettre de ${data.senderName.split(',').reverse().join(' ')} √† ${data.recipientName.split(',').reverse().join(' ')}</title>
                     <title xml:lang="en">Letter from ${data.senderName.split(',').reverse().join(' ')} to ${data.recipientName.split(',').reverse().join(' ')}</title>
                     <docAuthor ref="#${data.senderRef}">
                        <persName>${data.senderName}</persName>
                     </docAuthor>
                  </msItem>
               </msContents>
               <physDesc>
                  <objectDesc form="${data.formType}">
                     <supportDesc>
                        <support>
                           <p>${data.supportType}</p>
                        </support>
                        <extent>
                           <measure unit="pages">${data.pages}</measure>
                        </extent>
                     </supportDesc>
                  </objectDesc>
                  <handDesc>
                     <handNote xml:id="${data.senderRef}Hand" scribeRef="#${data.senderRef}">√âcriture de ${data.senderName.split(',').reverse().join(' ')},
                        √† l'encre noire</handNote>
                     <handNote xml:id="${data.recipientRef}Hand" scribeRef="#${data.recipientRef}">Annotations de ${data.recipientName.split(',').reverse().join(' ')}, au
                        crayon</handNote>
                  </handDesc>
               </physDesc>
               <history>
                  <provenance>${data.provenance}</provenance>
               </history>
            </msDesc>
            <listPlace>
               <place xml:id="Sender_Address">
                  <placeName>${data.senderAddress}</placeName>
                  <location>
                     <geo>${data.senderGeo}</geo>
                  </location>
               </place>
               <place xml:id="Recipient_Address">
                  <placeName>Unknown</placeName>
                  <location>
                     <geo>Unknown</geo>
                  </location>
               </place>
               <place xml:id="Holding_place">
                  <placeName>${data.repository}</placeName>
                  <location>
                     <geo>${data.holdingGeo}</geo>
                  </location>
               </place>${data.places.map(place => `
               <place xml:id="${place.ref}">
                  <placeName>${place.name}</placeName>
                  <location>
                     <geo>${place.geo}</geo>
                  </location>
               </place>`).join('')}
            </listPlace>
         </sourceDesc>
      </fileDesc>
      <encodingDesc>
         <projectDesc>
            <p>Prokofiev 1924, Complete correspondence</p>
         </projectDesc>
         <editorialDecl>
            <p>Transcription and coding follows the Editorial Guidelines of Proko24</p>
         </editorialDecl>
         <tagsDecl partial="false">
            <rendition xml:id="pencil" scheme="css">
               <label>Texte ajout√© au crayon</label>
            </rendition>
            <rendition xml:id="encircled" scheme="css">
               <label>Texte entour√©</label>
            </rendition>
            <rendition xml:id="topLeft" scheme="css">
               <label>Positionn√© en haut √† gauche</label>
            </rendition>
            <rendition xml:id="topRight" scheme="css">
               <label>Positionn√© en haut √† droite</label>
            </rendition>
            <namespace name="http://www.tei-c.org/ns/1.0">
               <tagUsage gi="add"
                  ana="Texte ajout√© par une autre main, souvent une annotation ou une correction."/>
               <tagUsage gi="persName" ana="Noms de personnes r√©f√©renc√©es dans le texte."/>
               <tagUsage gi="placeName" ana="Noms de lieux mentionn√©s ou pertinents pour le texte."/>
               <tagUsage gi="handNote" ana="Description de l'√©criture d'un scribe ou annotateur."/>
               <tagUsage gi="note"
                  ana="Notes ajout√©es pour fournir des informations suppl√©mentaires telles que des r√©sum√©s, des incipits ou des r√©f√©rences."/>
               <tagUsage gi="ref"
                  ana="R√©f√©rence √† une ressource externe ou √† une cible interne au document."/>
               <tagUsage gi="title" ana="Titres d'≈ìuvres ou de sections au sein du document."/>
               <tagUsage gi="date"
                  ana="Dates indiqu√©es dans le texte, soit du document original, soit en tant qu'annotations."/>
               <tagUsage gi="measure"
                  ana="Mesures, pour indiquer l'√©tendue physique, telle que le nombre de pages."/>
            </namespace>
         </tagsDecl>
         <classDecl>
            <taxonomy xml:id="noteTypes">
               <category xml:id="handwritten">
                  <catDesc>Annotations manuscrites</catDesc>
               </category>
               <category xml:id="editorial">
                  <catDesc>Notes √©ditoriales ajout√©es par l'√©diteur</catDesc>
               </category>
               <category xml:id="explanatory">
                  <catDesc>Notes explicatives apportant des clarifications</catDesc>
               </category>
               <category xml:id="layout">
                  <catDesc>Informations de mise en page</catDesc>
               </category>
               <category xml:id="summary">
                  <catDesc>R√©summ√© du contenu de la lettre</catDesc>
               </category>
               <category xml:id="incipit">
                  <catDesc>Incipit de la lettre</catDesc>
               </category>
               <category xml:id="Work">
                  <catDesc>Identifie une oeuvre</catDesc>
               </category>
            </taxonomy>
         </classDecl>
      </encodingDesc>
      <profileDesc>
         <langUsage>
            <language ident="${data.letterLang}">French</language>
         </langUsage>
         <correspDesc>
            <correspAction type="sent">
               <persName ref="#${data.senderRef}">${data.senderName}</persName>
               <address>
                  <street>${data.senderStreet || data.senderAddress.split(',')[0]}</street>
                  <settlement>${data.senderCity || data.senderAddress.split(',')[1]?.trim()}</settlement>
                  <country>${data.senderCountry}</country>
               </address>
               <location>
                  <geo>${data.senderGeo}</geo>
               </location>
               <date when="${data.sentDate}">${sentDateFr}</date>
            </correspAction>
            <correspAction type="received">
               <persName ref="#${data.recipientRef}">${data.recipientName}</persName>
               ${data.receivedDate ? `<date when="${data.receivedDate}">${receivedDateFr}</date>` : ''}
            </correspAction>
         </correspDesc>
         <particDesc>
            <listPerson>
               <person xml:id="${data.recipientRef}">
                  <persName>${data.recipientName}</persName>
                  ${data.recipientViaf ? `<idno type="VIAF">${data.recipientViaf}</idno>` : ''}
               </person>
               <person xml:id="${data.senderRef}">
                  <persName>${data.senderName}</persName>
                  ${data.senderViaf ? `<idno type="VIAF">${data.senderViaf}</idno>` : ''}
               </person>${data.people.map(person => `
               <person xml:id="${person.ref}">
                  <persName>${person.name}</persName>
                  ${person.viaf ? `<idno type="VIAF">${person.viaf}</idno>` : ''}
               </person>`).join('')}
               <person xml:id="NclsMrn">
                  <persName>${data.transcriber}</persName>
                  <idno type="ORCID">${data.transcriberOrcid}</idno>
               </person>
            </listPerson>
         </particDesc>
         <settingDesc>
            <listPlace>
               <place xml:id="Sender_Address">
                  <placeName>${data.senderAddress}</placeName>
                  <location>
                     <geo>${data.senderGeo}</geo>
                  </location>
               </place>
               <place xml:id="Recipient_Address">
                  <placeName>Unknown</placeName>
                  <location>
                     <geo>Unknown</geo>
                  </location>
               </place>
               <place xml:id="Holding_place">
                  <placeName>${data.repository}</placeName>
                  <location>
                     <geo>${data.holdingGeo}</geo>
                  </location>
               </place>${data.places.map(place => `
               <place xml:id="${place.ref}">
                  <placeName>${place.name}</placeName>
                  <location>
                     <geo>${place.geo}</geo>
                  </location>
               </place>`).join('')}
            </listPlace>
         </settingDesc>
         ${data.works && data.works.length > 0 ? `
         <textClass>
            <listBibl>
               <head>≈íuvres mentionn√©es</head>${data.works.map(work => `
               <bibl xml:id="${work.ref}" type="${work.type}">
                  <title>${work.title}</title>
                  ${work.composer ? `<author>${work.composer}</author>` : ''}
                  ${work.date ? `<date>${work.date}</date>` : ''}
                  ${work.opus ? `<biblScope unit="opus">${work.opus}</biblScope>` : ''}
                  ${work.viaf ? `<idno type="VIAF">${work.viaf}</idno>` : ''}
                  ${work.description ? `<note>${work.description}</note>` : ''}
               </bibl>`).join('')}
            </listBibl>
         </textClass>` : ''}
      </profileDesc>
      <revisionDesc>
         <listChange type="research">
            <change when="${editionDate}" who="#NclsMrn">Encodage TEI initial apr√®s transcription et
               √©tude du contexte historique.</change>
         </listChange>
         <listChange type="publication">
            <change when="${editionDate}" who="#NclsMrn">Affinage de l'encodage TEI bas√© sur les mod√®les
               de WeGA, avec l'assistance du GPT Grimoire, de ProKorresp, un GPT personnel d√©velopp√©
               sur ChatGPT, et les recommandations du consortium Cahier
               (https://cahier.hypotheses.org/).</change>
         </listChange>
      </revisionDesc>
   </teiHeader>
   <facsimile>${data.facsimile1 ? `
      <graphic n="1" xml:id="${data.spaId}_1"
         url="${data.facsimile1}"/>` : ''}${data.facsimile2 ? `
      <graphic n="2" xml:id="${data.spaId}_2"
         url="${data.facsimile2}"/>` : ''}
   </facsimile>
   <text type="letter">
      <body>
         <div type="letter" xml:id="${data.spaId}" hand="#${data.senderRef}Hand">
            <opener>
               <address rend="topLeft">
                  <addrLine>${data.senderStreet || data.senderAddress.split(',')[0]}.</addrLine>
               </address>
               <dateline rend="topRight">
                  <date when="${data.sentDate}">${data.sentDateDisplay || data.senderCity + ', ' + sentDateFr}.</date>
               </dateline>
               <salute>Cher monsieur,</salute>
            </opener>
            ${teiBody}
         </div>
      </body>
   </text>
</TEI>`;
        }

        function generateTEIBodyFromPrima(xmlDoc) {
            let teiBody = '';
            const regions = xmlDoc.querySelectorAll('TextRegion');
            
            regions.forEach((region, regionIndex) => {
                teiBody += `\n            <div type="region" n="${regionIndex + 1}">`;
                
                const lines = region.querySelectorAll('TextLine');
                lines.forEach((line, lineIndex) => {
                    teiBody += `\n               <l n="${lineIndex + 1}">`;
                    
                    const words = line.querySelectorAll('Word');
                    let processedText = '';
                    
                    words.forEach(word => {
                        const wordText = word.querySelector('TextEquiv Unicode');
                        const text = wordText ? wordText.textContent : '';
                        const customAttr = word.getAttribute('custom');
                        
                        if (customAttr) {
                            const tags = parsePrimaCustomTags(customAttr);
                            tags.forEach(tag => {
                                const mappedElement = primaMappingRules[tag.type] || tag.type;
                                processedText += `<${mappedElement}>${text}</${mappedElement}> `;
                            });
                        } else {
                            processedText += text + ' ';
                        }
                    });
                    
                    teiBody += processedText.trim();
                    teiBody += '</l>';
                });
                
                teiBody += '\n            </div>';
            });
            
            return teiBody + '\n         ';
        }

        function generateDefaultTEIBody() {
            return `\n            <!-- Le contenu de la lettre sera transcrit ici -->
            <p>Contenu de la lettre √† transcrire</p>
         `;
        }

        // Fonctions de recherche VIAF
        async function searchViaf(inputId, searchTerm) {
            if (!searchTerm || searchTerm.trim().length < 3) {
                showViafError(inputId + 'Results', 'Veuillez saisir au moins 3 caract√®res');
                return;
            }

            const resultsContainer = document.getElementById(inputId + 'Results');
            const searchBtn = document.querySelector(`[onclick*="${inputId}"]`);
            
            // Annuler la recherche pr√©c√©dente
            if (activeViafSearch) {
                activeViafSearch.abort();
            }

            // V√©rifier le cache
            const cacheKey = searchTerm.toLowerCase().trim();
            if (viafCache.has(cacheKey)) {
                displayViafResults(inputId, viafCache.get(cacheKey));
                return;
            }

            // Afficher le loading
            showViafLoading(resultsContainer);
            searchBtn.innerHTML = '‚è≥ Recherche...';

            try {
                activeViafSearch = new AbortController();
                
                // Utiliser l'API VIAF AutoSuggest
                const encodedQuery = encodeURIComponent(searchTerm);
                const url = `https://viaf.org/viaf/AutoSuggest?query=${encodedQuery}`;
                
                const response = await fetch(url, {
                    signal: activeViafSearch.signal,
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erreur VIAF: ${response.status}`);
                }

                const data = await response.json();
                
                // Parser les r√©sultats VIAF
                const results = parseViafResults(data);
                
                // Mettre en cache
                viafCache.set(cacheKey, results);
                
                // Afficher les r√©sultats
                displayViafResults(inputId, results);
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Erreur recherche VIAF:', error);
                    showViafError(inputId + 'Results', 'Erreur lors de la recherche VIAF');
                }
            } finally {
                searchBtn.innerHTML = 'üîç VIAF';
                activeViafSearch = null;
            }
        }

        function parseViafResults(data) {
            const results = [];
            
            if (data && data.result) {
                data.result.forEach(item => {
                    if (item.viafid && item.term) {
                        results.push({
                            id: item.viafid,
                            name: item.term,
                            details: item.nametype || 'Personal',
                            sources: item.source || []
                        });
                    }
                });
            }
            
            return results.slice(0, 10); // Limiter √† 10 r√©sultats
        }

        function showViafLoading(container) {
            container.innerHTML = '<div class="viaf-loading">üîç Recherche en cours...</div>';
            container.style.display = 'block';
        }

        function showViafError(containerId, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="viaf-error">‚ùå ${message}</div>`;
            container.style.display = 'block';
            
            setTimeout(() => {
                container.style.display = 'none';
            }, 3000);
        }

        function displayViafResults(inputId, results) {
            const container = document.getElementById(inputId + 'Results');
            
            if (!results || results.length === 0) {
                container.innerHTML = '<div class="viaf-no-results">Aucun r√©sultat trouv√©</div>';
                container.style.display = 'block';
                setTimeout(() => {
                    container.style.display = 'none';
                }, 3000);
                return;
            }

            let html = '';
            results.forEach((result, index) => {
                html += `
                    <div class="viaf-result-item" onclick="selectViafResult('${inputId}', '${result.id}', '${result.name.replace(/'/g, "\\'")}')">
                        <div class="viaf-result-name">${result.name}</div>
                        <div class="viaf-result-details">${result.details}</div>
                        <div class="viaf-result-id">VIAF: ${result.id}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
            container.style.display = 'block';

            // Fermer au clic √† l'ext√©rieur
            document.addEventListener('click', function closeViafResults(e) {
                if (!container.contains(e.target) && !e.target.closest('.viaf-search-btn')) {
                    container.style.display = 'none';
                    document.removeEventListener('click', closeViafResults);
                }
            });
        }

        function selectViafResult(inputId, viafId, name) {
            const input = document.getElementById(inputId);
            const container = document.getElementById(inputId + 'Results');
            
            // Remplir le champ VIAF ID
            input.value = viafId;
            input.classList.add('viaf-filled-field');
            
            // Fermer les r√©sultats
            container.style.display = 'none';
            
            // Ajouter un indicateur visuel
            setTimeout(() => {
                input.classList.remove('viaf-filled-field');
            }, 3000);
            
            // Notification
            showViafSuccess(`VIAF ID trouv√©: ${viafId} pour "${name}"`);
        }

        function searchViafForPerson(viafInputId, nameInputId) {
            const nameInput = document.getElementById(nameInputId);
            if (nameInput && nameInput.value) {
                searchViaf(viafInputId, nameInput.value);
            } else {
                showViafError(viafInputId + 'Results', 'Veuillez d\'abord saisir un nom');
            }
        }

        function showViafSuccess(message) {
            // Cr√©er une notification temporaire
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #7c3aed;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 1000;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = '‚úÖ ' + message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Ajouter les animations CSS pour les notifications
        if (!document.getElementById('viafAnimations')) {
            const style = document.createElement('style');
            style.id = 'viafAnimations';
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }

        function copyToClipboard() {
            const output = document.getElementById('output');
            navigator.clipboard.writeText(output.textContent).then(() => {
                const btn = document.getElementById('copyBtn');
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copi√© !';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        // Fermer les modals en cliquant √† l'ext√©rieur
        window.onclick = function(event) {
            const catalogueModal = document.getElementById('catalogueModal');
            const transcriptionModal = document.getElementById('transcriptionModal');
            const primaModal = document.getElementById('primaModal');
            
            if (event.target === catalogueModal) {
                catalogueModal.style.display = 'none';
            }
            if (event.target === transcriptionModal) {
                transcriptionModal.style.display = 'none';
            }
            if (event.target === primaModal) {
                primaModal.style.display = 'none';
            }
        };

        // Initialisation
        window.onload = function() {
            updateProgressBar();
            
            // Remplir la date d'√©dition avec la date actuelle
            document.getElementById('editionDate').value = new Date().toISOString().split('T')[0];
            
            // Initialiser les valeurs par d√©faut
            document.getElementById('recipientName').value = 'Prokofiev, Sergei';
            document.getElementById('recipientRef').value = 'SSP';
            document.getElementById('recipientViaf').value = '71579098';
            
            // Ajouter les event listeners pour la d√©tection de changements
            document.getElementById('senderName').addEventListener('input', updateLetterTitles);
            document.getElementById('recipientName').addEventListener('input', updateLetterTitles);
            document.getElementById('senderCity').addEventListener('input', suggestDateFormat);
            
            // Event listeners pour la recherche VIAF automatique
            document.getElementById('senderName').addEventListener('blur', function() {
                if (this.value && !document.getElementById('senderViaf').value) {
                    setTimeout(() => searchViaf('senderViaf', this.value), 500);
                }
            });
            
            document.getElementById('recipientName').addEventListener('blur', function() {
                if (this.value && !document.getElementById('recipientViaf').value) {
                    setTimeout(() => searchViaf('recipientViaf', this.value), 500);
                }
            });

            // Event listeners pour la recherche GPS automatique
            document.getElementById('senderStreet').addEventListener('blur', function() {
                if (this.value && !document.getElementById('senderGeo').value) {
                    const fullAddress = getSenderFullAddress();
                    if (fullAddress.length > 5) {
                        setTimeout(() => searchGPS('senderGeo', fullAddress), 500);
                    }
                }
            });

            document.getElementById('senderCity').addEventListener('blur', function() {
                if (this.value && !document.getElementById('senderGeo').value) {
                    const fullAddress = getSenderFullAddress();
                    if (fullAddress.length > 5) {
                        setTimeout(() => searchGPS('senderGeo', fullAddress), 500);
                    }
                }
            });
        };
    </script>
</body>
</html>
