<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Manifests IIIF Nakala</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background-color: #f9fafb;
            line-height: 1.5;
        }
        
        .container {
            max-width: 768px;
            margin: 0 auto;
            padding: 1rem;
            background-color: white;
            min-height: 100vh;
        }
        
        .title {
            font-size: 1.25rem;
            font-weight: 500;
            color: #111827;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .upload-section {
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background-color: white;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
        }
        
        .upload-area {
            text-align: center;
        }
        
        .upload-icon {
            margin: 0 auto 0.75rem;
            width: 1.5rem;
            height: 1.5rem;
            color: #9ca3af;
        }
        
        .upload-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
        }
        
        .btn-primary:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
        }
        
        .btn-success {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #2563eb;
        }
        
        .btn-purple {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-purple:hover {
            background-color: #2563eb;
        }
        
        .btn-green {
            background-color: #3b82f6;
            color: white;
            padding: 0.25rem;
        }
        
        .btn-green:hover {
            background-color: #2563eb;
        }
        
        .btn-red {
            color: #ef4444;
            background: none;
            border: none;
            padding: 0.25rem;
        }
        
        .btn-red:hover {
            color: #dc2626;
        }
        
        .success-message {
            color: #059669;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .form-section {
            background-color: white;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 0.75rem;
        }
        
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
        }
        
        .form-input {
            width: 100%;
            padding: 0.5rem;
            font-size: 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 1px #3b82f6;
        }
        
        .form-input.valid {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        
        .form-input.invalid {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        
        .input-wrapper {
            position: relative;
        }
        
        .input-icons {
            position: absolute;
            right: 0.5rem;
            top: 0.5rem;
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }
        
        .icon {
            width: 1rem;
            height: 1rem;
        }
        
        .icon-success {
            color: #10b981;
        }
        
        .icon-error {
            color: #ef4444;
        }
        
        .icon-link {
            color: #3b82f6;
            cursor: pointer;
        }
        
        .icon-link:hover {
            color: #2563eb;
        }
        
        .error-message {
            color: #ef4444;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
        
        .section-title {
            font-size: 1rem;
            font-weight: 500;
            color: #111827;
            margin-bottom: 0.75rem;
        }
        
        .pages-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        
        .pages-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .page-card {
            padding: 0.75rem;
            background-color: #f9fafb;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
            margin-bottom: 0.75rem;
        }
        
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        
        .page-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .spinner {
            width: 0.75rem;
            height: 0.75rem;
            border: 2px solid #3b82f6;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .dimensions-input {
            display: flex;
            gap: 0.5rem;
        }
        
        .dimensions-input input {
            flex: 1;
        }
        
        .dimensions-help {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        
        .generate-section {
            padding-top: 1rem;
            margin-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .generate-btn {
            width: 100%;
            background-color: #2563eb;
            color: white;
            font-weight: 500;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .generate-btn:hover {
            background-color: #1d4ed8;
        }
        
        .generate-btn:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
        }
        
        .preview-section {
            background-color: white;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
            padding: 1rem;
        }
        
        .preview-title {
            font-size: 1rem;
            font-weight: 500;
            color: #111827;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .preview-content {
            background-color: #f9fafb;
            padding: 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
            font-size: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .preview-json {
            overflow-x: auto;
            max-height: 20rem;
            color: #374151;
            white-space: pre;
            font-family: 'Courier New', monospace;
        }
        
        .download-btn {
            width: 100%;
            background-color: #3b82f6;
            color: white;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .download-btn:hover {
            background-color: #2563eb;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .pages-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .title {
                font-size: 1.1rem;
            }
        }

        .drag-drop-zone {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .drag-drop-zone:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }

        .drag-drop-zone.drag-over {
            border-color: #10b981;
            background-color: #f0fdf4;
        }

        .github-section {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .github-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin: 1rem 0;
        }

        .github-config .form-group {
            margin-bottom: 0.5rem;
        }

        .github-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .github-status {
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            margin: 0.5rem 0;
        }

        .github-status.success {
            background-color: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .github-status.error {
            background-color: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .github-url {
            background-color: #f1f5f9;
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-family: monospace;
            font-size: 0.875rem;
            word-break: break-all;
            margin: 0.5rem 0;
        }

        .dark-mode .github-section {
            background-color: #4b5563;
            border-color: #6b7280;
        }

        .dark-mode .github-url {
            background-color: #6b7280;
            color: #f9fafb;
        }

        .dark-mode .github-status.success {
            background-color: #065f46;
            color: #dcfce7;
            border-color: #10b981;
        }

        .dark-mode .github-status.error {
            background-color: #7f1d1d;
            color: #fecaca;
            border-color: #ef4444;
        }

        .recovery-banner {
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .recovery-actions {
            display: flex;
            gap: 0.5rem;
        }

        .recovery-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .recovery-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .autosave-indicator {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: #10b981;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .autosave-indicator.show {
            opacity: 1;
        }

        .autosave-indicator.saving {
            background: #f59e0b;
        }

        .work-session-info {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: #64748b;
        }

        .dark-mode .work-session-info {
            background-color: #4b5563;
            border-color: #6b7280;
            color: #d1d5db;
        }

        /* Mode sombre */
        body.dark-mode {
            background-color: #1f2937;
            color: #f9fafb;
        }

        .dark-mode .container {
            background-color: #1f2937;
        }

        .dark-mode .upload-section,
        .dark-mode .form-section,
        .dark-mode .preview-section {
            background-color: #374151;
            border-color: #4b5563;
        }

        .dark-mode .page-card {
            background-color: #4b5563;
            border-color: #6b7280;
        }

        .dark-mode .form-input {
            background-color: #374151;
            border-color: #6b7280;
            color: #f9fafb;
        }

        .dark-mode .form-input:focus {
            border-color: #3b82f6;
        }

        .dark-mode .form-input.valid {
            border-color: #10b981;
            background-color: #065f46;
        }

        .dark-mode .form-input.invalid {
            border-color: #ef4444;
            background-color: #7f1d1d;
        }

        .dark-mode .drag-drop-zone {
            border-color: #6b7280;
            background-color: #374151;
        }

        .dark-mode .drag-drop-zone:hover {
            border-color: #3b82f6;
            background-color: #4b5563;
        }

        .dark-mode .drag-drop-zone.drag-over {
            border-color: #10b981;
            background-color: #065f46;
        }

        .dark-mode .title,
        .dark-mode .section-title,
        .dark-mode .form-label,
        .dark-mode .page-title,
        .dark-mode .preview-title {
            color: #f9fafb;
        }

        .dark-mode .preview-content {
            background-color: #4b5563;
            border-color: #6b7280;
        }

        .dark-mode .preview-json {
            color: #e5e7eb;
        }

        .theme-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: #2563eb;
            transform: scale(1.1);
        }

        .dark-mode .theme-toggle {
            background: #fbbf24;
            color: #1f2937;
        }

        .dark-mode .theme-toggle:hover {
            background: #f59e0b;
        }

        /* Icônes SVG simples */
        .icon-upload::before { content: "📁"; }
        .icon-plus::before { content: "➕"; }
        .icon-minus::before { content: "➖"; }
        .icon-file::before { content: "📄"; }
        .icon-external::before { content: "🔗"; }
        .icon-check::before { content: "✅"; }
        .icon-alert::before { content: "⚠️"; }
        .icon-download::before { content: "💾"; }
    </style>
</head>
<body class="dark-mode">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef } = React;

        // Composants d'icônes simples
        const Upload = () => React.createElement('span', { className: 'icon-upload' });
        const Plus = () => React.createElement('span', { className: 'icon-plus' });
        const Minus = () => React.createElement('span', { className: 'icon-minus' });
        const FileText = () => React.createElement('span', { className: 'icon-file' });
        const ExternalLink = () => React.createElement('span', { className: 'icon-external' });
        const CheckCircle = () => React.createElement('span', { className: 'icon-check' });
        const AlertCircle = () => React.createElement('span', { className: 'icon-alert' });
        const Download = () => React.createElement('span', { className: 'icon-download' });

        const parseCombined = (input) => {
            const parts = input.trim().split('/');
            const hash = parts.pop();
            const doi = parts.join('/');
            return { doi, hash };
        };

        const IIIFManifestGenerator = () => {
            const [csvData, setCsvData] = useState([]);
            const [selectedLetter, setSelectedLetter] = useState('');
            const [manifestData, setManifestData] = useState({
                doi: '',
                letterId: '',
                title: '',
                creator: '',
                dateIssued: '',
                attribution: 'Nicolas Moron / NAKALA',
                license: 'http://creativecommons.org/licenses/by-nc/4.0/',
                pages: [
                    { hash: '', width: 2692, height: 3430, loading: false, validated: false, error: null, dimensionsInput: '', combinedId: ''}
                ]
            });
            const [generatedManifest, setGeneratedManifest] = useState('');
            const [isGenerating, setIsGenerating] = useState(false);
            const [combined, setCombined] = useState('');
            const [dragOver, setDragOver] = useState(false);
            const [darkMode, setDarkMode] = useState(true);
            const [manifestValidation, setManifestValidation] = useState(null);
            const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
            const [lastSaved, setLastSaved] = useState(null);
            const [showRecoveryBanner, setShowRecoveryBanner] = useState(false);
            const [showSaveModal, setShowSaveModal] = useState(false);
            const [saveName, setSaveName] = useState('');
            const [savedSessions, setSavedSessions] = useState([]);
            const [showLoadModal, setShowLoadModal] = useState(false);
            const [githubConfig, setGithubConfig] = useState({
                enabled: false,
                username: '',
                repository: '',
                token: '',
                branch: 'main',
                path: 'manifests'
            });
            const [showGithubConfig, setShowGithubConfig] = useState(false);
            const [lastPushedFile, setLastPushedFile] = useState(null);
            const [transkribusCollectionId, setTranskribusCollectionId] = useState('190656');
            const fileInputRef = useRef(null);

            const validateDoi = (doi) => {
                const doiRegex = /^10\.\d{4,}\/.*$/;
                return doiRegex.test(doi);
            };

            const validateHash = (hash) => {
                const hashRegex = /^[a-f0-9]{40}$/i;
                return hashRegex.test(hash);
            };

            const validateIIIFManifest = (manifest) => {
                const errors = [];
                const warnings = [];

                if (!manifest['@context']) errors.push('Le champ @context est requis');
                if (!manifest['@id']) errors.push('Le champ @id est requis');
                if (!manifest['@type']) errors.push('Le champ @type est requis');
                if (!manifest.label) warnings.push('Le champ label est recommandé');

                if (!manifest.sequences || manifest.sequences.length === 0) {
                    errors.push('Au moins une séquence est requise');
                } else {
                    manifest.sequences.forEach((seq, index) => {
                        if (!seq.canvases || seq.canvases.length === 0) {
                            errors.push(`La séquence ${index + 1} doit contenir au moins un canvas`);
                        }
                    });
                }

                if (manifest.sequences && manifest.sequences[0] && manifest.sequences[0].canvases) {
                    manifest.sequences[0].canvases.forEach((canvas, index) => {
                        if (!canvas.width || !canvas.height) {
                            errors.push(`Canvas ${index + 1}: largeur et hauteur requises`);
                        }
                        if (canvas.width <= 0 || canvas.height <= 0) {
                            errors.push(`Canvas ${index + 1}: dimensions invalides`);
                        }
                    });
                }

                return { errors, warnings, isValid: errors.length === 0 };
            };

            const toggleDarkMode = () => {
                setDarkMode(!darkMode);
                document.body.classList.toggle('dark-mode');
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                setDragOver(true);
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                setDragOver(false);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                setDragOver(false);
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                        Papa.parse(file, {
                            header: true,
                            skipEmptyLines: true,
                            complete: (results) => {
                                const rows = results.data.map((row) => {
                                    const title = row['http://nakala.fr/terms#title'] || '';
                                    const match = title.match(/(SPA_\d+)/);
                                    return { ...row, letterId: match ? match[1] : '' };
                                });
                                setCsvData(rows);
                            }
                        });
                    } else {
                        alert('Veuillez déposer un fichier CSV');
                    }
                }
            };

            const handleCombinedChange = (e) => {
                const val = e.target.value;
                setCombined(val);

                if (val.includes('/')) {
                    try {
                        const { doi, hash } = parseCombined(val);
                        setManifestData(md => ({
                            ...md,
                            doi,
                            pages: md.pages.map((p, i) =>
                                i === 0 ? { ...p, hash, combinedId: val } : p
                            )
                        }));
                    } catch {
                        /* laisse l'utilisateur continuer à taper */
                    }
                }
            };

            const handlePageCombinedChange = (pageIndex, value) => {
                const newPages = [...manifestData.pages];
                newPages[pageIndex].combinedId = value;

                if (value.includes('/')) {
                    try {
                        const { doi, hash } = parseCombined(value);
                        
                        if (!manifestData.doi || manifestData.doi !== doi) {
                            setManifestData(prev => ({
                                ...prev,
                                doi: doi,
                                pages: newPages.map((p, i) => 
                                    i === pageIndex ? { ...p, hash, combinedId: value } : p
                                )
                            }));
                        } else {
                            newPages[pageIndex].hash = hash;
                            setManifestData({ ...manifestData, pages: newPages });
                        }
                    } catch {
                        setManifestData({ ...manifestData, pages: newPages });
                    }
                } else {
                    setManifestData({ ...manifestData, pages: newPages });
                }
            };

            const fetchImageDimensions = async (doi, hash) => {
                const infoUrl = `https://api.nakala.fr/iiif/${doi}/${hash}/info.json`;
                
                try {
                    const response = await fetch(infoUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return {
                            width: data.width,
                            height: data.height,
                            success: true
                        };
                    }
                } catch (error) {
                    console.log('Tentative directe échouée, utilisation du proxy:', error);
                }
                
                try {
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(infoUrl)}`;
                    const response = await fetch(proxyUrl);
                    
                    if (response.ok) {
                        const data = await response.json();
                        return {
                            width: data.width,
                            height: data.height,
                            success: true
                        };
                    }
                } catch (error) {
                    console.error('Erreur lors de la récupération des dimensions:', error);
                }
                
                return {
                    error: 'Impossible de récupérer les dimensions automatiquement',
                    success: false
                };
            };

            const fetchAllDimensions = async () => {
                if (!manifestData.doi) {
                    alert('Veuillez d\'abord saisir le DOI');
                    return;
                }

                const newPages = [...manifestData.pages];
                
                newPages.forEach(page => {
                    page.loading = true;
                    page.error = null;
                });
                setManifestData({ ...manifestData, pages: newPages });
                
                for (let i = 0; i < newPages.length; i++) {
                    const page = newPages[i];
                    
                    if (page.hash && validateHash(page.hash)) {
                        const result = await fetchImageDimensions(manifestData.doi, page.hash);

                        if (result.success) {
                            newPages[i] = {
                                ...page,
                                width: result.width,
                                height: result.height,
                                loading: false,
                                validated: true,
                                error: null
                            };
                        } else {
                            newPages[i] = {
                                ...page,
                                loading: false,
                                error: result.error || 'Erreur lors de la récupération'
                            };
                        }

                        setManifestData({ ...manifestData, pages: [...newPages] });
                        if (i < newPages.length - 1) await new Promise(r => setTimeout(r, 500));
                    } else {
                        newPages[i] = {
                            ...page,
                            loading: false,
                            error: 'Hash invalide'
                        };
                    }
                }
            };

            const openInfoUrl = (doi, hash) => {
                const infoUrl = `https://api.nakala.fr/iiif/${doi}/${hash}/info.json`;
                window.open(infoUrl, '_blank');
            };

            const openAllInfoUrls = () => {
                if (!manifestData.doi) {
                    alert('Veuillez d\'abord saisir le DOI');
                    return;
                }

                manifestData.pages.forEach((page, index) => {
                    if (page.hash && validateHash(page.hash)) {
                        setTimeout(() => {
                            openInfoUrl(manifestData.doi, page.hash);
                        }, index * 500);
                    }
                });

                alert(`${manifestData.pages.filter(p => p.hash && validateHash(p.hash)).length} onglets vont s'ouvrir. Copiez-collez les dimensions dans les champs ci-dessous.`);
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        const rows = results.data.map((row) => {
                            const title = row['http://nakala.fr/terms#title'] || '';
                            const match = title.match(/(SPA_\d+)/);
                            return { ...row, letterId: match ? match[1] : '' };
                        });
                        setCsvData(rows);
                    }
                });
            };

            const handleLetterSelect = (letterItem) => {
                const letterData = csvData.find(item => item['Linked in item'] === letterItem);
                if (!letterData) return;

                const letterId = letterData.letterId || 
                    (letterData['http://nakala.fr/terms#title']?.match(/(SPA_\d+)/)?.[1] ?? '');

                setManifestData({
                    ...manifestData,
                    letterId,
                    title: letterData['http://nakala.fr/terms#title'] || '',
                    creator: letterData['http://nakala.fr/terms#creator'] || '',
                    dateIssued: letterData['http://nakala.fr/terms#created'] || ''
                });
                setSelectedLetter(letterItem);
            };

            const addPage = () => {
                setManifestData({
                    ...manifestData,
                    pages: [...manifestData.pages, {
                        hash: '',
                        width: 2692,
                        height: 3430,
                        loading: false,
                        validated: false,
                        error: null,
                        dimensionsInput: '',
                        combinedId: ''
                    }]
                });
            };

            const removePage = (index) => {
                if (manifestData.pages.length > 1) {
                    const newPages = manifestData.pages.filter((_, i) => i !== index);
                    setManifestData({ ...manifestData, pages: newPages });
                }
            };

            const updatePage = (index, field, value) => {
                const newPages = [...manifestData.pages];
                newPages[index][field] = value;

                if (field === 'hash') {
                    newPages[index].validated = false;
                    newPages[index].error = null;
                }

                setManifestData({ ...manifestData, pages: newPages });
            };

            const parseDimensions = (input, pageIndex) => {
                if (!input.trim()) return;

                try {
                    const jsonData = JSON.parse(input);
                    if (jsonData.width && jsonData.height) {
                        updatePageDimensions(pageIndex, jsonData.width, jsonData.height);
                        return;
                    }
                } catch (e) {
                    // Si ce n'est pas du JSON, essayer d'autres formats
                }

                const dimensionRegex = /(\d+)[\s,x×](\d+)/;
                const match = input.match(dimensionRegex);
                if (match) {
                    const width = parseInt(match[1]);
                    const height = parseInt(match[2]);
                    updatePageDimensions(pageIndex, width, height);
                    return;
                }

                const numbers = input.match(/\d+/g);
                if (numbers && numbers.length >= 2) {
                    const width = parseInt(numbers[0]);
                    const height = parseInt(numbers[1]);
                    updatePageDimensions(pageIndex, width, height);
                }
            };

            const updatePageDimensions = (pageIndex, width, height) => {
                const newPages = [...manifestData.pages];
                newPages[pageIndex] = {
                    ...newPages[pageIndex],
                    width: width,
                    height: height,
                    validated: true,
                    error: null,
                    dimensionsInput: ''
                };
                setManifestData({ ...manifestData, pages: newPages });
            };

            const generateManifest = () => {
                setIsGenerating(true);

                setTimeout(() => {
                    const manifest = {
                        "@context": "http://iiif.io/api/presentation/2/context.json",
                        "@id": `https://nakala.fr/iiif/${manifestData.doi}/manifest`,
                        "@type": "sc:Manifest",
                        "label": manifestData.letterId,
                        "attribution": manifestData.attribution,
                        "license": manifestData.license,
                        "logo": "https://nakala.fr/logo/",
                        "metadata": [
                            {
                                "label": "Id",
                                "value": manifestData.letterId
                            },
                            {
                                "label": "Title",
                                "value": manifestData.title
                            },
                            {
                                "label": "Creator",
                                "value": manifestData.creator
                            },
                            {
                                "label": "Date Issued",
                                "value": manifestData.dateIssued
                            },
                            {
                                "label": "Type",
                                "value": "manuscript"
                            }
                        ],
                        "sequences": [
                            {
                                "@id": `https://nakala.fr/iiif/${manifestData.doi}/sequence/normal`,
                                "@type": "sc:Sequence",
                                "label": manifestData.letterId,
                                "viewingHint": "paged",
                                "startCanvas": `https://nakala.fr/iiif/${manifestData.doi}/canvas/page1`,
                                "canvases": manifestData.pages.map((page, index) => ({
                                    "@id": `https://nakala.fr/iiif/${manifestData.doi}/canvas/page${index + 1}`,
                                    "@type": "sc:Canvas",
                                    "label": `Page ${index + 1}`,
                                    "height": page.height,
                                    "width": page.width,
                                    "thumbnail": {
                                        "@id": `https://api.nakala.fr/iiif/${manifestData.doi}/${page.hash}/full/,150/0/default.jpg`,
                                        "@type": "dctypes:Image"
                                    },
                                    "images": [
                                        {
                                            "@id": `https://nakala.fr/iiif/${manifestData.doi}/annotation/page${index + 1}`,
                                            "@type": "oa:Annotation",
                                            "motivation": "sc:painting",
                                            "on": `https://nakala.fr/iiif/${manifestData.doi}/canvas/page${index + 1}`,
                                            "resource": {
                                                "@id": `https://api.nakala.fr/iiif/${manifestData.doi}/${page.hash}/full/full/0/default.jpg`,
                                                "@type": "dctypes:Image",
                                                "format": "image/jpeg",
                                                "height": page.height,
                                                "width": page.width,
                                                "service": {
                                                    "@context": "http://iiif.io/api/image/2/context.json",
                                                    "@id": `https://api.nakala.fr/iiif/${manifestData.doi}/${page.hash}`,
                                                    "profile": "http://iiif.io/api/image/2/level2.json"
                                                }
                                            }
                                        }
                                    ]
                                }))
                            }
                        ]
                    };

                    const manifestJson = JSON.stringify(manifest, null, 2);
                    
                    const validation = validateIIIFManifest(manifest);
                    
                    setGeneratedManifest(manifestJson);
                    setManifestValidation(validation);
                    setIsGenerating(false);
                }, 500);
            };

            const downloadManifest = () => {
                const blob = new Blob([generatedManifest], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${manifestData.letterId || 'document'}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const pushToGitHub = async () => {
                if (!githubConfig.token || !generatedManifest || !githubConfig.username || !githubConfig.repository) {
                    alert('Configuration GitHub incomplète ou manifest non généré');
                    return;
                }

                const fileName = `${manifestData.letterId || 'document'}.json`;
                const filePath = `${githubConfig.path}/${fileName}`;
                const commitMessage = `Add IIIF manifest for ${manifestData.letterId || 'document'}`;

                try {
                    // Encoder le contenu en base64
                    const content = btoa(unescape(encodeURIComponent(generatedManifest)));
                    
                    // D'abord, vérifier si le fichier existe déjà
                    let existingSha = null;
                    try {
                        const checkResponse = await fetch(`https://api.github.com/repos/${githubConfig.username}/${githubConfig.repository}/contents/${filePath}`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `token ${githubConfig.token}`,
                                'Content-Type': 'application/json',
                            }
                        });
                        
                        if (checkResponse.ok) {
                            const existingFile = await checkResponse.json();
                            existingSha = existingFile.sha;
                            console.log('Fichier existant trouvé, SHA:', existingSha);
                        }
                    } catch (error) {
                        console.log('Fichier n\'existe pas encore, création d\'un nouveau fichier');
                    }

                    // Préparer le payload
                    const payload = {
                        message: commitMessage,
                        content: content,
                        branch: githubConfig.branch
                    };

                    // Ajouter le SHA si le fichier existe
                    if (existingSha) {
                        payload.sha = existingSha;
                    }
                    
                    const response = await fetch(`https://api.github.com/repos/${githubConfig.username}/${githubConfig.repository}/contents/${filePath}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${githubConfig.token}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const action = existingSha ? 'mis à jour' : 'créé';
                        
                        // Stocker les informations du fichier pushé
                        const fileInfo = {
                            fileName: fileName,
                            filePath: filePath,
                            htmlUrl: result.content.html_url,
                            rawUrl: `https://raw.githubusercontent.com/${githubConfig.username}/${githubConfig.repository}/refs/heads/${githubConfig.branch}/${encodeURIComponent(filePath)}`,
                            timestamp: new Date()
                        };
                        setLastPushedFile(fileInfo);
                        
                        alert(`✅ Manifest ${action} sur GitHub avec succès!\n\nURL: ${result.content.html_url}`);
                        return result;
                    } else {
                        const error = await response.json();
                        console.error('Erreur GitHub:', error);
                        alert(`❌ Erreur lors du push: ${error.message}`);
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                    alert(`❌ Erreur de connexion: ${error.message}`);
                }
            };

            const createGitHubGist = async () => {
                if (!githubConfig.token || !generatedManifest) {
                    alert('Token GitHub ou manifest manquant');
                    return;
                }

                const fileName = `${manifestData.letterId || 'document'}.json`;
                
                try {
                    const response = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${githubConfig.token}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            description: `IIIF Manifest for ${manifestData.letterId || 'document'}`,
                            public: false,
                            files: {
                                [fileName]: {
                                    content: generatedManifest
                                }
                            }
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        window.open(result.html_url, '_blank');
                        alert(`✅ Gist créé avec succès!\n\nURL: ${result.html_url}`);
                        return result;
                    } else {
                        const error = await response.json();
                        alert(`❌ Erreur lors de la création du gist: ${error.message}`);
                    }
                } catch (error) {
                    alert(`❌ Erreur de connexion: ${error.message}`);
                }
            };

            const generateGitHubURL = () => {
                if (!githubConfig.username || !githubConfig.repository) {
                    return '';
                }
                
                const fileName = `${manifestData.letterId || 'document'}.json`;
                const filePath = `${githubConfig.path}/${fileName}`;
                const commitMessage = encodeURIComponent(`Add IIIF manifest for ${manifestData.letterId || 'document'}`);
                const content = encodeURIComponent(generatedManifest);
                
                return `https://github.com/${githubConfig.username}/${githubConfig.repository}/new/${githubConfig.branch}?filename=${filePath}&message=${commitMessage}&value=${content}`;
            };

            const copyRawUrlToClipboard = async () => {
                if (!lastPushedFile) {
                    alert('Aucun fichier pushé récemment. Utilisez d\'abord "Push vers Repository".');
                    return;
                }

                try {
                    await navigator.clipboard.writeText(lastPushedFile.rawUrl);
                    
                    // Afficher une confirmation visuelle
                    const successElement = document.createElement('div');
                    successElement.className = 'copy-success';
                    successElement.textContent = '✅ URL copiée dans le presse-papier !';
                    
                    const transkribusSection = document.querySelector('.transkribus-section');
                    if (transkribusSection) {
                        transkribusSection.appendChild(successElement);
                        setTimeout(() => {
                            if (successElement.parentNode) {
                                successElement.parentNode.removeChild(successElement);
                            }
                        }, 3000);
                    }
                } catch (error) {
                    // Fallback pour les navigateurs qui ne supportent pas l'API Clipboard
                    const textArea = document.createElement('textarea');
                    textArea.value = lastPushedFile.rawUrl;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('URL copiée dans le presse-papier !');
                }
            };

            const openTranskribus = () => {
                const transkribusUrl = `https://app.transkribus.org/upload?collId=${transkribusCollectionId}`;
                window.open(transkribusUrl, '_blank');
            };

            const isFormValid = () => {
                return manifestData.doi &&
                    validateDoi(manifestData.doi) &&
                    manifestData.letterId &&
                    manifestData.pages.every(p => p.hash && validateHash(p.hash));
            };

            return React.createElement('div', { className: 'container' },
                React.createElement('button', {
                    onClick: toggleDarkMode,
                    className: 'theme-toggle',
                    title: darkMode ? 'Mode clair' : 'Mode sombre'
                }, darkMode ? '☀️' : '🌙'),

                React.createElement('h1', { className: 'title' }, 'Générateur de Manifests IIIF Nakala'),

                // Indicateur de sauvegarde automatique
                React.createElement('div', { 
                    id: 'autosave-indicator',
                    className: 'autosave-indicator'
                }),

                // Bannière de récupération de session
                showRecoveryBanner && React.createElement('div', { className: 'recovery-banner' },
                    React.createElement('div', null,
                        React.createElement('strong', null, '🔄 Session précédente détectée'),
                        React.createElement('br'),
                        'Voulez-vous restaurer votre travail en cours ?'
                    ),
                    React.createElement('div', { className: 'recovery-actions' },
                        React.createElement('button', {
                            onClick: recoverSession,
                            className: 'recovery-btn'
                        }, 'Restaurer'),
                        React.createElement('button', {
                            onClick: discardSession,
                            className: 'recovery-btn'
                        }, 'Ignorer')
                    )
                ),

                // Info session de travail
                lastSaved && React.createElement('div', { className: 'work-session-info' },
                    `💾 Dernière sauvegarde : ${lastSaved.toLocaleTimeString()} • Sauvegarde automatique activée`
                ),
                
                React.createElement('div', { className: 'upload-section' },
                    React.createElement('div', { 
                        className: `drag-drop-zone ${dragOver ? 'drag-over' : ''}`,
                        onDragOver: handleDragOver,
                        onDragLeave: handleDragLeave,
                        onDrop: handleDrop,
                        onClick: () => fileInputRef.current?.click()
                    },
                        React.createElement(Upload, { className: 'upload-icon' }),
                        React.createElement('div', { className: 'upload-content' },
                            React.createElement('input', {
                                type: 'file',
                                accept: '.csv',
                                onChange: handleFileUpload,
                                ref: fileInputRef,
                                style: { display: 'none' }
                            }),
                            React.createElement('h3', { style: { marginBottom: '0.5rem', color: '#374151' } }, 
                                dragOver ? 'Déposez votre fichier CSV ici' : 'Charger le CSV myNKL'
                            ),
                            React.createElement('p', { style: { fontSize: '0.875rem', color: '#6b7280', marginBottom: '1rem' } },
                                'Glissez-déposez un fichier CSV ou cliquez pour parcourir'
                            ),
                            React.createElement('button', {
                                className: 'btn btn-primary'
                            }, React.createElement(Upload), ' Parcourir les fichiers'),
                            csvData.length > 0 && React.createElement('p', { 
                                className: 'success-message',
                                style: { marginTop: '1rem' }
                            },
                                React.createElement(CheckCircle),
                                ` ${csvData.length} lettres chargées`
                            )
                        )
                    )
                ),

                React.createElement('div', { className: 'form-section' },
                    csvData.length > 0 && React.createElement('div', { className: 'form-group' },
                        React.createElement('label', { className: 'form-label' }, 'Sélectionner une lettre'),
                        React.createElement('select', {
                            value: selectedLetter,
                            onChange: (e) => handleLetterSelect(e.target.value),
                            className: 'form-input'
                        },
                            React.createElement('option', { value: '' }, '-- Choisir une lettre --'),
                            csvData.map((item, index) =>
                                React.createElement('option', { key: index, value: item['Linked in item'] },
                                    item['http://nakala.fr/terms#title']
                                )
                            )
                        )
                    ),

                    React.createElement('h3', { className: 'section-title' }, 'Informations de base'),
                    
                    React.createElement('div', { className: 'form-group' },
                        React.createElement('label', { className: 'form-label' }, 'Coller DOI/hash complet *'),
                        React.createElement('input', {
                            type: 'text',
                            value: combined,
                            onChange: handleCombinedChange,
                            placeholder: '10.34847/nkl.e68ch4qq/cc32f286701e44a3772292ac41356e880e3f3161',
                            className: 'form-input'
                        }),
                        React.createElement('p', { className: 'dimensions-help' },
                            'Collez l\'identifiant complet pour remplir automatiquement le DOI et le hash de la première page'
                        )
                    ),
                    
                    React.createElement('div', { className: 'form-group' },
                        React.createElement('label', { className: 'form-label' }, 'DOI Nakala (automatique)'),
                        React.createElement('div', { className: 'input-wrapper' },
                            React.createElement('input', {
                                type: 'text',
                                value: manifestData.doi,
                                onChange: (e) => setManifestData({...manifestData, doi: e.target.value}),
                                placeholder: '10.34847/nkl.e68ch4qq',
                                className: `form-input ${
                                    manifestData.doi && !validateDoi(manifestData.doi)
                                        ? 'invalid'
                                        : manifestData.doi && validateDoi(manifestData.doi)
                                        ? 'valid'
                                        : ''
                                }`
                            }),
                            manifestData.doi && React.createElement('div', { className: 'input-icons' },
                                validateDoi(manifestData.doi) ?
                                    React.createElement(CheckCircle, { className: 'icon icon-success' }) :
                                    React.createElement(AlertCircle, { className: 'icon icon-error' })
                            )
                        ),
                        manifestData.doi && !validateDoi(manifestData.doi) &&
                            React.createElement('p', { className: 'error-message' }, 'Format DOI invalide')
                    ),

                    React.createElement('div', { className: 'form-grid' },
                        React.createElement('div', { className: 'form-group' },
                            React.createElement('label', { className: 'form-label' }, 'ID Lettre (automatique)'),
                            React.createElement('input', {
                                type: 'text',
                                value: manifestData.letterId,
                                onChange: (e) => setManifestData({...manifestData, letterId: e.target.value}),
                                placeholder: 'SPA_2469',
                                className: 'form-input'
                            })
                        ),
                        React.createElement('div', { className: 'form-group' },
                            React.createElement('label', { className: 'form-label' }, 'Date'),
                            React.createElement('input', {
                                type: 'date',
                                value: manifestData.dateIssued,
                                onChange: (e) => setManifestData({...manifestData, dateIssued: e.target.value}),
                                className: 'form-input'
                            })
                        )
                    ),

                    React.createElement('div', { className: 'form-group' },
                        React.createElement('label', { className: 'form-label' }, 'Titre'),
                        React.createElement('input', {
                            type: 'text',
                            value: manifestData.title,
                            onChange: (e) => setManifestData({...manifestData, title: e.target.value}),
                            className: 'form-input'
                        })
                    ),

                    React.createElement('div', { className: 'form-group' },
                        React.createElement('label', { className: 'form-label' }, 'Créateur'),
                        React.createElement('input', {
                            type: 'text',
                            value: manifestData.creator,
                            onChange: (e) => setManifestData({...manifestData, creator: e.target.value}),
                            className: 'form-input'
                        })
                    ),

                    React.createElement('div', { className: 'pages-header' },
                        React.createElement('h3', { className: 'section-title' }, 'Pages'),
                        React.createElement('div', { className: 'pages-actions' },
                            React.createElement('button', {
                                onClick: addPage,
                                className: 'btn btn-green'
                            }, React.createElement(Plus))
                        )
                    ),

                    manifestData.pages.map((page, index) =>
                        React.createElement('div', { key: index, className: 'page-card' },
                            React.createElement('div', { className: 'page-header' },
                                React.createElement('h4', { className: 'page-title' },
                                    `Page ${index + 1}`,
                                    page.loading && React.createElement('div', { className: 'spinner' }),
                                    page.validated && React.createElement(CheckCircle)
                                ),
                                manifestData.pages.length > 1 &&
                                    React.createElement('button', {
                                        onClick: () => removePage(index),
                                        className: 'btn-red'
                                    }, React.createElement(Minus))
                            ),

                            React.createElement('div', { className: 'form-group' },
                                React.createElement('label', { className: 'form-label' }, 'Coller DOI/hash pour cette page *'),
                                React.createElement('input', {
                                    type: 'text',
                                    value: page.combinedId || '',
                                    onChange: (e) => handlePageCombinedChange(index, e.target.value),
                                    placeholder: '10.34847/nkl.e68ch4qq/cc32f286701e44a3772292ac41356e880e3f3161',
                                    className: 'form-input'
                                }),
                                React.createElement('p', { className: 'dimensions-help' },
                                    'Collez l\'identifiant complet pour extraire automatiquement le DOI et le hash'
                                )
                            ),

                            React.createElement('div', { className: 'form-group' },
                                React.createElement('label', { className: 'form-label' }, 'Hash de l\'image (automatique)'),
                                React.createElement('div', { className: 'input-wrapper' },
                                    React.createElement('input', {
                                        type: 'text',
                                        value: page.hash,
                                        onChange: (e) => updatePage(index, 'hash', e.target.value),
                                        placeholder: 'cc32f286701e44a3772292ac41356e880e3f3161',
                                        className: `form-input ${
                                            page.hash && !validateHash(page.hash)
                                                ? 'invalid'
                                                : page.hash && validateHash(page.hash)
                                                ? 'valid'
                                                : ''
                                        }`
                                    }),
                                    React.createElement('div', { className: 'input-icons' },
                                        page.hash && (
                                            validateHash(page.hash) ?
                                                React.createElement(CheckCircle, { className: 'icon icon-success' }) :
                                                React.createElement(AlertCircle, { className: 'icon icon-error' })
                                        )
                                    )
                                ),
                                page.error && React.createElement('p', { className: 'error-message' }, page.error),
                                page.hash && !validateHash(page.hash) &&
                                    React.createElement('p', { className: 'error-message' }, 'Format hash invalide (40 caractères hexadécimaux)')
                            ),

                            React.createElement('div', { className: 'form-group' },
                                React.createElement('label', { className: 'form-label' }, 'Coller les dimensions ici (si la récupération automatique a échouée)'),
                                React.createElement('div', { className: 'dimensions-input' },
                                    React.createElement('input', {
                                        type: 'text',
                                        value: page.dimensionsInput || '',
                                        onChange: (e) => updatePage(index, 'dimensionsInput', e.target.value),
                                        placeholder: 'Ex: {"width":2692,"height":3430} ou 2692x3430',
                                        className: 'form-input'
                                    }),
                                    React.createElement('button', {
                                        onClick: () => parseDimensions(page.dimensionsInput, index),
                                        disabled: !page.dimensionsInput,
                                        className: 'btn btn-primary'
                                    }, 'Appliquer')
                                ),
                                React.createElement('p', { className: 'dimensions-help' },
                                    'Copiez tout ou partie du JSON depuis l\'onglet info.json ouvert, ou saisissez "largeur x hauteur"'
                                )
                            ),

                            React.createElement('div', { className: 'form-grid' },
                                React.createElement('div', { className: 'form-group' },
                                    React.createElement('label', { className: 'form-label' }, 'Largeur'),
                                    React.createElement('input', {
                                        type: 'number',
                                        value: page.width,
                                        onChange: (e) => updatePage(index, 'width', parseInt(e.target.value)),
                                        className: 'form-input'
                                    })
                                ),
                                React.createElement('div', { className: 'form-group' },
                                    React.createElement('label', { className: 'form-label' }, 'Hauteur'),
                                    React.createElement('input', {
                                        type: 'number',
                                        value: page.height,
                                        onChange: (e) => updatePage(index, 'height', parseInt(e.target.value)),
                                        className: 'form-input'
                                    })
                                )
                            )
                        )
                    ),

                    React.createElement('div', { 
                        style: { 
                            marginBottom: '1rem', 
                            display: 'flex', 
                            gap: '0.5rem',
                            flexWrap: 'wrap'
                        } 
                    },
                        React.createElement('button', {
                            onClick: fetchAllDimensions,
                            disabled: !manifestData.doi || !validateDoi(manifestData.doi) || manifestData.pages.some(p => !p.hash || !validateHash(p.hash)),
                            className: 'btn btn-primary',
                            style: { 
                                flex: '1',
                                minWidth: '200px',
                                justifyContent: 'center', 
                                padding: '0.75rem 1rem',
                                whiteSpace: 'normal',
                                lineHeight: '1.2'
                            }
                        }, '🔄 Récupération automatique des dimensions', React.createElement('br'), 'de toutes les pages'),
                        React.createElement('button', {
                            onClick: openAllInfoUrls,
                            disabled: !manifestData.doi || !validateDoi(manifestData.doi) || manifestData.pages.some(p => !p.hash || !validateHash(p.hash)),
                            className: 'btn btn-primary',
                            style: { 
                                flex: '1',
                                minWidth: '200px',
                                justifyContent: 'center', 
                                padding: '0.75rem 1rem',
                                whiteSpace: 'normal',
                                lineHeight: '1.2'
                            }
                        }, React.createElement(ExternalLink), ' Ouvrir toutes les URLs', React.createElement('br'), 'info.json')
                    ),

                    React.createElement('div', { className: 'generate-section' },
                        React.createElement('button', {
                            onClick: generateManifest,
                            disabled: !isFormValid() || isGenerating,
                            className: 'generate-btn'
                        },
                            isGenerating ?
                                [React.createElement('div', { key: 'spinner', className: 'spinner' }), 'Génération en cours...'] :
                                [React.createElement(FileText, { key: 'icon' }), 'Générer le Manifest IIIF']
                        )
                    )
                ),

                generatedManifest && React.createElement('div', { className: 'preview-section' },
                    React.createElement('h3', { className: 'preview-title' }, 'Aperçu du Manifest'),
                    
                    manifestValidation && React.createElement('div', { 
                        style: { marginBottom: '1rem', padding: '0.75rem', borderRadius: '0.375rem',
                                backgroundColor: manifestValidation.isValid ? '#f0fdf4' : '#fef2f2',
                                border: `1px solid ${manifestValidation.isValid ? '#10b981' : '#ef4444'}` }
                    },
                        React.createElement('h4', { 
                            style: { color: manifestValidation.isValid ? '#065f46' : '#7f1d1d', marginBottom: '0.5rem' }
                        }, manifestValidation.isValid ? '✅ Manifest IIIF valide' : '❌ Erreurs détectées'),
                        
                        manifestValidation.errors.length > 0 && React.createElement('div', null,
                            React.createElement('strong', { style: { color: '#ef4444' } }, 'Erreurs:'),
                            React.createElement('ul', { style: { margin: '0.25rem 0', paddingLeft: '1.5rem' } },
                                manifestValidation.errors.map((error, index) =>
                                    React.createElement('li', { key: index, style: { color: '#7f1d1d' } }, error)
                                )
                            )
                        ),
                        
                        manifestValidation.warnings.length > 0 && React.createElement('div', null,
                            React.createElement('strong', { style: { color: '#f59e0b' } }, 'Avertissements:'),
                            React.createElement('ul', { style: { margin: '0.25rem 0', paddingLeft: '1.5rem' } },
                                manifestValidation.warnings.map((warning, index) =>
                                    React.createElement('li', { key: index, style: { color: '#92400e' } }, warning)
                                )
                            )
                        )
                    ),
                    
                    React.createElement('div', { className: 'preview-content' },
                        React.createElement('pre', { className: 'preview-json' }, generatedManifest)
                    ),
                    React.createElement('button', {
                        onClick: downloadManifest,
                        className: 'download-btn',
                        style: { marginBottom: '0.5rem' }
                    }, React.createElement(Download), ' Télécharger le Manifest'),

                    // GitHub Integration Section
                    React.createElement('div', { className: 'github-section' },
                        React.createElement('div', { 
                            style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '1rem' }
                        },
                            React.createElement('h4', { style: { margin: 0, color: darkMode ? '#f9fafb' : '#374151' } }, 
                                '🐙 Intégration GitHub'
                            ),
                            React.createElement('button', {
                                onClick: () => setShowGithubConfig(!showGithubConfig),
                                className: 'btn btn-primary',
                                style: { fontSize: '0.75rem', padding: '0.25rem 0.5rem' }
                            }, showGithubConfig ? 'Masquer' : 'Configurer')
                        ),

                        showGithubConfig && React.createElement('div', null,
                            React.createElement('div', { className: 'github-config' },
                                React.createElement('div', { className: 'form-group' },
                                    React.createElement('label', { className: 'form-label' }, 'Nom d\'utilisateur GitHub'),
                                    React.createElement('input', {
                                        type: 'text',
                                        value: githubConfig.username,
                                        onChange: (e) => setGithubConfig({...githubConfig, username: e.target.value}),
                                        placeholder: 'votre-username',
                                        className: 'form-input'
                                    })
                                ),
                                React.createElement('div', { className: 'form-group' },
                                    React.createElement('label', { className: 'form-label' }, 'Nom du repository'),
                                    React.createElement('input', {
                                        type: 'text',
                                        value: githubConfig.repository,
                                        onChange: (e) => setGithubConfig({...githubConfig, repository: e.target.value}),
                                        placeholder: 'iiif-manifests',
                                        className: 'form-input'
                                    })
                                ),
                                React.createElement('div', { className: 'form-group' },
                                    React.createElement('label', { className: 'form-label' }, 'Branche'),
                                    React.createElement('input', {
                                        type: 'text',
                                        value: githubConfig.branch,
                                        onChange: (e) => setGithubConfig({...githubConfig, branch: e.target.value}),
                                        placeholder: 'main',
                                        className: 'form-input'
                                    })
                                ),
                                React.createElement('div', { className: 'form-group' },
                                    React.createElement('label', { className: 'form-label' }, 'Dossier'),
                                    React.createElement('input', {
                                        type: 'text',
                                        value: githubConfig.path,
                                        onChange: (e) => setGithubConfig({...githubConfig, path: e.target.value}),
                                        placeholder: 'manifests',
                                        className: 'form-input'
                                    })
                                )
                            ),
                            React.createElement('div', { className: 'form-group' },
                                React.createElement('label', { className: 'form-label' }, 'Personal Access Token (optionnel pour push automatique)'),
                                React.createElement('input', {
                                    type: 'password',
                                    value: githubConfig.token,
                                    onChange: (e) => setGithubConfig({...githubConfig, token: e.target.value}),
                                    placeholder: 'ghp_xxxxxxxxxxxxxxxxxxxx',
                                    className: 'form-input'
                                }),
                                React.createElement('p', { className: 'dimensions-help' },
                                    'Créez un token sur GitHub.com → Settings → Developer settings → Personal access tokens'
                                )
                            )
                        ),

                        React.createElement('div', { className: 'github-actions' },
                            // Gist creation method (better for large files)
                            githubConfig.token && React.createElement('button', {
                                onClick: createGitHubGist,
                                disabled: !generatedManifest,
                                className: 'btn btn-primary'
                            }, '📋 Créer un Gist'),

                            // Direct push method  
                            githubConfig.token && githubConfig.username && githubConfig.repository && React.createElement('button', {
                                onClick: pushToGitHub,
                                disabled: !generatedManifest,
                                className: 'btn btn-primary'
                            }, '📤 Push vers Repository'),

                            React.createElement('button', {
                                onClick: () => setGithubConfig({...githubConfig, enabled: !githubConfig.enabled}),
                                className: `btn ${githubConfig.enabled ? 'btn-success' : 'btn-primary'}`,
                                style: { fontSize: '0.875rem' }
                            }, githubConfig.enabled ? '✅ Activé' : '⚪ Désactivé')
                        ),

                        githubConfig.username && githubConfig.repository && React.createElement('div', { className: 'github-url' },
                            `Repository: https://github.com/${githubConfig.username}/${githubConfig.repository}`
                        ),

                        React.createElement('p', { 
                            className: 'dimensions-help',
                            style: { margin: '0.5rem 0 0 0' }
                        }, 
                            '💡 "Créer un Gist" (fichier temporaire) ou "Push vers Repository" (commit permanent)'
                        )
                    ),

                    // Section Transkribus
                    React.createElement('div', { className: 'transkribus-section' },
                        React.createElement('h4', { 
                            style: { 
                                margin: '0 0 1rem 0', 
                                color: darkMode ? '#f9fafb' : '#1e40af',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '0.5rem'
                            } 
                        }, 
                            '📚 Integration Transkribus',
                            React.createElement('button', {
                                onClick: () => setShowGithubConfig(!showGithubConfig),
                                className: 'btn btn-primary',
                                style: { fontSize: '0.75rem', padding: '0.25rem 0.5rem' }
                            }, 'Configurer Collection')
                        ),

                        showGithubConfig && React.createElement('div', { className: 'form-group', style: { marginBottom: '1rem' } },
                            React.createElement('label', { className: 'form-label' }, 'ID Collection Transkribus'),
                            React.createElement('input', {
                                type: 'text',
                                value: transkribusCollectionId,
                                onChange: (e) => setTranskribusCollectionId(e.target.value),
                                placeholder: '190656',
                                className: 'form-input'
                            }),
                            React.createElement('p', { className: 'dimensions-help' },
                                'Trouvez l\'ID dans l\'URL de votre collection Transkribus'
                            )
                        ),

                        lastPushedFile && React.createElement('div', null,
                            React.createElement('p', { 
                                style: { 
                                    fontSize: '0.875rem', 
                                    marginBottom: '0.5rem',
                                    color: darkMode ? '#d1d5db' : '#64748b'
                                } 
                            }, 
                                `📄 Dernier fichier pushé : ${lastPushedFile.fileName}`
                            ),
                            React.createElement('div', { className: 'url-display' },
                                lastPushedFile.rawUrl
                            )
                        ),

                        React.createElement('div', { 
                            className: 'transkribus-actions',
                            style: { 
                                display: 'flex', 
                                gap: '1rem', 
                                marginTop: '1rem', 
                                flexWrap: 'wrap' 
                            }
                        },
                            React.createElement('button', {
                                onClick: copyRawUrlToClipboard,
                                disabled: !lastPushedFile,
                                className: 'btn btn-primary',
                                style: { 
                                    flex: '1', 
                                    minWidth: '150px', 
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    padding: '0.5rem 1rem'
                                },
                                title: lastPushedFile ? 'Copier l\'URL raw du dernier fichier pushé' : 'Pushez d\'abord un fichier'
                            }, '📋 Copier URL Raw'),

                            React.createElement('button', {
                                onClick: openTranskribus,
                                className: 'btn btn-primary',
                                style: { 
                                    flex: '1', 
                                    minWidth: '150px', 
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    padding: '0.5rem 1rem'
                                }
                            }, '🚀 Ouvrir Transkribus'),

                            lastPushedFile && React.createElement('button', {
                                onClick: () => window.open(lastPushedFile.htmlUrl, '_blank'),
                                className: 'btn btn-primary',
                                style: { 
                                    flex: '1', 
                                    minWidth: '150px', 
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    padding: '0.5rem 1rem'
                                }
                            }, '👁️ Voir sur GitHub')
                        ),

                        React.createElement('p', { 
                            className: 'dimensions-help',
                            style: { margin: '0.5rem 0 0 0' }
                        }, 
                            '🔄 Workflow : Push → Copier URL → Ouvrir Transkribus → Coller l\'URL'
                        )
                    )
                )
            );
        };

        ReactDOM.render(React.createElement(IIIFManifestGenerator), document.getElementById('root'));
    </script>
</body>
</html>
