<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GÃ©nÃ©rateur de Manifests IIIF Nakala V9 - API OAI-PMH</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background-color: #f9fafb;
            line-height: 1.5;
        }
        
        .container {
            max-width: 768px;
            margin: 0 auto;
            padding: 1rem;
            background-color: white;
            min-height: 100vh;
        }
        
        .title {
            font-size: 1.25rem;
            font-weight: 500;
            color: #111827;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .upload-section {
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background-color: white;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
        }
        
        .btn-primary:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
        }
        
        .btn-success {
            background-color: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #059669;
        }
        
        .btn-purple {
            background-color: #8b5cf6;
            color: white;
        }
        
        .btn-purple:hover {
            background-color: #7c3aed;
        }
        
        .btn-green {
            background-color: #3b82f6;
            color: white;
            padding: 0.25rem;
        }
        
        .btn-green:hover {
            background-color: #2563eb;
        }
        
        .btn-red {
            color: #ef4444;
            background: none;
            border: none;
            padding: 0.25rem;
        }
        
        .btn-red:hover {
            color: #dc2626;
        }
        
        .success-message {
            color: #059669;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .form-section {
            background-color: white;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 0.75rem;
        }
        
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
        }
        
        .form-input {
            width: 100%;
            padding: 0.5rem;
            font-size: 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 1px #3b82f6;
        }
        
        .form-input.valid {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        
        .form-input.invalid {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        
        .input-wrapper {
            position: relative;
        }
        
        .input-icons {
            position: absolute;
            right: 0.5rem;
            top: 0.5rem;
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }
        
        .icon {
            width: 1rem;
            height: 1rem;
        }
        
        .icon-success {
            color: #10b981;
        }
        
        .icon-error {
            color: #ef4444;
        }
        
        .error-message {
            color: #ef4444;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
        
        .section-title {
            font-size: 1rem;
            font-weight: 500;
            color: #111827;
            margin-bottom: 0.75rem;
        }
        
        .pages-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        
        .pages-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .page-card {
            padding: 0.75rem;
            background-color: #f9fafb;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
            margin-bottom: 0.75rem;
        }
        
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        
        .page-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .spinner {
            width: 0.75rem;
            height: 0.75rem;
            border: 2px solid #3b82f6;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .dimensions-input {
            display: flex;
            gap: 0.5rem;
        }
        
        .dimensions-input input {
            flex: 1;
        }
        
        .dimensions-help {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        
        .generate-section {
            padding-top: 1rem;
            margin-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .generate-btn {
            width: 100%;
            background-color: #2563eb;
            color: white;
            font-weight: 500;
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .generate-btn:hover {
            background-color: #1d4ed8;
        }
        
        .generate-btn:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
        }
        
        .preview-section {
            background-color: white;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
            padding: 1rem;
        }
        
        .preview-title {
            font-size: 1rem;
            font-weight: 500;
            color: #111827;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .preview-content {
            background-color: #f9fafb;
            padding: 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
            font-size: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .preview-json {
            overflow-x: auto;
            max-height: 20rem;
            color: #374151;
            white-space: pre;
            font-family: 'Courier New', monospace;
        }
        
        .download-btn {
            width: 100%;
            background-color: #3b82f6;
            color: white;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .download-btn:hover {
            background-color: #2563eb;
        }

        .drag-drop-zone {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .drag-drop-zone:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }

        .drag-drop-zone.drag-over {
            border-color: #10b981;
            background-color: #f0fdf4;
        }

        .theme-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: #2563eb;
            transform: scale(1.1);
        }

        /* Mode sombre */
        body.dark-mode {
            background-color: #1f2937;
            color: #f9fafb;
        }

        .dark-mode .container {
            background-color: #1f2937;
        }

        .dark-mode .upload-section,
        .dark-mode .form-section,
        .dark-mode .preview-section {
            background-color: #374151;
            border-color: #4b5563;
        }

        .dark-mode .page-card {
            background-color: #4b5563;
            border-color: #6b7280;
        }

        .dark-mode .form-input {
            background-color: #374151;
            border-color: #6b7280;
            color: #f9fafb;
        }

        .dark-mode .form-input:focus {
            border-color: #3b82f6;
        }

        .dark-mode .form-input.valid {
            border-color: #10b981;
            background-color: #065f46;
        }

        .dark-mode .form-input.invalid {
            border-color: #ef4444;
            background-color: #7f1d1d;
        }

        .dark-mode .drag-drop-zone {
            border-color: #6b7280;
            background-color: #374151;
        }

        .dark-mode .drag-drop-zone:hover {
            border-color: #3b82f6;
            background-color: #4b5563;
        }

        .dark-mode .drag-drop-zone.drag-over {
            border-color: #10b981;
            background-color: #065f46;
        }

        .dark-mode .title,
        .dark-mode .section-title,
        .dark-mode .form-label,
        .dark-mode .page-title,
        .dark-mode .preview-title {
            color: #f9fafb;
        }

        .dark-mode .preview-content {
            background-color: #4b5563;
            border-color: #6b7280;
        }

        .dark-mode .preview-json {
            color: #e5e7eb;
        }

        .dark-mode .theme-toggle {
            background: #fbbf24;
            color: #1f2937;
        }

        .dark-mode .theme-toggle:hover {
            background: #f59e0b;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .pages-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .title {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body class="dark-mode">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef } = React;

        const IIIFManifestGenerator = () => {
            const [csvData, setCsvData] = useState([]);
            const [selectedLetter, setSelectedLetter] = useState('');
            const [manifestData, setManifestData] = useState({
                doi: '',
                letterId: '',
                title: '',
                creator: '',
                dateIssued: '',
                attribution: 'Nicolas Moron / NAKALA',
                license: 'http://creativecommons.org/licenses/by-nc/4.0/',
                pages: [
                    { hash: '', width: 2692, height: 3430, loading: false, validated: false, error: null, dimensionsInput: '', combinedId: ''}
                ]
            });
            const [generatedManifest, setGeneratedManifest] = useState('');
            const [isGenerating, setIsGenerating] = useState(false);
            const [combined, setCombined] = useState('');
            const [dragOver, setDragOver] = useState(false);
            const [darkMode, setDarkMode] = useState(true);
            const [manifestValidation, setManifestValidation] = useState(null);
            const fileInputRef = useRef(null);

            const validateDoi = (doi) => {
                const doiRegex = /^10\.\d{4,}\/.*$/;
                return doiRegex.test(doi);
            };

            const validateHash = (hash) => {
                const hashRegex = /^[a-f0-9]{40}$/i;
                return hashRegex.test(hash);
            };

            const validateIIIFManifest = (manifest) => {
                const errors = [];
                const warnings = [];

                if (!manifest['@context']) errors.push('Le champ @context est requis');
                if (!manifest['@id']) errors.push('Le champ @id est requis');
                if (!manifest['@type']) errors.push('Le champ @type est requis');
                if (!manifest.label) warnings.push('Le champ label est recommandÃ©');

                if (!manifest.sequences || manifest.sequences.length === 0) {
                    errors.push('Au moins une sÃ©quence est requise');
                }

                return { errors, warnings, isValid: errors.length === 0 };
            };

            const toggleDarkMode = () => {
                setDarkMode(!darkMode);
                document.body.classList.toggle('dark-mode');
            };

            const parseCombined = (input) => {
                const parts = input.trim().split('/');
                const hash = parts.pop();
                const doi = parts.join('/');
                return { doi, hash };
            };

            const handleCombinedChange = (e) => {
                const val = e.target.value;
                setCombined(val);

                if (val.includes('/')) {
                    try {
                        const { doi, hash } = parseCombined(val);
                        setManifestData(md => ({
                            ...md,
                            doi,
                            pages: md.pages.map((p, i) =>
                                i === 0 ? { ...p, hash, combinedId: val } : p
                            )
                        }));
                    } catch {
                        // laisse l'utilisateur continuer Ã  taper
                    }
                }
            };

            const handlePageCombinedChange = (pageIndex, value) => {
                const newPages = [...manifestData.pages];
                newPages[pageIndex].combinedId = value;

                if (value.includes('/')) {
                    try {
                        const { doi, hash } = parseCombined(value);
                        
                        if (!manifestData.doi || manifestData.doi !== doi) {
                            setManifestData(prev => ({
                                ...prev,
                                doi: doi,
                                pages: newPages.map((p, i) => 
                                    i === pageIndex ? { ...p, hash, combinedId: value } : p
                                )
                            }));
                        } else {
                            newPages[pageIndex].hash = hash;
                            setManifestData({ ...manifestData, pages: newPages });
                        }
                    } catch {
                        setManifestData({ ...manifestData, pages: newPages });
                    }
                } else {
                    setManifestData({ ...manifestData, pages: newPages });
                }
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                setDragOver(true);
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                setDragOver(false);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                setDragOver(false);
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                        Papa.parse(file, {
                            header: true,
                            skipEmptyLines: true,
                            complete: (results) => {
                                const rows = results.data.map((row) => {
                                    const title = row['http://nakala.fr/terms#title'] || '';
                                    const match = title.match(/(SPA_\d+)/);
                                    return { ...row, letterId: match ? match[1] : '' };
                                });
                                setCsvData(rows);
                            }
                        });
                    } else {
                        alert('Veuillez dÃ©poser un fichier CSV');
                    }
                }
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        const rows = results.data.map((row) => {
                            const title = row['http://nakala.fr/terms#title'] || '';
                            const match = title.match(/(SPA_\d+)/);
                            return { ...row, letterId: match ? match[1] : '' };
                        });
                        setCsvData(rows);
                    }
                });
            };

            const handleLetterSelect = (letterItem) => {
                const letterData = csvData.find(item => item['Linked in item'] === letterItem);
                if (!letterData) return;

                const letterId = letterData.letterId || 
                    (letterData['http://nakala.fr/terms#title']?.match(/(SPA_\d+)/)?.[1] ?? '');

                setManifestData({
                    ...manifestData,
                    letterId,
                    title: letterData['http://nakala.fr/terms#title'] || '',
                    creator: letterData['http://nakala.fr/terms#creator'] || '',
                    dateIssued: letterData['http://nakala.fr/terms#created'] || ''
                });
                setSelectedLetter(letterItem);
            };

            const fetchImageDimensions = async (doi, hash) => {
                const infoUrl = 'https://api.nakala.fr/iiif/' + doi + '/' + hash + '/info.json';
                console.log('ðŸ” Tentative de rÃ©cupÃ©ration des dimensions pour:', doi + '/' + hash);
                console.log('ðŸ“‹ URL info.json:', infoUrl);
                
                try {
                    const response = await fetch(infoUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    console.log('ðŸ“Š RÃ©ponse directe - Status:', response.status);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('âœ… Dimensions rÃ©cupÃ©rÃ©es directement:', data.width + 'x' + data.height);
                        return {
                            width: data.width,
                            height: data.height,
                            success: true
                        };
                    } else {
                        console.log('âŒ Erreur directe:', response.status, response.statusText);
                    }
                } catch (error) {
                    console.log('âŒ Erreur lors de la tentative directe:', error.message);
                }
                
                try {
                    console.log('ðŸ”„ Tentative avec proxy...');
                    const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(infoUrl);
                    const response = await fetch(proxyUrl);
                    
                    console.log('ðŸ“Š RÃ©ponse proxy - Status:', response.status);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('âœ… Dimensions rÃ©cupÃ©rÃ©es via proxy:', data.width + 'x' + data.height);
                        return {
                            width: data.width,
                            height: data.height,
                            success: true
                        };
                    } else {
                        console.log('âŒ Erreur proxy:', response.status, response.statusText);
                    }
                } catch (error) {
                    console.error('âŒ Erreur lors de la tentative proxy:', error.message);
                }
                
                console.log('âŒ Toutes les tentatives ont Ã©chouÃ© pour:', doi + '/' + hash);
                return {
                    error: 'Impossible de rÃ©cupÃ©rer les dimensions automatiquement. Utilisez le bouton "ðŸ“‹ Ouvrir info.json" pour les rÃ©cupÃ©rer manuellement.',
                    success: false
                };
            };

            const fetchAllHashesFromDOI = async () => {
                if (!manifestData.doi || !validateDoi(manifestData.doi)) {
                    alert('Veuillez d\'abord saisir un DOI valide');
                    return;
                }

                try {
                    const apiUrl = 'https://api.nakala.fr/datas/' + manifestData.doi;
                    
                    let response;
                    try {
                        response = await fetch(apiUrl, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            }
                        });
                    } catch (error) {
                        console.log('Tentative directe Ã©chouÃ©e, utilisation du proxy:', error);
                        const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(apiUrl);
                        response = await fetch(proxyUrl);
                        if (response.ok) {
                            const proxyData = await response.json();
                            response = { 
                                ok: true, 
                                json: () => Promise.resolve(JSON.parse(proxyData.contents))
                            };
                        }
                    }
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        console.log('DonnÃ©es complÃ¨tes de l\'API:', data);
                        console.log('Fichiers trouvÃ©s:', data.files);
                        
                        const files = data.files || [];
                        console.log('Nombre de fichiers:', files.length);
                        
                        files.forEach((file, index) => {
                            console.log('Fichier ' + (index + 1) + ':', {
                                nom: file.name || file.filename,
                                mimetype: file.mimetype || file.type,
                                sha1: file.sha1 || file.hash,
                                taille: file.size
                            });
                        });
                        
                        let imageFiles = [];
                        
                        imageFiles = files.filter(file => 
                            file.mimetype && file.mimetype.startsWith('image/')
                        );
                        console.log('Fichiers images (stratÃ©gie 1 - mimetype):', imageFiles.length);
                        
                        if (imageFiles.length === 0) {
                            const imageExtensions = ['.jpg', '.jpeg', '.png', '.tiff', '.tif', '.gif', '.webp'];
                            imageFiles = files.filter(file => {
                                const fileName = file.name || file.filename || '';
                                return imageExtensions.some(ext => 
                                    fileName.toLowerCase().endsWith(ext)
                                );
                            });
                            console.log('Fichiers images (stratÃ©gie 2 - extension):', imageFiles.length);
                        }
                        
                        if (imageFiles.length === 0) {
                            imageFiles = files;
                            console.log('Fichiers images (stratÃ©gie 3 - tous les fichiers):', imageFiles.length);
                        }
                        
                        if (imageFiles.length === 0) {
                            alert('Aucun fichier trouvÃ© dans cette donnÃ©e.\n\nStructure des donnÃ©es reÃ§ues:\n' + JSON.stringify(data, null, 2).substring(0, 500) + '...');
                            return;
                        }
                        
                        const newPages = imageFiles.map((file, index) => ({
                            hash: file.sha1 || file.hash,
                            width: 2692,
                            height: 3430,
                            loading: false,
                            validated: false,
                            error: null,
                            dimensionsInput: '',
                            combinedId: manifestData.doi + '/' + (file.sha1 || file.hash)
                        }));
                        
                        setManifestData({
                            ...manifestData,
                            pages: newPages
                        });
                        
                        alert('âœ… ' + imageFiles.length + ' fichiers trouvÃ©s et ajoutÃ©s automatiquement!\n\nFichiers dÃ©tectÃ©s:\n' + imageFiles.map((f, i) => (i+1) + '. ' + (f.name || f.filename || 'Sans nom') + ' (' + (f.mimetype || 'type inconnu') + ')').join('\n'));
                        
                        await fetchAllDimensionsFromHash(newPages);
                        
                    } else {
                        throw new Error('Erreur HTTP ' + response.status + ': ' + response.statusText);
                    }
                } catch (error) {
                    console.error('Erreur complÃ¨te:', error);
                    alert('âŒ Impossible de rÃ©cupÃ©rer les fichiers: ' + error.message + '\n\nVÃ©rifiez la console pour plus de dÃ©tails.');
                }
            };

            // Nouvelle fonction utilisant l'API OAI-PMH (la vraie solution documentÃ©e !)
            const fetchAllHashesFromCollectionOAI = async () => {
                if (!manifestData.doi) {
                    alert('Veuillez d\'abord saisir le DOI de la collection');
                    return;
                }

                try {
                    // Transformer le DOI en set OAI selon la documentation Nakala
                    // 10.34847/nkl.01f96o67 -> doi_10.34847_nkl.01f96o67
                    const oaiSet = 'doi_' + manifestData.doi.replace(/\//g, '_');
                    const oaiUrl = 'https://api.nakala.fr/oai2?verb=ListRecords&metadataPrefix=oai_dc&set=' + oaiSet;
                    
                    console.log('ðŸŽ¯ NOUVELLE APPROCHE - API OAI-PMH (SOLUTION DOCUMENTÃ‰E)');
                    console.log('ðŸ“Š Collection DOI:', manifestData.doi);
                    console.log('ðŸ“Š Set OAI transformÃ©:', oaiSet);
                    console.log('ðŸ“Š URL OAI-PMH:', oaiUrl);
                    
                    let response;
                    try {
                        response = await fetch(oaiUrl, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/xml,text/xml,*/*',
                                'Content-Type': 'application/xml'
                            }
                        });
                    } catch (error) {
                        console.log('Tentative directe Ã©chouÃ©e, utilisation du proxy:', error);
                        const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(oaiUrl);
                        response = await fetch(proxyUrl);
                        if (response.ok) {
                            const proxyData = await response.json();
                            response = { 
                                ok: true, 
                                text: () => Promise.resolve(proxyData.contents)
                            };
                        }
                    }
                    
                    if (response.ok) {
                        const xmlText = await response.text();
                        console.log('ðŸ“Š RÃ©ponse XML OAI-PMH (premiers 1000 caractÃ¨res):', xmlText.substring(0, 1000) + '...');
                        
                        // Parser le XML pour extraire les DOI
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                        
                        // VÃ©rifier les erreurs de parsing XML
                        const parseError = xmlDoc.querySelector('parsererror');
                        if (parseError) {
                            throw new Error('Erreur de parsing XML: ' + parseError.textContent);
                        }
                        
                        // Extraire les enregistrements
                        const records = xmlDoc.querySelectorAll('record');
                        console.log('ðŸ“Š Nombre d\'enregistrements trouvÃ©s:', records.length);
                        
                        if (records.length === 0) {
                            // VÃ©rifier s'il y a des erreurs OAI
                            const oaiError = xmlDoc.querySelector('error');
                            if (oaiError) {
                                const errorCode = oaiError.getAttribute('code');
                                const errorMessage = oaiError.textContent;
                                throw new Error('Erreur OAI-PMH (' + errorCode + '): ' + errorMessage);
                            }
                            
                            alert('âŒ Aucun enregistrement trouvÃ© dans cette collection via OAI-PMH.\n\nðŸ” DIAGNOSTIC :\nâ€¢ Collection DOI: ' + manifestData.doi + '\nâ€¢ Set OAI: ' + oaiSet + '\nâ€¢ URL testÃ©e: ' + oaiUrl + '\n\nCAUSES PROBABLES :\nâ€¢ Collection vide\nâ€¢ Collection privÃ©e\nâ€¢ DOI de collection incorrect\nâ€¢ Collection pas encore indexÃ©e dans OAI-PMH\n\nðŸ’¡ SOLUTION : VÃ©rifiez que la collection est publique et contient des donnÃ©es, ou utilisez le mode "donnÃ©e unique".');
                            return;
                        }
                        
                        const extractedDOIs = [];
                        
                        // Parcourir chaque enregistrement pour extraire les DOI
                        records.forEach((record, index) => {
                            // MÃ©thode 1: chercher dans dc:identifier
                            const identifiers = record.querySelectorAll('dc\\:identifier, identifier');
                            identifiers.forEach(id => {
                                const value = id.textContent.trim();
                                if (value && value.match(/^10\.\d{4,}\/.*$/)) {
                                    extractedDOIs.push(value);
                                    console.log('âœ… DOI trouvÃ© (dc:identifier):', value);
                                }
                            });
                            
                            // MÃ©thode 2: chercher dans l'header identifier et l'extraire
                            const headerIdentifier = record.querySelector('header identifier');
                            if (headerIdentifier) {
                                const headerValue = headerIdentifier.textContent.trim();
                                console.log('ðŸ“‹ Header identifier:', headerValue);
                                
                                // Extraire le DOI du format oai:nakala.fr:doi_10.34847_nkl.xxxxx
                                const doiMatch = headerValue.match(/doi_([^_]+_[^_]+_[^_]+(?:_[^_]+)*)/);
                                if (doiMatch) {
                                    const extractedDOI = doiMatch[1].replace(/_/g, '/');
                                    if (extractedDOI.match(/^10\.\d{4,}\/.*$/)) {
                                        extractedDOIs.push(extractedDOI);
                                        console.log('âœ… DOI extrait (header):', extractedDOI);
                                    }
                                }
                            }
                        });
                        
                        // DÃ©dupliquer les DOI
                        const uniqueDOIs = [...new Set(extractedDOIs)];
                        console.log('ðŸ“Š DOI uniques extraits:', uniqueDOIs);
                        
                        if (uniqueDOIs.length === 0) {
                            alert('âŒ Aucun DOI valide trouvÃ© dans les enregistrements OAI-PMH.\n\nðŸ” Les enregistrements existent mais ne contiennent pas de DOI exploitables.\n\nVÃ©rifiez la console pour plus de dÃ©tails sur les mÃ©tadonnÃ©es rÃ©cupÃ©rÃ©es.');
                            return;
                        }
                        
                        alert('ðŸŽ¯ API OAI-PMH rÃ©ussie ! ' + uniqueDOIs.length + ' donnÃ©es trouvÃ©es dans la collection.\n\nðŸ“‹ DOI dÃ©tectÃ©s:\n' + uniqueDOIs.map((doi, i) => (i+1) + '. ' + doi).join('\n') + '\n\nðŸš€ RÃ©cupÃ©ration des fichiers en cours...');
                        
                        // Traiter chaque DOI individuellement comme des donnÃ©es uniques
                        let allPages = [];
                        let totalImages = 0;
                        let successfulItems = 0;
                        let failedItems = [];
                        
                        for (let i = 0; i < uniqueDOIs.length; i++) {
                            const currentDOI = uniqueDOIs[i];
                            console.log('ðŸ” Traitement DOI ' + (i + 1) + '/' + uniqueDOIs.length + ': ' + currentDOI);
                            
                            try {
                                const itemApiUrl = 'https://api.nakala.fr/datas/' + currentDOI;
                                
                                let itemResponse;
                                try {
                                    itemResponse = await fetch(itemApiUrl, {
                                        method: 'GET',
                                        headers: {
                                            'Accept': 'application/json',
                                            'Content-Type': 'application/json'
                                        }
                                    });
                                } catch (error) {
                                    const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(itemApiUrl);
                                    itemResponse = await fetch(proxyUrl);
                                    if (itemResponse.ok) {
                                        const proxyData = await itemResponse.json();
                                        itemResponse = { 
                                            ok: true, 
                                            json: () => Promise.resolve(JSON.parse(proxyData.contents))
                                        };
                                    }
                                }
                                
                                if (itemResponse.ok) {
                                    const itemData = await itemResponse.json();
                                    const files = itemData.files || [];
                                    
                                    let imageFiles = files.filter(file => 
                                        file.mimetype && file.mimetype.startsWith('image/')
                                    );
                                    
                                    if (imageFiles.length === 0) {
                                        const imageExtensions = ['.jpg', '.jpeg', '.png', '.tiff', '.tif', '.gif', '.webp'];
                                        imageFiles = files.filter(file => {
                                            const fileName = file.name || file.filename || '';
                                            return imageExtensions.some(ext => 
                                                fileName.toLowerCase().endsWith(ext)
                                            );
                                        });
                                    }
                                    
                                    if (imageFiles.length > 0) {
                                        const itemPages = imageFiles.map((file, fileIndex) => ({
                                            hash: file.sha1 || file.hash,
                                            width: 2692,
                                            height: 3430,
                                            loading: false,
                                            validated: false,
                                            error: null,
                                            dimensionsInput: '',
                                            combinedId: currentDOI + '/' + (file.sha1 || file.hash),
                                            sourceData: (itemData.metadata && itemData.metadata.title) || ('DonnÃ©e ' + (i + 1)),
                                            sourceDoi: currentDOI
                                        }));
                                        
                                        allPages = [...allPages, ...itemPages];
                                        totalImages += imageFiles.length;
                                        successfulItems++;
                                        console.log('âœ… DOI ' + currentDOI + ': ' + imageFiles.length + ' fichier(s) image trouvÃ©(s)');
                                    } else {
                                        console.log('âš ï¸ DOI ' + currentDOI + ': aucun fichier image trouvÃ© (total fichiers: ' + files.length + ')');
                                        failedItems.push(currentDOI + ' (aucun fichier image)');
                                    }
                                } else {
                                    console.log('âŒ DOI ' + currentDOI + ': Erreur ' + itemResponse.status + ' (probablement privÃ©)');
                                    failedItems.push(currentDOI + ' (Erreur ' + itemResponse.status + ' - probablement privÃ©)');
                                }
                                
                                // Pause entre les requÃªtes
                                await new Promise(r => setTimeout(r, 300));
                                
                            } catch (error) {
                                console.error('âŒ Erreur technique pour le DOI ' + currentDOI + ':', error);
                                failedItems.push(currentDOI + ' (Erreur technique: ' + error.message + ')');
                            }
                        }
                        
                        if (allPages.length === 0) {
                            let errorMessage = 'âŒ Aucun fichier image accessible trouvÃ© dans cette collection.\n\n';
                            errorMessage += 'ðŸ“Š RÃ‰SUMÃ‰ :\n';
                            errorMessage += 'â€¢ DOI trouvÃ©s via OAI-PMH: ' + uniqueDOIs.length + '\n';
                            errorMessage += 'â€¢ DOI accessibles: ' + successfulItems + '\n';
                            errorMessage += 'â€¢ DOI inaccessibles: ' + failedItems.length + '\n\n';
                            
                            if (failedItems.length > 0) {
                                errorMessage += 'ðŸ” PROBLÃˆMES DÃ‰TECTÃ‰S :\n';
                                failedItems.slice(0, 5).forEach(failure => {
                                    errorMessage += 'â€¢ ' + failure + '\n';
                                });
                                if (failedItems.length > 5) {
                                    errorMessage += 'â€¢ ... et ' + (failedItems.length - 5) + ' autres\n';
                                }
                                errorMessage += '\n';
                            }
                            
                            errorMessage += 'ðŸ’¡ CAUSE PROBABLE :\n';
                            errorMessage += 'â€¢ Les donnÃ©es de cette collection sont PRIVÃ‰ES\n';
                            errorMessage += 'â€¢ L\'API publique peut voir la collection mais pas accÃ©der aux donnÃ©es\n\n';
                            errorMessage += 'ðŸ› ï¸ SOLUTIONS :\n';
                            errorMessage += 'â€¢ Rendez les donnÃ©es publiques temporairement\n';
                            errorMessage += 'â€¢ Utilisez le mode "donnÃ©e unique" pour chaque lettre';
                            
                            alert(errorMessage);
                            return;
                        }
                        
                        const firstDoi = allPages[0].sourceDoi;
                        
                        setManifestData({
                            ...manifestData,
                            doi: firstDoi,
                            pages: allPages,
                            title: 'Collection OAI-PMH - ' + successfulItems + ' donnÃ©es accessibles',
                            letterId: 'COLLECTION_OAI_' + manifestData.doi.split('/').pop()
                        });
                        
                        let successMessage = 'ðŸŽ¯ SUCCÃˆS avec l\'API OAI-PMH ! ' + totalImages + ' fichiers images trouvÃ©s !\n\n';
                        successMessage += 'ðŸ“Š RÃ‰SUMÃ‰ :\n';
                        successMessage += 'â€¢ DOI extraits via OAI-PMH: ' + uniqueDOIs.length + '\n';
                        successMessage += 'â€¢ DOI accessibles: ' + successfulItems + '\n';
                        successMessage += 'â€¢ Fichiers images: ' + totalImages + '\n';
                        
                        if (failedItems.length > 0) {
                            successMessage += '\nâš ï¸ ' + failedItems.length + ' DOI n\'ont pas pu Ãªtre traitÃ©s:\n';
                            failedItems.slice(0, 3).forEach(failure => {
                                successMessage += 'â€¢ ' + failure.split(' (')[0] + '\n';
                            });
                            if (failedItems.length > 3) {
                                successMessage += 'â€¢ ... et ' + (failedItems.length - 3) + ' autres\n';
                            }
                        }
                        
                        successMessage += '\nðŸŽ¯ Cette mÃ©thode utilise l\'API OAI-PMH officielle de Nakala !';
                        successMessage += '\nLe DOI principal a Ã©tÃ© dÃ©fini sur: ' + firstDoi;
                        successMessage += '\n\nðŸš€ Vous pouvez maintenant rÃ©cupÃ©rer les dimensions automatiquement.';
                        
                        alert(successMessage);
                        
                    } else {
                        console.error('âŒ Erreur HTTP OAI-PMH:', response.status, response.statusText);
                        alert('âŒ Erreur HTTP OAI-PMH ' + response.status + ': ' + response.statusText + '\n\nðŸ” Cela peut indiquer :\nâ€¢ Collection privÃ©e ou inexistante\nâ€¢ DOI de collection invalide\nâ€¢ ProblÃ¨me avec l\'entrepÃ´t OAI-PMH de Nakala');
                        throw new Error('Erreur HTTP OAI-PMH ' + response.status + ': ' + response.statusText);
                    }
                } catch (error) {
                    console.error('âŒ Erreur complÃ¨te OAI-PMH:', error);
                    alert('âŒ Impossible de rÃ©cupÃ©rer les donnÃ©es via OAI-PMH: ' + error.message + '\n\nðŸ” VÃ©rifiez la console pour plus de dÃ©tails.\n\nðŸ’¡ L\'API OAI-PMH est la mÃ©thode officielle documentÃ©e par Nakala.\nSi cela Ã©choue, vÃ©rifiez que :\nâ€¢ La collection est publique\nâ€¢ Le DOI de collection est correct\nâ€¢ Les donnÃ©es de la collection sont publiques');
                }
            };

            const fetchAllDimensionsFromHash = async (pages) => {
                const newPages = [...pages];
                
                newPages.forEach(page => {
                    page.loading = true;
                    page.error = null;
                });
                setManifestData(prev => ({ ...prev, pages: newPages }));
                
                for (let i = 0; i < newPages.length; i++) {
                    const page = newPages[i];
                    
                    if (page.hash && validateHash(page.hash)) {
                        const pageDoi = page.sourceDoi || manifestData.doi;
                        const result = await fetchImageDimensions(pageDoi, page.hash);

                        if (result.success) {
                            newPages[i] = {
                                ...page,
                                width: result.width,
                                height: result.height,
                                loading: false,
                                validated: true,
                                error: null
                            };
                        } else {
                            newPages[i] = {
                                ...page,
                                loading: false,
                                error: result.error || 'Erreur lors de la rÃ©cupÃ©ration'
                            };
                        }

                        setManifestData(prev => ({ ...prev, pages: [...newPages] }));
                        if (i < newPages.length - 1) await new Promise(r => setTimeout(r, 500));
                    } else {
                        newPages[i] = {
                            ...page,
                            loading: false,
                            error: 'Hash invalide'
                        };
                    }
                }
            };

            const fetchAllDimensions = async () => {
                if (!manifestData.doi) {
                    alert('Veuillez d\'abord saisir le DOI');
                    return;
                }
                await fetchAllDimensionsFromHash(manifestData.pages);
            };

            const addPage = () => {
                setManifestData({
                    ...manifestData,
                    pages: [...manifestData.pages, {
                        hash: '',
                        width: 2692,
                        height: 3430,
                        loading: false,
                        validated: false,
                        error: null,
                        dimensionsInput: '',
                        combinedId: ''
                    }]
                });
            };

            const removePage = (index) => {
                if (manifestData.pages.length > 1) {
                    const newPages = manifestData.pages.filter((_, i) => i !== index);
                    setManifestData({ ...manifestData, pages: newPages });
                }
            };

            const updatePage = (index, field, value) => {
                const newPages = [...manifestData.pages];
                newPages[index][field] = value;

                if (field === 'hash') {
                    newPages[index].validated = false;
                    newPages[index].error = null;
                }

                setManifestData({ ...manifestData, pages: newPages });
            };

            const parseDimensions = (input, pageIndex) => {
                if (!input.trim()) return;

                try {
                    const jsonData = JSON.parse(input);
                    if (jsonData.width && jsonData.height) {
                        updatePageDimensions(pageIndex, jsonData.width, jsonData.height);
                        return;
                    }
                } catch (e) {
                    // Si ce n'est pas du JSON, essayer d'autres formats
                }

                const dimensionRegex = /(\d+)[\s,xÃ—](\d+)/;
                const match = input.match(dimensionRegex);
                if (match) {
                    const width = parseInt(match[1]);
                    const height = parseInt(match[2]);
                    updatePageDimensions(pageIndex, width, height);
                    return;
                }

                const numbers = input.match(/\d+/g);
                if (numbers && numbers.length >= 2) {
                    const width = parseInt(numbers[0]);
                    const height = parseInt(numbers[1]);
                    updatePageDimensions(pageIndex, width, height);
                }
            };

            const updatePageDimensions = (pageIndex, width, height) => {
                const newPages = [...manifestData.pages];
                newPages[pageIndex] = {
                    ...newPages[pageIndex],
                    width: width,
                    height: height,
                    validated: true,
                    error: null,
                    dimensionsInput: ''
                };
                setManifestData({ ...manifestData, pages: newPages });
            };

            const generateManifest = () => {
                setIsGenerating(true);

                setTimeout(() => {
                    const manifest = {
                        "@context": "http://iiif.io/api/presentation/2/context.json",
                        "@id": "https://nakala.fr/iiif/" + manifestData.doi + "/manifest",
                        "@type": "sc:Manifest",
                        "label": manifestData.letterId,
                        "attribution": manifestData.attribution,
                        "license": manifestData.license,
                        "logo": "https://nakala.fr/logo/",
                        "metadata": [
                            {
                                "label": "Id",
                                "value": manifestData.letterId
                            },
                            {
                                "label": "Title",
                                "value": manifestData.title
                            },
                            {
                                "label": "Creator",
                                "value": manifestData.creator
                            },
                            {
                                "label": "Date Issued",
                                "value": manifestData.dateIssued
                            },
                            {
                                "label": "Type",
                                "value": "manuscript"
                            }
                        ],
                        "sequences": [
                            {
                                "@id": "https://nakala.fr/iiif/" + manifestData.doi + "/sequence/normal",
                                "@type": "sc:Sequence",
                                "label": manifestData.letterId,
                                "viewingHint": "paged",
                                "startCanvas": "https://nakala.fr/iiif/" + manifestData.doi + "/canvas/page1",
                                "canvases": manifestData.pages.map((page, index) => {
                                    const pageDoi = page.sourceDoi || manifestData.doi;
                                    return {
                                        "@id": "https://nakala.fr/iiif/" + manifestData.doi + "/canvas/page" + (index + 1),
                                        "@type": "sc:Canvas",
                                        "label": "Page " + (index + 1),
                                        "height": page.height,
                                        "width": page.width,
                                        "thumbnail": {
                                            "@id": "https://api.nakala.fr/iiif/" + pageDoi + "/" + page.hash + "/full/,150/0/default.jpg",
                                            "@type": "dctypes:Image"
                                        },
                                        "images": [
                                            {
                                                "@id": "https://nakala.fr/iiif/" + manifestData.doi + "/annotation/page" + (index + 1),
                                                "@type": "oa:Annotation",
                                                "motivation": "sc:painting",
                                                "on": "https://nakala.fr/iiif/" + manifestData.doi + "/canvas/page" + (index + 1),
                                                "resource": {
                                                    "@id": "https://api.nakala.fr/iiif/" + pageDoi + "/" + page.hash + "/full/full/0/default.jpg",
                                                    "@type": "dctypes:Image",
                                                    "format": "image/jpeg",
                                                    "height": page.height,
                                                    "width": page.width,
                                                    "service": {
                                                        "@context": "http://iiif.io/api/image/2/context.json",
                                                        "@id": "https://api.nakala.fr/iiif/" + pageDoi + "/" + page.hash,
                                                        "profile": "http://iiif.io/api/image/2/level2.json"
                                                    }
                                                }
                                            }
                                        ]
                                    };
                                })
                            }
                        ]
                    };

                    const manifestJson = JSON.stringify(manifest, null, 2);
                    
                    const validation = validateIIIFManifest(manifest);
                    
                    setGeneratedManifest(manifestJson);
                    setManifestValidation(validation);
                    setIsGenerating(false);
                }, 500);
            };

            const downloadManifest = () => {
                const blob = new Blob([generatedManifest], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = (manifestData.letterId || 'document') + '.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            const isFormValid = () => {
                return manifestData.doi && validateDoi(manifestData.doi) && manifestData.letterId && manifestData.pages.every(p => p.hash && validateHash(p.hash));
            };

            return React.createElement('div', { className: 'container' },
                React.createElement('button', {
                    onClick: toggleDarkMode,
                    className: 'theme-toggle',
                    title: darkMode ? 'Mode clair' : 'Mode sombre'
                }, darkMode ? 'â˜€ï¸' : 'ðŸŒ™'),

                React.createElement('h1', { className: 'title' }, 'GÃ©nÃ©rateur de Manifests IIIF Nakala V9 - API OAI-PMH'),
                
                React.createElement('div', { className: 'upload-section' },
                    React.createElement('div', { 
                        className: 'drag-drop-zone' + (dragOver ? ' drag-over' : ''),
                        onDragOver: handleDragOver,
                        onDragLeave: handleDragLeave,
                        onDrop: handleDrop,
                        onClick: () => fileInputRef.current?.click()
                    },
                        React.createElement('div', { className: 'upload-content' },
                            React.createElement('input', {
                                type: 'file',
                                accept: '.csv',
                                onChange: handleFileUpload,
                                ref: fileInputRef,
                                style: { display: 'none' }
                            }),
                            React.createElement('h3', { style: { marginBottom: '0.5rem', color: '#374151' } }, 
                                dragOver ? 'DÃ©posez votre fichier CSV ici' : 'Charger le CSV myNKL'
                            ),
                            React.createElement('p', { style: { fontSize: '0.875rem', color: '#6b7280', marginBottom: '1rem' } },
                                'Glissez-dÃ©posez un fichier CSV ou cliquez pour parcourir'
                            ),
                            React.createElement('button', {
                                className: 'btn btn-primary'
                            }, 'ðŸ“ Parcourir les fichiers'),
                            csvData.length > 0 && React.createElement('p', { 
                                className: 'success-message',
                                style: { marginTop: '1rem' }
                            },
                                'âœ… ' + csvData.length + ' lettres chargÃ©es'
                            )
                        )
                    )
                ),

                React.createElement('div', { className: 'form-section' },
                    csvData.length > 0 && React.createElement('div', { className: 'form-group' },
                        React.createElement('label', { className: 'form-label' }, 'SÃ©lectionner une lettre'),
                        React.createElement('select', {
                            value: selectedLetter,
                            onChange: (e) => handleLetterSelect(e.target.value),
                            className: 'form-input'
                        },
                            React.createElement('option', { value: '' }, '-- Choisir une lettre --'),
                            csvData.map((item, index) =>
                                React.createElement('option', { key: index, value: item['Linked in item'] },
                                    item['http://nakala.fr/terms#title']
                                )
                            )
                        )
                    ),

                    React.createElement('h3', { className: 'section-title' }, 'Informations de base'),
                    
                    React.createElement('div', { className: 'form-group' },
                        React.createElement('label', { className: 'form-label' }, 'Coller DOI/hash complet *'),
                        React.createElement('input', {
                            type: 'text',
                            value: combined,
                            onChange: handleCombinedChange,
                            placeholder: '10.34847/nkl.e68ch4qq/cc32f286701e44a3772292ac41356e880e3f3161',
                            className: 'form-input'
                        }),
                        React.createElement('p', { className: 'dimensions-help' },
                            'Collez l\'identifiant complet pour remplir automatiquement le DOI et le hash de la premiÃ¨re page'
                        )
                    ),
                    
                    React.createElement('div', { className: 'form-group' },
                        React.createElement('label', { className: 'form-label' }, 'DOI Nakala (donnÃ©e ou collection)'),
                        React.createElement('div', { className: 'input-wrapper' },
                            React.createElement('input', {
                                type: 'text',
                                value: manifestData.doi,
                                onChange: (e) => setManifestData({...manifestData, doi: e.target.value}),
                                placeholder: '10.34847/nkl.e68ch4qq (donnÃ©e) ou 10.34847/nkl.collectionid (collection)',
                                className: 'form-input' + (
                                    manifestData.doi && !validateDoi(manifestData.doi)
                                        ? ' invalid'
                                        : manifestData.doi && validateDoi(manifestData.doi)
                                        ? ' valid'
                                        : ''
                                )
                            }),
                            manifestData.doi && React.createElement('div', { className: 'input-icons' },
                                validateDoi(manifestData.doi) ?
                                    React.createElement('span', { className: 'icon icon-success' }, 'âœ…') :
                                    React.createElement('span', { className: 'icon icon-error' }, 'âš ï¸')
                            )
                        ),
                        manifestData.doi && !validateDoi(manifestData.doi) &&
                            React.createElement('p', { className: 'error-message' }, 'Format DOI invalide'),
                        React.createElement('p', { className: 'dimensions-help' },
                            'ðŸ’¡ Vous pouvez maintenant utiliser le DOI d\'une donnÃ©e unique OU d\'une collection complÃ¨te'
                        )
                    ),

                    React.createElement('div', { className: 'form-grid' },
                        React.createElement('div', { className: 'form-group' },
                            React.createElement('label', { className: 'form-label' }, 'ID Lettre (automatique)'),
                            React.createElement('input', {
                                type: 'text',
                                value: manifestData.letterId,
                                onChange: (e) => setManifestData({...manifestData, letterId: e.target.value}),
                                placeholder: 'SPA_2469',
                                className: 'form-input'
                            })
                        ),
                        React.createElement('div', { className: 'form-group' },
                            React.createElement('label', { className: 'form-label' }, 'Date'),
                            React.createElement('input', {
                                type: 'date',
                                value: manifestData.dateIssued,
                                onChange: (e) => setManifestData({...manifestData, dateIssued: e.target.value}),
                                className: 'form-input'
                            })
                        )
                    ),

                    React.createElement('div', { className: 'form-group' },
                        React.createElement('label', { className: 'form-label' }, 'Titre'),
                        React.createElement('input', {
                            type: 'text',
                            value: manifestData.title,
                            onChange: (e) => setManifestData({...manifestData, title: e.target.value}),
                            className: 'form-input'
                        })
                    ),

                    React.createElement('div', { className: 'form-group' },
                        React.createElement('label', { className: 'form-label' }, 'CrÃ©ateur'),
                        React.createElement('input', {
                            type: 'text',
                            value: manifestData.creator,
                            onChange: (e) => setManifestData({...manifestData, creator: e.target.value}),
                            className: 'form-input'
                        })
                    ),

                    React.createElement('div', { className: 'pages-header' },
                        React.createElement('h3', { className: 'section-title' }, 'Pages'),
                        React.createElement('div', { className: 'pages-actions' },
                            React.createElement('button', {
                                onClick: addPage,
                                className: 'btn btn-green'
                            }, 'âž•')
                        )
                    ),

                    manifestData.pages.map((page, index) =>
                        React.createElement('div', { key: index, className: 'page-card' },
                            React.createElement('div', { className: 'page-header' },
                                React.createElement('h4', { className: 'page-title' },
                                    'Page ' + (index + 1),
                                    page.loading && React.createElement('div', { className: 'spinner' }),
                                    page.validated && React.createElement('span', null, ' âœ…')
                                ),
                                manifestData.pages.length > 1 &&
                                    React.createElement('button', {
                                        onClick: () => removePage(index),
                                        className: 'btn-red'
                                    }, 'âž–')
                            ),

                            React.createElement('div', { className: 'form-group' },
                                React.createElement('label', { className: 'form-label' }, 'Coller DOI/hash pour cette page *'),
                                React.createElement('input', {
                                    type: 'text',
                                    value: page.combinedId || '',
                                    onChange: (e) => handlePageCombinedChange(index, e.target.value),
                                    placeholder: '10.34847/nkl.e68ch4qq/cc32f286701e44a3772292ac41356e880e3f3161',
                                    className: 'form-input'
                                }),
                                React.createElement('p', { className: 'dimensions-help' },
                                    'Collez l\'identifiant complet pour extraire automatiquement le DOI et le hash'
                                )
                            ),

                            React.createElement('div', { className: 'form-group' },
                                React.createElement('label', { className: 'form-label' }, 'Hash de l\'image (automatique)'),
                                React.createElement('div', { className: 'input-wrapper' },
                                    React.createElement('input', {
                                        type: 'text',
                                        value: page.hash,
                                        onChange: (e) => updatePage(index, 'hash', e.target.value),
                                        placeholder: 'cc32f286701e44a3772292ac41356e880e3f3161',
                                        className: 'form-input' + (
                                            page.hash && !validateHash(page.hash)
                                                ? ' invalid'
                                                : page.hash && validateHash(page.hash)
                                                ? ' valid'
                                                : ''
                                        )
                                    }),
                                    React.createElement('div', { className: 'input-icons' },
                                        page.hash && (
                                            validateHash(page.hash) ?
                                                React.createElement('span', { className: 'icon icon-success' }, 'âœ…') :
                                                React.createElement('span', { className: 'icon icon-error' }, 'âš ï¸')
                                        )
                                    )
                                ),
                                page.error && React.createElement('p', { className: 'error-message' }, page.error),
                                page.hash && !validateHash(page.hash) &&
                                    React.createElement('p', { className: 'error-message' }, 'Format hash invalide (40 caractÃ¨res hexadÃ©cimaux)'),
                                page.hash && validateHash(page.hash) && React.createElement('div', { 
                                    style: { marginTop: '0.5rem', display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }
                                },
                                    React.createElement('button', {
                                        onClick: () => {
                                            const pageDoi = page.sourceDoi || manifestData.doi;
                                            const infoUrl = 'https://api.nakala.fr/iiif/' + pageDoi + '/' + page.hash + '/info.json';
                                            console.log('ðŸ“‹ Ouverture info.json pour:', pageDoi + '/' + page.hash);
                                            window.open(infoUrl, '_blank');
                                        },
                                        className: 'btn btn-primary',
                                        style: { fontSize: '0.75rem', padding: '0.25rem 0.5rem' }
                                    }, 'ðŸ“‹ Ouvrir info.json'),
                                    React.createElement('button', {
                                        onClick: () => {
                                            const pageDoi = page.sourceDoi || manifestData.doi;
                                            const imageUrl = 'https://api.nakala.fr/iiif/' + pageDoi + '/' + page.hash + '/full/full/0/default.jpg';
                                            console.log('ðŸ–¼ï¸ Ouverture image pour:', pageDoi + '/' + page.hash);
                                            window.open(imageUrl, '_blank');
                                        },
                                        className: 'btn btn-success',
                                        style: { fontSize: '0.75rem', padding: '0.25rem 0.5rem' }
                                    }, 'ðŸ–¼ï¸ Voir image'),
                                    page.sourceDoi && React.createElement('span', {
                                        style: { fontSize: '0.7rem', color: '#6b7280', alignSelf: 'center' }
                                    }, 'DOI: ' + page.sourceDoi)
                                )
                            ),

                            React.createElement('div', { className: 'form-group' },
                                React.createElement('label', { className: 'form-label' }, 'Coller les dimensions ici (si la rÃ©cupÃ©ration automatique a Ã©chouÃ©e)'),
                                React.createElement('div', { className: 'dimensions-input' },
                                    React.createElement('input', {
                                        type: 'text',
                                        value: page.dimensionsInput || '',
                                        onChange: (e) => updatePage(index, 'dimensionsInput', e.target.value),
                                        placeholder: 'Ex: {"width":2692,"height":3430} ou 2692x3430',
                                        className: 'form-input'
                                    }),
                                    React.createElement('button', {
                                        onClick: () => parseDimensions(page.dimensionsInput, index),
                                        disabled: !page.dimensionsInput,
                                        className: 'btn btn-primary'
                                    }, 'Appliquer')
                                ),
                                React.createElement('p', { className: 'dimensions-help' },
                                    'Copiez tout ou partie du JSON depuis l\'onglet info.json ouvert, ou saisissez "largeur x hauteur"'
                                )
                            ),

                            React.createElement('div', { className: 'form-grid' },
                                React.createElement('div', { className: 'form-group' },
                                    React.createElement('label', { className: 'form-label' }, 'Largeur'),
                                    React.createElement('input', {
                                        type: 'number',
                                        value: page.width,
                                        onChange: (e) => updatePage(index, 'width', parseInt(e.target.value)),
                                        className: 'form-input'
                                    })
                                ),
                                React.createElement('div', { className: 'form-group' },
                                    React.createElement('label', { className: 'form-label' }, 'Hauteur'),
                                    React.createElement('input', {
                                        type: 'number',
                                        value: page.height,
                                        onChange: (e) => updatePage(index, 'height', parseInt(e.target.value)),
                                        className: 'form-input'
                                    })
                                )
                            )
                        )
                    ),

                    React.createElement('div', { 
                        style: { 
                            marginBottom: '1rem', 
                            display: 'flex', 
                            gap: '0.5rem',
                            flexWrap: 'wrap'
                        } 
                    },
                        React.createElement('button', {
                            onClick: fetchAllHashesFromDOI,
                            disabled: !manifestData.doi || !validateDoi(manifestData.doi),
                            className: 'btn btn-success',
                            style: { 
                                flex: '1',
                                minWidth: '180px',
                                justifyContent: 'center', 
                                padding: '0.75rem 1rem',
                                whiteSpace: 'normal',
                                lineHeight: '1.2'
                            }
                        }, 'ðŸ“„ RÃ©cupÃ©ration automatique depuis UNE donnÃ©e'),
                        React.createElement('button', {
                            onClick: fetchAllHashesFromCollectionOAI,
                            disabled: !manifestData.doi || !validateDoi(manifestData.doi),
                            className: 'btn btn-purple',
                            style: { 
                                flex: '1',
                                minWidth: '180px',
                                justifyContent: 'center', 
                                padding: '0.75rem 1rem',
                                whiteSpace: 'normal',
                                lineHeight: '1.2'
                            }
                        }, 'ðŸŽ¯ API OAI-PMH (COLLECTION) - NOUVELLE !'),
                        React.createElement('button', {
                            onClick: fetchAllDimensions,
                            disabled: !manifestData.doi || !validateDoi(manifestData.doi) || manifestData.pages.some(p => !p.hash || !validateHash(p.hash)),
                            className: 'btn btn-primary',
                            style: { 
                                flex: '1',
                                minWidth: '180px',
                                justifyContent: 'center', 
                                padding: '0.75rem 1rem',
                                whiteSpace: 'normal',
                                lineHeight: '1.2'
                            }
                        }, 'ðŸ“ RÃ©cupÃ©ration automatique des dimensions')
                    ),

                    React.createElement('div', { className: 'generate-section' },
                        React.createElement('button', {
                            onClick: generateManifest,
                            disabled: !isFormValid() || isGenerating,
                            className: 'generate-btn'
                        },
                            isGenerating ?
                                [React.createElement('div', { key: 'spinner', className: 'spinner' }), 'GÃ©nÃ©ration en cours...'] :
                                ['ðŸ“„ GÃ©nÃ©rer le Manifest IIIF']
                        )
                    )
                ),

                generatedManifest && React.createElement('div', { className: 'preview-section' },
                    React.createElement('h3', { className: 'preview-title' }, 'AperÃ§u du Manifest'),
                    
                    manifestValidation && React.createElement('div', { 
                        style: { marginBottom: '1rem', padding: '0.75rem', borderRadius: '0.375rem',
                                backgroundColor: manifestValidation.isValid ? '#f0fdf4' : '#fef2f2',
                                border: '1px solid ' + (manifestValidation.isValid ? '#10b981' : '#ef4444') }
                    },
                        React.createElement('h4', { 
                            style: { color: manifestValidation.isValid ? '#065f46' : '#7f1d1d', marginBottom: '0.5rem' }
                        }, manifestValidation.isValid ? 'âœ… Manifest IIIF valide' : 'âŒ Erreurs dÃ©tectÃ©es'),
                        
                        manifestValidation.errors.length > 0 && React.createElement('div', null,
                            React.createElement('strong', { style: { color: '#ef4444' } }, 'Erreurs:'),
                            React.createElement('ul', { style: { margin: '0.25rem 0', paddingLeft: '1.5rem' } },
                                manifestValidation.errors.map((error, index) =>
                                    React.createElement('li', { key: index, style: { color: '#7f1d1d' } }, error)
                                )
                            )
                        ),
                        
                        manifestValidation.warnings.length > 0 && React.createElement('div', null,
                            React.createElement('strong', { style: { color: '#f59e0b' } }, 'Avertissements:'),
                            React.createElement('ul', { style: { margin: '0.25rem 0', paddingLeft: '1.5rem' } },
                                manifestValidation.warnings.map((warning, index) =>
                                    React.createElement('li', { key: index, style: { color: '#92400e' } }, warning)
                                )
                            )
                        )
                    ),
                    
                    React.createElement('div', { className: 'preview-content' },
                        React.createElement('pre', { className: 'preview-json' }, generatedManifest)
                    ),
                    React.createElement('button', {
                        onClick: downloadManifest,
                        className: 'download-btn'
                    }, 'ðŸ’¾ TÃ©lÃ©charger le Manifest')
                )
            );
        };

        ReactDOM.render(React.createElement(IIIFManifestGenerator), document.getElementById('root'));
    </script>
</body>
</html>